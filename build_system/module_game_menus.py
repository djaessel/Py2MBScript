from header_game_menus import *
from header_parties import *
from header_items import *
from header_mission_templates import *
from header_music import *
from header_terrain_types import *

from module_constants import *

game_menus = [

("start_game_0", 18374686479671624192, 
  "Welcome, adventurer, to Mount and Blade: Warband. Before beginning the game you must create your character. Remember that in the traditional medieval society depicted in the game, war and politics are usually dominated by male members of the nobility. That does not however mean that you should not choose to play a female character, or one who is not of noble birth. Male nobles may have a somewhat easier start, but women and commoners can attain all of the same goals -- and in fact may have a much more interesting if more challenging early game.", 
  "none", [
],
[
]),
("start_phase_2", 512, 
  "You hear about Calradia, a land torn between rival kingdoms battling each other for supremacy, a haven for knights and mercenaries,  cutthroats and adventurers, all willing to risk their lives in pursuit of fortune, power, or glory... In this land which holds great dangers and even greater opportunities, you believe you may leave your past behind and start a new life. You feel that finally, you hold the key of your destiny in your hands, free to choose as you will, and that whatever course you take, great adventures will await you. Drawn by the stories you hear about Calradia and its kingdoms, you...", 
  "none", [
],
[
]),
("start_game_3", 512, 
  "Choose your scenario:", 
  "none", [
(assign,"$g_custom_battle_scenario",0),
(assign,"$g_custom_battle_scenario","$g_custom_battle_scenario"),
],
[
]),
("tutorial", 512, 
  "You approach a field where the locals are training with weapons. You can practice here to improve your combat skills.", 
  "none", [
(try_begin),
    (eq,":::g_tutorial_entered",1),
    (change_screen_quit),
(else_try),
    (set_passage_menu,"mnu_tutorial"),
    (assign,"$g_tutorial_entered",1),
(try_end),
],
[
]),
("reports", 0, 
  "Character Renown: {reg5}^Honor Rating: {reg6}^Party Morale: {reg8}^Party Size Limit: {reg7}^", 
  "none", [
(call_script, "script_game_get_party_companion_limit"),
(assign,":var001",reg0),
(troop_get_slot,":troop_slot_002","trp_player",7),
(assign,reg5,":troop_slot_002"),
(assign,reg6,"$player_honor"),
(assign,reg7,":var001"),
(party_get_morale, reg8,"p_main_party"),
],
[
]),
("custom_battle_scene", 18374686479671624192, 
  "(NO TRANS)", 
  "none", [
],
[
]),
("custom_battle_end", 512, 
  "The battle is over. {s1} Your side killed {reg5} enemies and lost {reg6} troops over the battle. You personally slew {reg7} men in the fighting.", 
  "none", [
(music_set_situation, 0),
(assign,reg5,"$g_custom_battle_team2_death_count"),
(assign,reg6,"$g_custom_battle_team1_death_count"),
(get_player_agent_kill_count,":agent_kill_count_001",":"),
(get_player_agent_kill_count,":agent_kill_count_002",1),
(store_add, reg7, ":agent_kill_count_001", ":agent_kill_count_002"),
(try_begin),
    (eq,":::g_battle_result",1),
    (str_store_string,s1,"str_battle_won"),
(else_try),
    (str_store_string,s1,"str_battle_lost"),
(try_end),
(try_begin),
    (ge,":::g_custom_battle_team2_death_count",100),
    (unlock_achievement, 4),
(try_end),
],
[
]),
("start_game_1", 18374686479671624192, 
  "Select your character's gender.", 
  "none", [
],
[
]),
("start_character_1", 512, 
  "You were born years ago, in a land far away. Your father was...", 
  "none", [
(str_clear, 10),
(str_clear, 11),
(str_clear, 12),
(str_clear, 13),
(str_clear, 14),
(str_clear, 15),
],
[
]),
("start_character_2", 0, 
  "{s10}^^ You started to learn about the world almost as soon as you could walk and talk. You spent your early life as...", 
  "none", [
],
[
]),
("start_character_3", 512, 
  "{s11}^^ Then, as a young adult, life changed as it always does. You became...", 
  "none", [
(assign,reg3,"$character_gender"),
],
[
]),
("start_character_4", 512, 
  "{s12}^^But soon everything changed and you decided to strike out on your own as an adventurer. What made you take this decision was...", 
  "none", [
],
[
]),
("choose_skill", 512, 
  "{s13}", 
  "none", [
(assign,"$current_string_reg",10),
(assign,":var001",0),
(try_begin),
    (eq,":::character_gender",1),
    (str_store_string,s14,"str_woman"),
    (val_add, ":var001", 1),
(else_try),
    (str_store_string,s14,"str_man"),
(try_end),
(try_begin),
    (eq,":::background_type",1),
    (str_store_string,s15,"str_noble"),
    (val_sub, ":var001", 1),
(else_try),
    (str_store_string,s15,"str_common"),
(try_end),
(try_begin),
    (eq,":var001",-1),
    (str_store_string,s16,"str_may_find_that_you_are_able_to_take_your_place_among_calradias_great_lords_relatively_quickly"),
(else_try),
    (eq,":var001",0),
    (str_store_string,s16,"str_may_face_some_difficulties_establishing_yourself_as_an_equal_among_calradias_great_lords"),
(else_try),
    (eq,":var001",1),
    (str_store_string,s16,"str_may_face_great_difficulties_establishing_yourself_as_an_equal_among_calradias_great_lords"),
(try_end),
],
[
]),
("past_life_explanation", 512, 
  "{s3}", 
  "none", [
(try_begin),
    (gt,":::current_string_reg",14),
    (assign,"$current_string_reg",10),
(try_end),
(str_store_string_reg,s3,"$current_string_reg"),
(try_begin),
    (ge,":::current_string_reg",14),
    (str_store_string,s5,":"),
(else_try),
    (str_store_string,s5,":"),
(try_end),
],
[
]),
("auto_return", 0, 
  "{!}This menu automatically returns to caller.", 
  "none", [
(change_screen_return),
],
[
]),
("morale_report", 0, 
  "{s1}", 
  "none", [
(call_script, "script_get_player_party_morale_values"),
(assign,":var001",reg0),
(assign,reg1,"$g_player_party_morale_modifier_party_size"),
(try_begin),
    (gt,reg1,0),
    (str_store_string,s2,"@{!} -"),
(else_try),
    (str_store_string,s2,"str_space"),
(try_end),
(assign,reg2,"$g_player_party_morale_modifier_leadership"),
(try_begin),
    (gt,reg2,0),
    (str_store_string,s3,"@{!} +"),
(else_try),
    (str_store_string,s3,"str_space"),
(try_end),
(try_begin),
    (gt,":::g_player_party_morale_modifier_no_food",0),
    (assign,reg7,"$g_player_party_morale_modifier_no_food"),
    (str_store_string,s5,"@^No food:  -{reg7}"),
(else_try),
    (str_store_string,s5,"str_space"),
(try_end),
(assign,reg3,"$g_player_party_morale_modifier_food"),
(try_begin),
    (gt,reg3,0),
    (str_store_string,s4,"@{!} +"),
(else_try),
    (str_store_string,s4,"str_space"),
(try_end),
(try_begin),
    (gt,":::g_player_party_morale_modifier_debt",0),
    (assign,reg6,"$g_player_party_morale_modifier_debt"),
    (str_store_string,s6,"@^Wage debt:  -{reg6}"),
(else_try),
    (str_store_string,s6,"str_space"),
(try_end),
(party_get_morale, reg5,"p_main_party"),
(store_sub, reg4, reg5, ":var001"),
(try_begin),
    (gt,reg4,0),
    (str_store_string,s7,"@{!} +"),
(else_try),
    (str_store_string,s7,"str_space"),
(try_end),
(assign,reg6,50),
(str_store_string,s1,"str_current_party_morale_is_reg5_current_party_morale_modifiers_are__base_morale__50_party_size_s2reg1_leadership_s3reg2_food_variety_s4reg3s5s6_recent_events_s7reg4_total__reg5___"),
(try_for_range, ":fac_002", ":fac.kingdom_1", ":fac.kingdoms_end"),
    (faction_get_slot,":faction_slot_003",":fac_002",99),
    (val_div, ":faction_slot_003", 100),
    (try_begin),
        (neq,":faction_slot_003",0),
        (assign,reg6,":faction_slot_003"),
        (str_store_faction_name,s9,":fac_002"),
        (str_store_string,s1,"str_s1extra_morale_for_s9_troops__reg6_"),
    (try_end),
(try_end),
],
[
]),
("courtship_relations", 0, 
  "{s1}", 
  "none", [
(str_store_string,s1,"str_courtships_in_progress_"),
(try_for_range, ":trp_001", ":trp.knight_1_1_wife", ":trp.heroes_end"),
    (try_begin),
        (troop_slot_eq,":trp_001",5,2),
        (call_script, "script_troop_get_relation_with_troop", "trp_player", ":trp_001"),
        (try_begin),
            (gt,reg0,0),
            (assign,reg3,reg0),
            (str_store_troop_name,s2,":trp_001"),
            (store_current_hours,":cur_hours_002"),
            (troop_get_slot,":troop_slot_003",":trp_001",4),
            (val_sub, ":cur_hours_002", ":troop_slot_003"),
            (store_div, ":var___x1", ":cur_hours_002", 24),
            (assign,":var004",":var___x1"),
            (assign,reg4,":var004"),
            (str_store_string,s1,"str_s1_s2_relation_reg3_last_visit_reg4_days_ago"),
        (try_end),
    (try_end),
(try_end),
(str_store_string,s1,"str_s1__poems_known"),
(try_begin),
    (gt,":::allegoric_poem_recitations",0),
    (str_store_string,s1,"str_s1_storming_the_castle_of_love_allegoric"),
(try_end),
(try_begin),
    (gt,":::tragic_poem_recitations",0),
    (str_store_string,s1,"str_s1_kais_and_layali_tragic"),
(try_end),
(try_begin),
    (gt,":::comic_poem_recitations",0),
    (str_store_string,s1,"str_s1_a_conversation_in_the_garden_comic"),
(try_end),
(try_begin),
    (gt,":::heroic_poem_recitations",0),
    (str_store_string,s1,"str_s1_helgered_and_kara_epic"),
(try_end),
(try_begin),
    (gt,":::mystic_poem_recitations",0),
    (str_store_string,s1,"str_s1_a_hearts_desire_mystic"),
(try_end),
],
[
]),
("lord_relations", 0, 
  "{s1}", 
  "none", [
(try_for_range, ":trp_001", ":trp.npc1", ":trp.knight_1_1_wife"),
    (troop_set_slot,":trp_001",46,0),
(try_end),
(str_clear, 1),
(try_for_range, ":trp_002", ":trp.npc1", ":trp.knight_1_1_wife"),
    (assign,":var003",-100),
    (assign,":troop_id_004",-1),
    (try_for_range, ":trp_001", ":trp.npc1", ":trp.knight_1_1_wife"),
        (try_begin),
            (troop_slot_eq,":trp_001",46,0),
            (troop_slot_eq,":trp_001",2,2),
            (troop_slot_ge,":trp_001",5,1),
            (call_script, "script_troop_get_player_relation", ":trp_001"),
            (assign,":var005",reg0),
            (try_begin),
                (ge,":var005",":var003"),
                (assign,":var003",":var005"),
                (assign,":troop_id_004",":trp_001"),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (gt,":troop_id_004",-1),
        (str_store_troop_name_link,s4,":troop_id_004"),
        (assign,reg4,":var003"),
        (str_store_string,s1,"@{!}{s1}^{s4}: {reg4}"),
        (troop_set_slot,":troop_id_004",46,1),
    (try_end),
(try_end),
],
[
]),
("companion_report", 0, 
  "{s7}{s1}", 
  "none", [
(str_clear, 1),
(str_store_string,s7,"str_no_companions_in_service"),
(try_begin),
    (eq,1,1),
    (troop_get_slot,":troop_slot_001","trp_player",30),
    (try_begin),
        (eq,1,1),
        (troop_get_type,":troop_type_002","trp_player"),
        (try_begin),
            (eq,":troop_type_002",1),
            (str_store_string,s8,"str_husband"),
        (else_try),
            (str_store_string,s8,"str_wife"),
        (try_end),
    (try_end),
    (try_begin),
        (le,":troop_slot_001",0),
        (troop_get_slot,":troop_slot_001","trp_player",34),
        (str_store_string,s8,"str_betrothed"),
    (try_end),
    (try_begin),
        (gt,":troop_slot_001",0),
        (str_store_troop_name,s4,":troop_slot_001"),
        (troop_get_slot,":troop_slot_003",":troop_slot_001",12),
        (try_begin),
            (is_between,":troop_slot_003","p_town_1","p_salt_mine"),
            (str_store_party_name,s5,":troop_slot_003"),
        (else_try),
            (troop_slot_eq,":troop_slot_001",2,2),
            (str_store_string,s5,"str_leading_party"),
        (else_try),
            (str_store_string,s5,"str_whereabouts_unknown"),
        (try_end),
    (try_end),
    (str_store_string,s3,"str_s4_s8_s5"),
    (str_store_string,s2,1),
    (str_store_string,s1,"str_s2_s3"),
(try_end),
(try_begin),
    (ge,":::cheat_mode",1),
    (ge,":::npc_to_rejoin_party",0),
    (str_store_troop_name,s5,"$npc_to_rejoin_party"),
    (str_store_string,s1,"@{!}DEBUG -- {s1}^NPC in rejoin queue: {s5}^"),
(try_end),
(try_for_range, ":trp_004", ":trp.npc1", ":trp.kingdom_1_lord"),
    (str_clear, 2),
    (str_clear, 3),
    (try_begin),
        (eq,1,1),
        (troop_get_slot,":troop_slot_005",":trp_004",150),
        (try_begin),
            (troop_slot_eq,":trp_004",2,5),
            (str_store_troop_name,s4,":trp_004"),
            (try_begin),
                (troop_slot_eq,":trp_004",151,1),
                (str_store_string,s8,"str_gathering_support"),
                (try_begin),
                    (eq,":troop_slot_005",1),
                    (str_store_string,s5,"str_expected_back_imminently"),
                (else_try),
                    (assign,reg3,":troop_slot_005"),
                    (str_store_string,s5,"str_expected_back_in_approximately_reg3_days"),
                (try_end),
            (try_end),
        (else_try),
            (troop_slot_eq,":trp_004",151,2),
            (troop_get_slot,":troop_slot_006",":trp_004",67),
            (str_store_party_name,s11,":troop_slot_006"),
            (str_store_string,s8,"str_gathering_intelligence"),
            (try_begin),
                (eq,":troop_slot_005",1),
                (str_store_string,s5,"str_expected_back_imminently"),
            (else_try),
                (assign,reg3,":troop_slot_005"),
                (str_store_string,s5,"str_expected_back_in_approximately_reg3_days"),
            (try_end),
        (else_try),
            (troop_slot_ge,":trp_004",151,3),
            (neg|troop_slot_ge,":trp_004",151,8),
            (troop_get_slot,":troop_slot_007",":trp_004",152),
            (str_store_faction_name,s9,":troop_slot_007"),
            (str_store_string,s8,"str_diplomatic_embassy_to_s9"),
            (try_begin),
                (eq,":troop_slot_005",1),
                (str_store_string,s5,"str_expected_back_imminently"),
            (else_try),
                (assign,reg3,":troop_slot_005"),
                (str_store_string,s5,"str_expected_back_in_approximately_reg3_days"),
            (try_end),
        (else_try),
            (eq,":trp_004",":::g_player_minister"),
            (str_store_string,s8,"str_serving_as_minister"),
            (try_begin),
                (is_between,"$g_player_court","p_town_1","p_salt_mine"),
                (str_store_party_name,s9,"$g_player_court"),
                (str_store_string,s5,"str_in_your_court_at_s9"),
            (else_try),
                (str_store_string,s5,"str_whereabouts_unknown"),
            (try_end),
        (else_try),
            (main_party_has_troop,":trp_004"),
            (str_store_string,s8,"str_under_arms"),
            (str_store_string,s5,"str_in_your_party"),
        (else_try),
            (troop_slot_eq,":trp_004",151,8),
            (str_store_string,s8,"str_attempting_to_rejoin_party"),
            (str_store_string,s5,"str_whereabouts_unknown"),
        (else_try),
            (troop_slot_ge,":trp_004",12,1),
            (str_store_string,s8,"str_separated_from_party"),
            (str_store_string,s5,"str_whereabouts_unknown"),
        (else_try),
            (try_begin),
                (check_quest_active,"qst_lend_companion"),
                (quest_slot_eq,"qst_lend_companion",2,":trp_004"),
                (str_store_string,s8,"@On loan,"),
            (else_try),
                (check_quest_active,"qst_lend_surgeon"),
                (quest_slot_eq,"qst_lend_surgeon",2,":trp_004"),
                (str_store_string,s8,"@On loan,"),
            (else_try),
                (troop_set_slot,":trp_004",151,8),
                (str_store_string,s8,"str_attempting_to_rejoin_party"),
            (try_end),
            (str_store_string,s5,"str_whereabouts_unknown"),
            (try_begin),
                (ge,":::cheat_mode",1),
                (troop_get_slot,reg2,":trp_004",151),
                (troop_get_slot,reg3,":trp_004",150),
                (troop_get_slot,reg4,":trp_004",8),
                (troop_get_slot,reg4,":trp_004",82),
                (display_message, "@@{!}DEBUG: {s4} current mission: {reg2};;; days on mission: {reg3};;; prisoner: {reg4};;; pphistory: {reg5}"),
            (try_end),
        (try_end),
        (str_store_string,s3,"str_s4_s8_s5"),
        (str_store_string,s2,1),
        (str_store_string,s1,"str_s2_s3"),
        (str_clear, 7),
    (else_try),
        (neg|troop_slot_eq,":trp_004",2,2),
        (troop_slot_ge,":trp_004",8,"p_town_1"),
        (str_store_troop_name,s4,":trp_004"),
        (str_store_string,s8,"str_missing_after_battle"),
        (str_store_string,s5,"str_whereabouts_unknown"),
        (str_store_string,s3,"str_s4_s8_s5"),
        (str_store_string,s2,1),
        (str_store_string,s1,"str_s2_s3"),
        (str_clear, 7),
    (try_end),
(try_end),
],
[
]),
("faction_orders", 0, 
  "{!}{s9}", 
  "none", [
(str_clear, 9),
(store_current_hours,":cur_hours_001"),
(try_for_range, ":fac_002", ":fac.player_supporters_faction", ":fac.kingdoms_end"),
    (try_begin),
        (faction_slot_eq,":fac_002",21,0),
        (neq,":fac_002","fac_player_supporters_faction"),
        (faction_get_slot,":faction_slot_003",":fac_002",4),
        (try_begin),
            (eq,1,1),
            (faction_get_slot,":faction_slot_004",":fac_002",8),
            (try_begin),
                (gt,":faction_slot_004",-1),
                (assign,":faction_slot_005",":faction_slot_004"),
            (else_try),
                (faction_get_slot,":faction_slot_005",":fac_002",11),
            (try_end),
        (try_end),
    (try_end),
    (call_script, "script_npc_decision_checklist_faction_ai_alt", ":faction_slot_005"),
    (assign,":var006",reg0),
    (str_store_string,s26,14),
    (faction_get_slot,":faction_slot_007",":fac_002",4),
    (faction_get_slot,":faction_slot_008",":fac_002",5),
    (faction_get_slot,":faction_slot_009",":fac_002",8),
    (faction_get_slot,":faction_slot_010",":fac_002",9),
    (str_store_faction_name,s10,":fac_002"),
    (try_begin),
        (eq,1,1),
        (faction_get_slot,":faction_slot_011",":fac_002",64),
        (try_begin),
            (eq,":faction_slot_011",1),
            (str_store_string,s11,"@Appoint next marshal"),
        (else_try),
            (is_between,":faction_slot_011","p_town_1","p_salt_mine"),
            (str_store_party_name,s12,":faction_slot_011"),
            (str_store_string,s11,"@Award {s12} as fief"),
        (else_try),
            (eq,":faction_slot_011",0),
            (str_store_string,s11,"@None"),
        (else_try),
            (assign,reg3,":faction_slot_011"),
            (str_store_string,s11,"@{!}Error ({reg3})"),
        (try_end),
        (store_current_hours,reg4),
        (faction_get_slot,":faction_slot_012",":fac_002",65),
        (val_sub, reg4, ":faction_slot_012"),
        (str_store_string,s10,"@{!}{s10}^Faction political issue: {s11}"),
        (try_begin),
            (faction_slot_ge,":fac_002",64,1),
            (str_store_string,s10,"@{!}{s10} (on agenda {reg4} hours)"),
        (try_end),
    (try_end),
    (assign,reg2,":faction_slot_010"),
    (try_begin),
        (eq,":faction_slot_007",0),
        (str_store_string,s11,"@{!}Defending"),
    (else_try),
        (eq,":faction_slot_007",1),
        (str_store_string,s11,"@{!}Gathering army"),
    (else_try),
        (eq,":faction_slot_007",2),
        (str_store_party_name,s11,":faction_slot_008"),
        (str_store_string,s11,"@{!}Besieging {s11}"),
    (else_try),
        (eq,":faction_slot_007",3),
        (str_store_party_name,s11,":faction_slot_008"),
        (str_store_string,s11,"@{!}Raiding {s11}"),
    (else_try),
        (eq,":faction_slot_007",4),
        (str_store_party_name,s11,":faction_slot_008"),
        (str_store_string,s11,"str_attacking_enemy_army_near_s11"),
    (else_try),
        (eq,":faction_slot_007",6),
        (str_store_party_name,s11,":faction_slot_008"),
        (str_store_string,s11,"str_holding_feast_at_s11"),
    (else_try),
        (eq,":faction_slot_007",5),
        (str_store_party_name,s11,":faction_slot_008"),
        (str_store_string,s11,"@{!}Attacking enemies around {s11}"),
    (else_try),
        (assign,reg4,":faction_slot_007"),
        (str_store_string,s11,"str_sfai_reg4"),
    (try_end),
    (try_begin),
        (lt,":faction_slot_009",0),
        (str_store_string,s12,"@No one"),
    (else_try),
        (str_store_troop_name,s12,":faction_slot_009"),
        (troop_get_slot,reg21,":faction_slot_009",150),
        (str_store_string,s12,"@{!}{s12} (controversy: {reg21})"),
    (try_end),
    (try_for_parties, ":cur_party"),
        (try_begin),
            (party_slot_eq,":cur_party",4,12),
            (store_faction_of_party, ":party_faction_014", ":cur_party"),
            (try_begin),
                (eq,":party_faction_014",":fac_002"),
                (str_store_party_name,s38,":cur_party"),
                (str_store_string,s12,"@{!}{s12}^Screening party: {s38}"),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (this_or_next|eq,":var006",6),
        (eq,":var006",0),
        (store_current_hours,":cur_hours_015"),
        (faction_get_slot,":faction_slot_016",":fac_002",97),
        (val_sub, ":cur_hours_015", ":faction_slot_016"),
        (try_begin),
            (ge,":cur_hours_015",18),
            (store_current_hours,":cur_hours_017"),
            (faction_set_slot,":fac_002",96,":cur_hours_017"),
        (try_end),
    (try_end),
    (try_begin),
        (neq,":var006",":faction_slot_003"),
        (store_current_hours,":cur_hours_017"),
        (faction_set_slot,":fac_002",97,":cur_hours_017"),
    (try_end),
    (call_script, "script_evaluate_realm_stability", ":fac_002"),
    (assign,":var018",reg0),
    (assign,":var019",reg1),
    (faction_get_slot,":faction_slot_020",":fac_002",94),
    (store_sub, ":var021", ":cur_hours_001", ":faction_slot_020"),
    (val_sub, ":var021", 72),
    (faction_get_slot,":faction_slot_016",":fac_002",97),
    (store_sub, ":cur_hours_015", ":cur_hours_001", ":faction_slot_016"),
    (faction_get_slot,":faction_slot_022",":fac_002",95),
    (store_sub, ":var023", ":cur_hours_001", ":faction_slot_022"),
    (faction_get_slot,":faction_slot_024",":fac_002",96),
    (store_sub, ":var025", ":cur_hours_001", ":faction_slot_024"),
    (faction_get_slot,":faction_slot_026",":fac_002",98),
    (store_sub, ":var027", ":cur_hours_001", ":faction_slot_026"),
    (assign,reg3,":cur_hours_015"),
    (assign,reg4,":var023"),
    (assign,reg5,":var021"),
    (assign,reg7,":var018"),
    (assign,reg8,":var019"),
    (assign,reg9,":var025"),
    (assign,reg10,":var027"),
    (str_store_string,s14,26),
    (str_store_string,s9,"str_s9s10_current_state_s11_hours_at_current_state_reg3_current_strategic_thinking_s14_marshall_s12_since_the_last_offensive_ended_reg4_hours_since_the_decisive_event_reg10_hours_since_the_last_rest_reg9_hours_since_the_last_feast_ended_reg5_hours_percent_disgruntled_lords_reg7_percent_restless_lords_reg8__"),
(try_end),
(try_begin),
    (neg|is_between,"$g_cheat_selected_faction","fac_player_supporters_faction","fac_kingdoms_end"),
    (call_script, "script_get_next_active_kingdom", "fac_kingdoms_end"),
    (assign,"$g_cheat_selected_faction",reg0),
(try_end),
(str_store_faction_name,s10,"$g_cheat_selected_faction"),
(str_store_string,s9,"@Selected faction is: {s10}^^{s9}"),
],
[
]),
("character_report", 0, 
  "{s9}", 
  "none", [
(try_begin),
    (gt,":::g_player_reading_book",0),
    (player_has_item,"$g_player_reading_book"),
    (str_store_item_name,s8,"$g_player_reading_book"),
    (str_store_string,s9,":"),
(else_try),
    (assign,"$g_player_reading_book",0),
    (str_store_string,s9,":"),
(try_end),
(assign,":var001",0),
(assign,":var002",0),
(str_store_string,s6,"@none"),
(str_store_string,s8,"@none"),
(try_for_range, ":trp_003", ":trp.npc1", ":trp.knight_1_1_wife"),
    (try_begin),
        (this_or_next|troop_slot_eq,":trp_003",2,2),
        (troop_slot_eq,":trp_003",2,9),
        (call_script, "script_troop_get_player_relation", ":trp_003"),
        (assign,":var004",reg0),
        (try_begin),
            (gt,":var004",20),
            (try_begin),
                (eq,":var001",0),
                (str_store_troop_name,s8,":trp_003"),
            (else_try),
                (eq,":var001",1),
                (str_store_troop_name,s7,":trp_003"),
                (str_store_string,s8,"@{s7} and {s8}"),
            (else_try),
                (str_store_troop_name,s7,":trp_003"),
                (str_store_string,s8,"@{!}{s7}, {s8}"),
            (try_end),
        (try_end),
        (val_add, ":var001", 1),
    (else_try),
        (lt,":var004",-20),
        (try_begin),
            (eq,":var002",0),
            (str_store_troop_name,s6,":trp_003"),
        (else_try),
            (eq,":var002",1),
            (str_store_troop_name,s5,":trp_003"),
            (str_store_string,s6,"@{s5} and {s6}"),
        (else_try),
            (str_store_troop_name,s5,":trp_003"),
            (str_store_string,s6,"@{!}{s5}, {s6}"),
        (try_end),
        (val_add, ":var002", 1),
    (try_end),
(try_end),
(str_clear, 12),
(try_begin),
    (gt,":::player_right_to_rule",0),
    (assign,reg12,"$player_right_to_rule"),
    (str_store_string,s12,"str__right_to_rule_reg12"),
(try_end),
(str_clear, 15),
(try_begin),
    (this_or_next|gt,":::claim_arguments_made",0),
    (this_or_next|gt,":::ruler_arguments_made",0),
    (this_or_next|gt,":::victory_arguments_made",0),
    (this_or_next|gt,":::lords_arguments_made",0),
    (eq,1,0),
    (assign,reg3,"$claim_arguments_made"),
    (assign,reg4,"$ruler_arguments_made"),
    (assign,reg5,"$victory_arguments_made"),
    (assign,reg6,"$lords_arguments_made"),
    (assign,reg7,"$benefit_arguments_made"),
    (str_store_string,s15,"str_political_arguments_made_legality_reg3_rights_of_lords_reg4_unificationpeace_reg5_rights_of_commons_reg6_fief_pledges_reg7"),
(try_end),
(assign,reg3,"$player_honor"),
(troop_get_slot,reg2,"trp_player",7),
(str_store_string,s9,"str_renown_reg2_honour_rating_reg3s12_friends_s8_enemies_s6_s9"),
(call_script, "script_get_number_of_hero_centers", "trp_player"),
(assign,":var005",reg0),
(try_begin),
    (gt,":var005",0),
    (try_for_range, ":var006", 0, ":var005"),
        (call_script, "script_troop_get_leaded_center_with_index", "trp_player", ":var006"),
        (assign,":var007",reg0),
        (try_begin),
            (eq,":var006",0),
            (str_store_party_name,s8,":var007"),
        (else_try),
            (eq,":var006",1),
            (str_store_party_name,s7,":var007"),
            (str_store_string,s8,"@{s7} and {s8}"),
        (else_try),
            (str_store_party_name,s7,":var007"),
            (str_store_string,s8,"@{!}{s7}, {s8}"),
        (try_end),
    (try_end),
    (str_store_string,s9,":"),
(try_end),
(try_begin),
    (gt,":::players_kingdom",0),
    (str_store_faction_name,s8,"$players_kingdom"),
    (try_begin),
        (this_or_next|is_between,"$players_kingdom","fac_kingdom_1","fac_kingdoms_end"),
        (neg|faction_slot_eq,"fac_player_supporters_faction",11,"trp_player"),
        (str_store_string,s9,"str_you_are_a_lord_lady_of_s8_s9"),
    (else_try),
        (str_store_string,s9,"str_you_are_king_queen_of_s8_s9"),
    (try_end),
(try_end),
],
[
]),
("party_size_report", 0, 
  "{s1}", 
  "none", [
(call_script, "script_game_get_party_companion_limit"),
(assign,":var001",reg0),
(store_skill_level,":skill_lvl_002","skl_leadership","trp_player"),
(val_mul, ":skill_lvl_002", 5),
(store_attribute_level,":attribute_lvl_003","trp_player",3),
(troop_get_slot,":troop_slot_004","trp_player",7),
(val_div, ":troop_slot_004", 25),
(try_begin),
    (gt,":skill_lvl_002",0),
    (str_store_string,s2,"@{!} +"),
(else_try),
    (str_store_string,s2,"str_space"),
(try_end),
(try_begin),
    (gt,":attribute_lvl_003",0),
    (str_store_string,s3,"@{!} +"),
(else_try),
    (str_store_string,s3,"str_space"),
(try_end),
(try_begin),
    (gt,":troop_slot_004",0),
    (str_store_string,s4,"@{!} +"),
(else_try),
    (str_store_string,s4,"str_space"),
(try_end),
(assign,reg5,":var001"),
(assign,reg1,":skill_lvl_002"),
(assign,reg2,":attribute_lvl_003"),
(assign,reg3,":troop_slot_004"),
(str_store_string,s1,":"),
],
[
]),
("faction_relations_report", 0, 
  "{s1}", 
  "none", [
(str_clear, 2),
(try_for_range, ":fac_001", ":fac.player_supporters_faction", ":fac.kingdoms_end"),
    (try_begin),
        (faction_slot_eq,":fac_001",21,0),
        (neq,":fac_001","fac_player_supporters_faction"),
        (store_relation,":faction_relation_002","fac_player_supporters_faction",":fac_001"),
        (try_begin),
            (ge,":faction_relation_002",90),
            (str_store_string,s3,"@Loyal"),
        (else_try),
            (ge,":faction_relation_002",80),
            (str_store_string,s3,"@Devoted"),
        (else_try),
            (ge,":faction_relation_002",70),
            (str_store_string,s3,"@Fond"),
        (else_try),
            (ge,":faction_relation_002",60),
            (str_store_string,s3,"@Gracious"),
        (else_try),
            (ge,":faction_relation_002",50),
            (str_store_string,s3,"@Friendly"),
        (else_try),
            (ge,":faction_relation_002",40),
            (str_store_string,s3,"@Supportive"),
        (else_try),
            (ge,":faction_relation_002",30),
            (str_store_string,s3,"@Favorable"),
        (else_try),
            (ge,":faction_relation_002",20),
            (str_store_string,s3,"@Cooperative"),
        (else_try),
            (ge,":faction_relation_002",10),
            (str_store_string,s3,"@Accepting"),
        (else_try),
            (ge,":faction_relation_002",0),
            (str_store_string,s3,"@Indifferent"),
        (else_try),
            (ge,":faction_relation_002",-10),
            (str_store_string,s3,"@Suspicious"),
        (else_try),
            (ge,":faction_relation_002",-20),
            (str_store_string,s3,"@Grumbling"),
        (else_try),
            (ge,":faction_relation_002",-30),
            (str_store_string,s3,"@Hostile"),
        (else_try),
            (ge,":faction_relation_002",-40),
            (str_store_string,s3,"@Resentful"),
        (else_try),
            (ge,":faction_relation_002",-50),
            (str_store_string,s3,"@Angry"),
        (else_try),
            (ge,":faction_relation_002",-60),
            (str_store_string,s3,"@Hateful"),
        (else_try),
            (ge,":faction_relation_002",-70),
            (str_store_string,s3,"@Revengeful"),
        (else_try),
            (str_store_string,s3,"@Vengeful"),
        (try_end),
    (try_end),
    (str_store_faction_name,s4,":fac_001"),
    (assign,reg1,":faction_relation_002"),
    (str_store_string,s2,"@{!}{s2}^{s4}: {reg1} ({s3})"),
(try_end),
(str_store_string,s1,"@Your relation with the factions are:^{s2}"),
],
[
]),
("camp", 4096, 
  "You set up camp. What do you want to do?", 
  "none", [
(assign,"$g_player_icon_state",0),
(set_background_mesh, "mesh_pic_camp"),
],
[
]),
("camp_cheat", 0, 
  "Select a cheat:", 
  "none", [
],
[
]),
("cheat_find_item", 0, 
  "{!}Current item range: {reg5} to {reg6}", 
  "none", [
(assign,reg5,"$cheat_find_item_range_begin"),
(store_add, reg6, "$cheat_find_item_range_begin", 96),
(val_min,reg6,"itm_items_end"),
(val_sub, reg6, 1),
],
[
]),
("cheat_change_weather", 0, 
  "{!}Current cloud amount: {reg5}^Current Fog Strength: {reg6}", 
  "none", [
(get_global_cloud_amount, reg5),
(get_global_haze_amount, reg6),
],
[
]),
("camp_action", 0, 
  "Choose an action:", 
  "none", [
],
[
]),
("camp_recruit_prisoners", 0, 
  "You offer your prisoners freedom if they agree to join you as soldiers. {s18}", 
  "none", [
(assign,":var001",0),
(party_get_num_prisoner_stacks, ":party_num_prisoners_stacks_002","p_main_party"),
(try_for_range, ":var003", 0, ":party_num_prisoners_stacks_002"),
    (party_prisoner_stack_get_troop_id,":party_prisoner_troop_id_004","p_main_party",":var003"),
    (try_begin),
        (neg|troop_is_hero,":party_prisoner_troop_id_004"),
        (val_add, ":var001", 1),
    (try_end),
(try_end),
(try_begin),
    (eq,":var001",0),
    (jump_to_menu,"mnu_camp_no_prisoners"),
(else_try),
    (eq,":::g_prisoner_recruit_troop_id",0),
    (store_current_hours,"$g_prisoner_recruit_last_time"),
    (store_random_in_range,":random_x_005",0,100),
    (store_skill_level,":skill_lvl_006","skl_persuasion","trp_player"),
    (store_sub, ":var007", 15, ":skill_lvl_006"),
    (val_mul, ":var007", 4),
    (try_begin),
        (lt,":random_x_005",":var007"),
        (assign,"$g_prisoner_recruit_troop_id",-7),
    (else_try),
        (assign,":var001",0),
        (party_get_num_prisoner_stacks, ":party_num_prisoners_stacks_002","p_main_party"),
        (try_for_range, ":var003", 0, ":party_num_prisoners_stacks_002"),
            (party_prisoner_stack_get_troop_id,":party_prisoner_troop_id_004","p_main_party",":var003"),
            (try_begin),
                (neg|troop_is_hero,":party_prisoner_troop_id_004"),
                (val_add, ":var001", 1),
            (try_end),
        (try_end),
        (store_random_in_range,":random_x_008",0,":var001"),
        (try_for_range, ":var003", 0, ":party_num_prisoners_stacks_002"),
            (party_prisoner_stack_get_troop_id,":party_prisoner_troop_id_004","p_main_party",":var003"),
            (try_begin),
                (neg|troop_is_hero,":party_prisoner_troop_id_004"),
                (val_sub, ":random_x_008", 1),
                (try_begin),
                    (lt,":random_x_008",0),
                    (assign,":party_num_prisoners_stacks_002",0),
                    (assign,"$g_prisoner_recruit_troop_id",":party_prisoner_troop_id_004"),
                    (party_prisoner_stack_get_size, "$g_prisoner_recruit_size","p_main_party",":var003"),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (gt,":::g_prisoner_recruit_troop_id",0),
        (party_get_free_companions_capacity,":party_free_companions_capacity_009","p_main_party"),
        (val_min,"$g_prisoner_recruit_size",":party_free_companions_capacity_009"),
        (assign,reg1,"$g_prisoner_recruit_size"),
        (try_begin),
            (gt,":::g_prisoner_recruit_size",0),
            (try_begin),
                (gt,":::g_prisoner_recruit_size",1),
                (assign,reg2,1),
            (else_try),
                (assign,reg2,0),
            (try_end),
        (try_end),
        (str_store_troop_name_by_count,s1,"$g_prisoner_recruit_troop_id","$g_prisoner_recruit_size"),
        (str_store_string,s18,":"),
    (else_try),
        (str_store_string,s18,":"),
    (try_end),
(try_end),
],
[
]),
("camp_no_prisoners", 0, 
  "You have no prisoners to recruit from.", 
  "none", [
],
[
]),
("camp_action_read_book", 0, 
  "Choose a book to read:", 
  "none", [
],
[
]),
("camp_action_read_book_start", 0, 
  "{s1}", 
  "none", [
(assign,":item_id_001","$temp"),
(str_store_item_name,s2,":item_id_001"),
(try_begin),
    (eq,1,1),
    (store_attribute_level,":attribute_lvl_002","trp_player",2),
    (item_get_slot,":item_slot_003",":item_id_001",4),
    (try_begin),
        (le,":item_slot_003",":attribute_lvl_002"),
        (str_store_string,s1,":"),
        (assign,"$g_player_reading_book",":item_id_001"),
    (else_try),
        (str_store_string,s1,":"),
    (try_end),
(try_end),
],
[
]),
("retirement_verify", 0, 
  "You are at day {reg0}. Your current luck is {reg1}. Are you sure you want to retire?", 
  "none", [
(store_current_day,reg0),
(assign,reg1,"$g_player_luck"),
],
[
]),
("end_game", 0, 
  "The decision is made, and you resolve to give up your adventurer's life and settle down. You sell off your weapons and armour, gather up all your money, and ride off into the sunset....", 
  "none", [
],
[
]),
("cattle_herd", 4096, 
  "You encounter a herd of cattle.", 
  "none", [
(play_sound,"snd_cow_moo"),
(set_background_mesh, "mesh_pic_cattle"),
],
[
]),
("cattle_herd_kill", 0, 
  "How many animals do you want to slaughter?", 
  "none", [
(party_get_num_companions,reg5,"$g_encountered_party"),
],
[
]),
("cattle_herd_kill_end", 0, 
  "{!}You shouldn't be reading this.", 
  "none", [
(change_screen_return),
],
[
]),
("arena_duel_fight", 0, 
  "You and your opponent prepare to duel.", 
  "none", [
],
[
]),
("arena_duel_conclusion", 0, 
  "{!}{s11}", 
  "none", [
(try_begin),
    (eq,":::g_leave_encounter",1),
    (change_screen_return),
(try_end),
(str_store_troop_name,s10,"$g_duel_troop"),
(try_begin),
    (quest_slot_eq,"qst_duel_for_lady",2,"$g_duel_troop"),
    (check_quest_failed,"qst_duel_for_lady"),
    (str_store_string,s11,"str_you_lie_stunned_for_several_minutes_then_stagger_to_your_feet_to_find_your_s10_standing_over_you_you_have_lost_the_duel"),
(else_try),
    (quest_slot_eq,"qst_duel_for_lady",2,"$g_duel_troop"),
    (check_quest_succeeded,"qst_duel_for_lady"),
    (str_store_string,s11,"str_s10_lies_in_the_arenas_dust_for_several_minutes_then_staggers_to_his_feet_you_have_won_the_duel"),
(else_try),
    (quest_slot_eq,"qst_duel_courtship_rival",2,"$g_duel_troop"),
    (check_quest_failed,"qst_duel_courtship_rival"),
    (str_store_string,s11,"str_you_lie_stunned_for_several_minutes_then_stagger_to_your_feet_to_find_your_s10_standing_over_you_you_have_lost_the_duel"),
(else_try),
    (quest_slot_eq,"qst_duel_courtship_rival",2,"$g_duel_troop"),
    (check_quest_succeeded,"qst_duel_courtship_rival"),
    (str_store_string,s11,"str_s10_lies_in_the_arenas_dust_for_several_minutes_then_staggers_to_his_feet_you_have_won_the_duel"),
(else_try),
    (quest_slot_eq,"qst_duel_avenge_insult",2,"$g_duel_troop"),
    (check_quest_succeeded,"qst_duel_avenge_insult"),
    (str_store_string,s11,"str_s10_lies_in_the_arenas_dust_for_several_minutes_then_staggers_to_his_feet_you_have_won_the_duel"),
(else_try),
    (quest_slot_eq,"qst_duel_avenge_insult",2,"$g_duel_troop"),
    (check_quest_failed,"qst_duel_avenge_insult"),
    (str_store_string,s11,"str_you_lie_stunned_for_several_minutes_then_stagger_to_your_feet_to_find_your_s10_standing_over_you_you_have_lost_the_duel"),
(else_try),
    (quest_slot_eq,"qst_denounce_lord",2,"$g_duel_troop"),
    (check_quest_succeeded,"qst_denounce_lord"),
    (str_store_string,s11,"str_s10_lies_in_the_arenas_dust_for_several_minutes_then_staggers_to_his_feet_you_have_won_the_duel"),
(else_try),
    (quest_slot_eq,"qst_denounce_lord",2,"$g_duel_troop"),
    (check_quest_failed,"qst_denounce_lord"),
    (str_store_string,s11,"str_you_lie_stunned_for_several_minutes_then_stagger_to_your_feet_to_find_your_s10_standing_over_you_you_have_lost_the_duel"),
(else_try),
    (str_store_troop_name,s10,"$g_duel_troop"),
(try_end),
],
[
]),
("simple_encounter", 4352, 
  "{s2} You have {reg10} troops fit for battle against their {reg11}.", 
  "none", [
(assign,"$g_enemy_party","$g_encountered_party"),
(assign,"$g_ally_party",-1),
(call_script, "script_encounter_calculate_fit"),
(try_begin),
    (eq,":::new_encounter",1),
    (assign,"$new_encounter",0),
    (assign,"$g_encounter_is_in_village",0),
    (assign,"$g_encounter_type",0),
    (try_begin),
        (party_slot_eq,"$g_enemy_party",4,5),
        (party_get_slot,":party_slot_001","$g_enemy_party",5),
        (store_distance_to_party_from_party,":distance_parties_002",":party_slot_001",":party_slot_001"),
        (try_begin),
            (lt,":distance_parties_002",4),
            (assign,"$g_encounter_is_in_village",":party_slot_001"),
            (assign,"$g_encounter_type",1),
        (try_end),
    (try_end),
    (try_begin),
        (gt,":::g_player_raiding_village",0),
        (assign,"$g_encounter_is_in_village","$g_player_raiding_village"),
        (assign,"$g_encounter_type",2),
        (party_quick_attach_to_current_battle, "$g_encounter_is_in_village", 1),
        (str_store_string,s1,"@Villagers"),
        (display_message, "str_s1_joined_battle_enemy"),
    (else_try),
        (eq,":::g_encounter_type",1),
        (party_quick_attach_to_current_battle, "$g_encounter_is_in_village", 0),
        (str_store_string,s1,"@Villagers"),
        (display_message, "str_s1_joined_battle_friend"),
    (try_end),
    (call_script, "script_let_nearby_parties_join_current_battle", 0, 0),
    (call_script, "script_encounter_init_variables"),
    (assign,"$encountered_party_hostile",0),
    (assign,"$encountered_party_friendly",0),
    (try_begin),
        (gt,":::g_encountered_party_relation",0),
        (assign,"$encountered_party_friendly",1),
    (try_end),
    (try_begin),
        (lt,":::g_encountered_party_relation",0),
        (assign,"$encountered_party_hostile",1),
        (try_begin),
            (encountered_party_is_attacker),
            (assign,"$cant_leave_encounter",1),
        (try_end),
    (try_end),
    (assign,"$talk_context",2),
    (call_script, "script_setup_party_meeting", "$g_encountered_party"),
(else_try),
    (try_begin),
        (eq,":::cant_leave_encounter",1),
        (call_script, "script_party_count_members_with_full_health", "p_main_party_backup"),
        (assign,":var003",reg0),
        (call_script, "script_party_count_members_with_full_health", "p_encountered_party_backup"),
        (val_add, ":var003", reg0),
        (call_script, "script_party_count_members_with_full_health", "p_main_party"),
        (assign,":var004",reg0),
        (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
        (val_add, ":var004", reg0),
        (store_sub, ":var005", ":var003", 10),
        (try_begin),
            (lt,":var004",":var005"),
            (assign,"$cant_leave_encounter",0),
        (try_end),
    (try_end),
    (try_begin),
        (eq,":::g_leave_encounter",1),
        (change_screen_return),
    (try_end),
(try_end),
(try_begin),
    (party_is_active,"$g_encountered_party"),
    (str_store_party_name,s1,"$g_encountered_party"),
    (try_begin),
        (eq,":::g_encounter_type",0),
        (str_store_string,s2,":"),
    (else_try),
        (eq,":::g_encounter_type",1),
        (str_store_party_name,s3,"$g_encounter_is_in_village"),
        (str_store_string,s2,":"),
    (else_try),
        (eq,":::g_encounter_type",2),
        (str_store_party_name,s3,"$g_encounter_is_in_village"),
        (str_store_string,s2,":"),
    (try_end),
(try_end),
(try_begin),
    (eq,1,1),
    (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
    (assign,":var006",reg0),
    (assign,":var007",0),
    (try_begin),
        (eq,":::g_battle_result",1),
        (this_or_next|gt,":var006",0),
        (le,":var006",":::num_routed_enemies"),
        (assign,":var007",1),
    (else_try),
        (eq,":::g_engaged_enemy",1),
        (this_or_next|gt,":var006",0),
        (le,":::g_enemy_fit_for_battle",":::num_routed_enemies"),
        (ge,":::g_friend_fit_for_battle",1),
        (assign,":var007",1),
    (try_end),
    (try_begin),
        (this_or_next|eq,":var007",1),
        (eq,":::g_enemy_surrenders",1),
        (assign,"$g_next_menu",-1),
        (jump_to_menu,"mnu_total_victory"),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "p_main_party"),
        (assign,":var008",reg0),
        (assign,":var009",0),
        (try_begin),
            (eq,":::g_battle_result",-1),
            (le,":var008",":::num_routed_us"),
            (assign,":var009",1),
        (else_try),
            (eq,":::g_engaged_enemy",1),
            (ge,":::g_enemy_fit_for_battle",1),
            (le,":::g_friend_fit_for_battle",0),
            (assign,":var009",1),
        (try_end),
    (try_end),
    (try_begin),
        (this_or_next|eq,":var009",1),
        (eq,":::g_player_surrenders",1),
        (assign,"$g_next_menu","mnu_captivity_start_wilderness"),
        (jump_to_menu,"mnu_total_defeat"),
    (try_end),
(try_end),
(try_begin),
    (eq,":::g_encountered_party_template","pt_looters"),
    (set_background_mesh, "mesh_pic_bandits"),
(else_try),
    (eq,":::g_encountered_party_template","pt_mountain_bandits"),
    (set_background_mesh, "mesh_pic_mountain_bandits"),
(else_try),
    (eq,":::g_encountered_party_template","pt_steppe_bandits"),
    (set_background_mesh, "mesh_pic_steppe_bandits"),
(else_try),
    (eq,":::g_encountered_party_template","pt_taiga_bandits"),
    (set_background_mesh, "mesh_pic_steppe_bandits"),
(else_try),
    (eq,":::g_encountered_party_template","pt_sea_raiders"),
    (set_background_mesh, "mesh_pic_sea_raiders"),
(else_try),
    (eq,":::g_encountered_party_template","pt_forest_bandits"),
    (set_background_mesh, "mesh_pic_forest_bandits"),
(else_try),
    (eq,":::g_encountered_party_template","pt_deserters"),
    (set_background_mesh, "mesh_pic_deserters"),
(else_try),
    (eq,":::g_encountered_party_template","pt_kingdom_hero_party"),
    (party_stack_get_troop_id,      ":troop_id_010","$g_encountered_party",0),
    (try_begin),
        (ge,":troop_id_010",1),
        (troop_get_slot,":troop_slot_011",":troop_id_010",14),
        (try_begin),
            (eq,":troop_slot_011",15),
            (set_background_mesh, "mesh_pic_swad"),
        (else_try),
            (eq,":troop_slot_011",16),
            (set_background_mesh, "mesh_pic_vaegir"),
        (else_try),
            (eq,":troop_slot_011",17),
            (set_background_mesh, "mesh_pic_khergit"),
        (else_try),
            (eq,":troop_slot_011",18),
            (set_background_mesh, "mesh_pic_nord"),
        (else_try),
            (eq,":troop_slot_011",19),
            (set_background_mesh, "mesh_pic_rhodock"),
        (else_try),
            (eq,":troop_slot_011",20),
            (set_background_mesh, "mesh_pic_sarranid_encounter"),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("encounter_retreat_confirm", 0, 
  "As the party member with the highest tactics skill, ({reg2}), {reg3?you devise:{s3} devises} a plan that will allow you and your men to escape with your lives, but you'll have to leave {reg4} soldiers behind to stop the enemy from giving chase.", 
  "none", [
(call_script, "script_get_max_skill_of_player_party", "skl_tactics"),
(assign,":var001",reg0),
(assign,":var002",reg1),
(assign,reg2,":var001"),
(val_add, ":var001", 4),
(call_script, "script_party_count_members_with_full_health", "p_collective_enemy", 0),
(assign,":var003",reg0),
(val_div, ":var003", 2),
(store_div, ":var___x1", ":var003", ":var001"),
(assign,reg4,":var___x1"),
(val_max,reg4,1),
(try_begin),
    (eq,":var002","trp_player"),
    (assign,reg3,1),
(else_try),
    (assign,reg3,0),
    (str_store_troop_name,s3,":var002"),
(try_end),
],
[
]),
("encounter_retreat", 0, 
  "You tell {reg4} of your troops to hold the enemy while you retreat with the rest of your party.", 
  "none", [
],
[
]),
("order_attack_begin", 0, 
  "Your troops prepare to attack the enemy.", 
  "none", [
],
[
]),
("order_attack_2", 512, 
  "{s4}^^Your casualties: {s8}^^Enemy casualties: {s9}", 
  "none", [
(set_background_mesh, "mesh_pic_charge"),
(call_script, "script_party_calculate_strength", "p_main_party", 1),
(assign,":var001",reg0),
(call_script, "script_party_calculate_strength", "p_collective_enemy", 0),
(assign,":var002",reg0),
(party_collect_attachments_to_party, "p_main_party", "p_collective_ally"),
(call_script, "script_party_calculate_strength", "p_collective_ally", 1),
(assign,":var003",reg0),
(try_begin),
    (le,":var003",":var002"),
    (assign,":var004",":var003"),
(else_try),
    (assign,":var004",":var002"),
(try_end),
(try_begin),
    (le,":var004",25),
    (assign,":var005",1),
(else_try),
    (le,":var004",50),
    (assign,":var005",2),
(else_try),
    (le,":var004",75),
    (assign,":var005",3),
(else_try),
    (le,":var004",125),
    (assign,":var005",4),
(else_try),
    (le,":var004",200),
    (assign,":var005",5),
(else_try),
    (le,":var004",400),
    (assign,":var005",6),
(else_try),
    (le,":var004",800),
    (assign,":var005",7),
(else_try),
    (le,":var004",1600),
    (assign,":var005",8),
(else_try),
    (le,":var004",3200),
    (assign,":var005",9),
(else_try),
    (le,":var004",6400),
    (assign,":var005",10),
(else_try),
    (le,":var004",12800),
    (assign,":var005",11),
(else_try),
    (le,":var004",25600),
    (assign,":var005",12),
(else_try),
    (le,":var004",51200),
    (assign,":var005",13),
(else_try),
    (le,":var004",102400),
    (assign,":var005",14),
(else_try),
    (assign,":var005",15),
(try_end),
(val_div, ":var001", ":var005"),
(val_max,":var001",1),
(val_div, ":var002", ":var005"),
(val_max,":var002",1),
(val_div, ":var003", ":var005"),
(val_max,":var003",1),
(store_mul, ":_g_strength_contribution_of_player", ":var001", 100),
(val_div, ":::g_strength_contribution_of_player", ":var003"),
(inflict_casualties_to_party_group, "p_main_party", ":var002", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s8,0),
(try_begin),
    (ge,":::g_ally_party",0),
    (inflict_casualties_to_party_group, "$g_ally_party", ":var002", "p_temp_casualties"),
    (str_store_string_reg,s8,0),
(try_end),
(inflict_casualties_to_party_group, "$g_encountered_party", ":var003", "p_temp_casualties"),
(party_get_num_companion_stacks,":party_num_companions_stacks_006","p_temp_casualties"),
(try_for_range, ":stack_no_007", 0, ":party_num_companions_stacks_006"),
    (party_stack_get_troop_id,      ":troop_id_008","p_temp_casualties",":stack_no_007"),
    (try_begin),
        (eq,1,1),
        (party_stack_get_size,          ":party_stack_size_009","p_temp_casualties",":stack_no_007"),
        (try_begin),
            (gt,":party_stack_size_009",0),
            (party_add_members,"p_total_enemy_casualties",":troop_id_008",":party_stack_size_009"),
            (party_stack_get_num_wounded,   ":party_stack_num_wounded_010","p_temp_casualties",":stack_no_007"),
            (try_begin),
                (gt,":party_stack_num_wounded_010",0),
                (party_wound_members,"p_total_enemy_casualties",":troop_id_008",":party_stack_num_wounded_010"),
            (try_end),
        (try_end),
    (try_end),
(try_end),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s9,0),
(party_collect_attachments_to_party, "$g_encountered_party", "p_collective_enemy"),
(assign,"$no_soldiers_left",0),
(try_begin),
    (eq,1,1),
    (call_script, "script_party_count_members_with_full_health", "p_main_party"),
    (assign,":var011",reg0),
    (store_add, ":var012", "$num_routed_us", 1),
    (try_begin),
        (le,":var011",":var012"),
        (assign,"$no_soldiers_left",1),
        (str_store_string,s4,"str_order_attack_failure"),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
        (assign,":var013",reg0),
        (try_begin),
            (this_or_next|gt,":var013",0),
            (le,":var013",":::num_routed_enemies"),
            (assign,":var014",0),
            (party_get_num_companion_stacks,":party_num_companions_stacks_015","p_collective_enemy"),
            (try_begin),
                (eq,":party_num_companions_stacks_015",0),
                (assign,":var014",1),
            (else_try),
                (party_stack_get_troop_id,      ":troop_id_016","p_collective_enemy",0),
                (try_begin),
                    (neg|troop_is_hero,":troop_id_016"),
                    (assign,":var014",1),
                (else_try),
                    (troop_is_wounded,":troop_id_016"),
                    (assign,":var014",1),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (eq,":var014",1),
        (assign,"$g_battle_result",1),
        (assign,"$no_soldiers_left",1),
        (str_store_string,s4,"str_order_attack_success"),
    (else_try),
        (str_store_string,s4,"str_order_attack_continue"),
    (try_end),
(try_end),
],
[
]),
("battle_debrief", 4608, 
  "{s11}^^Your Casualties:{s8}{s10}^^Enemy Casualties:{s9}", 
  "none", [
(try_begin),
    (eq,":::g_battle_result",1),
    (call_script, "script_change_troop_renown", "trp_player", "$battle_renown_value"),
    (try_begin),
        (ge,":::g_encountered_party",0),
        (party_is_active,"$g_encountered_party"),
        (party_get_template_id,":party_template_id_001","$g_encountered_party"),
        (try_begin),
            (eq,":party_template_id_001","pt_kingdom_caravan_party"),
            (get_achievement_stat, ":var002", 30, 0),
            (get_achievement_stat, ":var003", 30, 1),
            (val_add, ":var003", 1),
            (set_achievement_stat, 30, 1, ":var003"),
            (try_begin),
                (ge,":var002",3),
                (ge,":var003",3),
                (unlock_achievement, 30),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (eq,1,1),
        (party_get_current_terrain,":party_cur_terrain_004","p_main_party"),
        (try_begin),
            (eq,":party_cur_terrain_004",4),
            (get_achievement_stat, ":var005", 8, 0),
            (val_add, ":var005", 1),
            (set_achievement_stat, 8, 0, ":var005"),
            (try_begin),
                (eq,":var005",10),
                (unlock_achievement, 8),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (ge,":::g_enemy_party",0),
        (party_is_active,"$g_enemy_party"),
        (party_stack_get_troop_id,      ":troop_id_006","$g_enemy_party",0),
        (try_begin),
            (eq,":troop_id_006","trp_mountain_bandit"),
            (get_achievement_stat, ":var007", 13, 0),
            (val_add, ":var007", 1),
            (set_achievement_stat, 13, 0, ":var007"),
            (try_begin),
                (eq,":var007",10),
                (unlock_achievement, 13),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (is_between,"$g_ally_party","p_town_1","p_village_1"),
        (unlock_achievement, 1),
    (try_end),
    (try_begin),
        (eq,":::g_joined_battle_to_help",1),
        (unlock_achievement, 34),
    (try_end),
(try_end),
(assign,"$g_joined_battle_to_help",0),
(call_script, "script_count_casualties_and_adjust_morale"),
(call_script, "script_encounter_calculate_fit"),
(call_script, "script_party_count_fit_regulars", "p_main_party"),
(assign,"$playerparty_postbattle_regulars",reg0),
(try_begin),
    (eq,":::g_battle_result",1),
    (eq,":::g_enemy_fit_for_battle",0),
    (str_store_string,s11,"@You were victorious!"),
    (try_begin),
        (gt,":::g_friend_fit_for_battle",1),
        (set_background_mesh, "mesh_pic_victory"),
    (try_end),
(else_try),
    (eq,":::g_battle_result",-1),
    (ge,":::g_enemy_fit_for_battle",1),
    (this_or_next|gt,":::g_friend_fit_for_battle",0),
    (le,":::playerparty_postbattle_regulars",0),
    (str_store_string,s11,":"),
    (set_background_mesh, "mesh_pic_defeat"),
(else_try),
    (eq,":::g_battle_result",-1),
    (str_store_string,s11,":"),
    (troop_get_type,":troop_type_008","trp_player"),
    (try_begin),
        (eq,":troop_type_008",1),
        (set_background_mesh, "mesh_pic_wounded_fem"),
    (else_try),
        (set_background_mesh, "mesh_pic_wounded"),
    (try_end),
(else_try),
    (eq,":::g_battle_result",1),
    (str_store_string,s11,":"),
    (try_begin),
        (gt,":::g_friend_fit_for_battle",1),
        (set_background_mesh, "mesh_pic_victory"),
    (try_end),
(else_try),
    (eq,":::g_battle_result",0),
    (str_store_string,s11,":"),
(try_end),
(try_begin),
    (gt,":::playerparty_prebattle_regulars",9),
    (store_add, ":var009", 3, "$g_battle_result"),
    (store_div, ":var___x1", "$playerparty_prebattle_regulars", ":var009"),
    (assign,":var010",":var___x1"),
    (try_begin),
        (lt,":::playerparty_postbattle_regulars",":var010"),
        (call_script, "script_objectionable_action", 2, "str_excessive_casualties"),
    (try_end),
(try_end),
(call_script, "script_print_casualties_to_s0", "p_player_casualties", 0),
(str_store_string_reg,s8,0),
(call_script, "script_print_casualties_to_s0", "p_enemy_casualties", 0),
(str_store_string_reg,s9,0),
(str_clear, 10),
(try_begin),
    (eq,":::any_allies_at_the_last_battle",1),
    (call_script, "script_print_casualties_to_s0", "p_ally_casualties", 0),
    (str_store_string,s10,"@^^Ally Casualties:{s0}"),
(try_end),
],
[
]),
("total_victory", 0, 
  "You shouldn't be reading this... {s9}", 
  "none", [
(assign,":var001",0),
(try_begin),
    (eq,":::routed_party_added",0),
    (assign,"$routed_party_added",1),
    (call_script, "script_add_routed_party"),
(try_end),
(try_begin),
    (check_quest_active,"qst_track_down_bandits"),
    (neg|check_quest_succeeded,"qst_track_down_bandits"),
    (neg|check_quest_failed,"qst_track_down_bandits"),
    (quest_get_slot,":quest_slot_002","qst_track_down_bandits",8),
    (try_begin),
        (party_is_active,":quest_slot_002"),
        (party_get_attached_to, ":party_attached_003", ":"),
        (try_begin),
            (this_or_next|eq,":quest_slot_002",":::g_enemy_party"),
            (eq,":party_attached_003",":::g_enemy_party"),
            (call_script, "script_succeed_quest", "qst_track_down_bandits"),
        (try_end),
    (try_end),
(try_end),
(try_begin),
    (gt,":::g_private_battle_with_troop",0),
    (troop_slot_eq,"$g_private_battle_with_troop",10,"$g_encountered_party"),
    (assign,"$g_private_battle_with_troop",0),
    (assign,"$g_disable_condescending_comments",1),
(try_end),
(party_get_num_companion_stacks,":party_num_companions_stacks_004","p_collective_enemy"),
(try_for_range, ":stack_no_005", 0, ":party_num_companions_stacks_004"),
    (party_stack_get_troop_id,      ":troop_id_006","p_collective_enemy",":stack_no_005"),
    (try_begin),
        (is_between,":troop_id_006","trp_knight_1_1","trp_kingdom_1_pretender"),
        (troop_is_wounded,":troop_id_006"),
        (party_add_members,"p_total_enemy_casualties",":troop_id_006",1),
    (try_end),
(try_end),
(try_begin),
    (eq,":::thanked_by_ally_leader",0),
    (assign,"$thanked_by_ally_leader",1),
    (try_begin),
        (gt,":::g_ally_party",0),
        (store_add, ":var007", "$g_starting_strength_friends", "$g_starting_strength_enemy_party"),
        (val_sub, ":var007", ":::g_starting_strength_main_party"),
        (store_sub, ":var008", "$g_starting_strength_friends", "$g_starting_strength_main_party"),
        (store_mul, ":var009", ":var008", 100),
        (val_add, ":var007", 1),
        (val_div, ":var009", ":var007"),
        (store_sub, ":var010", 100, ":var009"),
        (store_mul, ":var011", ":var010", "$g_starting_strength_enemy_party"),
        (val_div, ":var011", 3000),
        (val_min,":var011",4),
        (store_mul, ":_g_relation_boost", ":var010", ":var010"),
        (val_div, ":::g_relation_boost", 700),
        (val_clamp,"$g_relation_boost",0, 20),
        (party_get_num_companion_stacks,":party_num_companions_stacks_012","$g_ally_party"),
        (try_begin),
            (gt,":party_num_companions_stacks_012",0),
            (store_faction_of_party, ":party_faction_013", "$g_ally_party"),
            (call_script, "script_change_player_relation_with_faction", ":party_faction_013", ":var011"),
            (party_stack_get_troop_id,      ":troop_id_014","$g_ally_party",0),
            (party_stack_get_troop_dna,     ":party_stack_troop_dna_015","$g_ally_party",0),
            (try_begin),
                (troop_is_hero,":troop_id_014"),
                (troop_get_slot,":troop_slot_016",":troop_id_014",22),
                (assign,":var017","$g_relation_boost"),
                (try_begin),
                    (lt,":troop_slot_016",-5),
                    (val_div, ":var017", 3),
                (try_end),
            (try_end),
        (try_end),
        (call_script, "script_change_player_relation_with_troop", ":troop_id_014", ":var017"),
    (try_end),
    (assign,"$talk_context",13),
    (call_script, "script_setup_troop_meeting", ":troop_id_014", ":party_stack_troop_dna_015"),
(else_try),
    (assign,":var001",0),
    (party_get_num_companion_stacks,":party_num_companions_stacks_004","p_total_enemy_casualties"),
    (try_for_range, ":stack_no_018", ":::last_defeated_hero", ":party_num_companions_stacks_004"),
        (try_begin),
            (eq,":var001",0),
            (party_stack_get_troop_id,      ":troop_id_006","p_total_enemy_casualties",":stack_no_018"),
            (party_stack_get_troop_dna,     ":party_stack_troop_dna_019","p_total_enemy_casualties",":stack_no_018"),
            (try_begin),
                (troop_is_hero,":troop_id_006"),
                (store_troop_faction,":troop_faction_020",":troop_id_006"),
                (try_begin),
                    (eq,1,1),
                    (store_relation,":faction_relation_021",":troop_faction_020","fac_player_faction"),
                    (try_begin),
                        (ge,":faction_relation_021",0),
                        (str_store_troop_name,s4,":troop_id_006"),
                        (try_begin),
                            (eq,":::cheat_mode",1),
                            (display_message, "@@{!}{s4} skipped in p total enemy casualties capture queue because is friendly"),
                        (try_end),
                    (try_end),
                (try_end),
            (try_end),
        (else_try),
            (try_begin),
                (eq,1,1),
                (party_stack_get_troop_id,      ":troop_id_022","$g_encountered_party",0),
                (try_begin),
                    (is_between,":troop_id_022","trp_npc1","trp_knight_1_1_wife"),
                    (troop_slot_eq,":troop_id_022",2,2),
                    (store_sub, ":var023", ":troop_id_022", ":trp.npc1"),
                    (get_achievement_stat, ":var024", 7, ":var023"),
                    (try_begin),
                        (eq,":var024",1),
                        (unlock_achievement, 7),
                    (try_end),
                (try_end),
            (try_end),
            (store_add, "$last_defeated_hero", ":stack_no_018", 1),
            (call_script, "script_remove_troop_from_prison", ":troop_id_006"),
            (troop_set_slot,":troop_id_006",10,-1),
            (try_begin),
                (call_script, "script_cf_check_hero_can_escape_from_player", ":troop_id_006"),
                (str_store_troop_name,s1,":troop_id_006"),
                (str_store_faction_name,s3,":troop_faction_020"),
                (str_store_string,s17,":"),
                (display_log_message,"@{!}{s17}"),
                (jump_to_menu,"mnu_enemy_slipped_away"),
                (assign,":var001",1),
            (else_try),
                (store_add, "$last_defeated_hero", ":stack_no_018", 1),
                (call_script, "script_remove_troop_from_prison", ":troop_id_006"),
                (troop_set_slot,":troop_id_006",10,-1),
                (assign,"$talk_context",9),
                (call_script, "script_setup_troop_meeting", ":troop_id_006", ":party_stack_troop_dna_019"),
                (assign,":var001",1),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (eq,":var001",1),
    (else_try),
        (assign,":var001",0),
        (party_get_num_prisoner_stacks, ":party_num_prisoners_stacks_025","p_collective_enemy"),
        (try_for_range, ":stack_no_018", ":::last_freed_hero", ":party_num_prisoners_stacks_025"),
            (try_begin),
                (eq,":var001",0),
                (party_prisoner_stack_get_troop_id,":troop_id_006","p_collective_enemy",":stack_no_018"),
                (try_begin),
                    (troop_is_hero,":troop_id_006"),
                    (party_prisoner_stack_get_troop_dna, ":party_stack_troop_dna_019","p_collective_enemy",":stack_no_018"),
                    (store_add, "$last_freed_hero", ":stack_no_018", 1),
                    (assign,"$talk_context",8),
                    (call_script, "script_setup_troop_meeting", ":troop_id_006", ":party_stack_troop_dna_019"),
                    (assign,":var001",1),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (eq,":var001",1),
    (else_try),
        (eq,":::capture_screen_shown",0),
        (assign,"$capture_screen_shown",1),
        (party_clear,"p_temp_party"),
        (assign,"$g_move_heroes",0),
        (call_script, "script_party_add_wounded_members_as_prisoners", "p_temp_party", "p_total_enemy_casualties"),
        (call_script, "script_party_add_party_prisoners", "p_temp_party", "p_collective_enemy"),
        (try_begin),
            (eq,1,1),
            (call_script, "script_party_calculate_strength", "p_collective_friends_backup", 0),
            (assign,":var026",reg0),
            (try_begin),
                (gt,":var026",0),
                (call_script, "script_party_calculate_strength", "p_main_party_backup", 0),
                (assign,":var027",reg0),
                (store_sub, ":var028", ":var026", ":var027"),
                (store_mul, ":var029", ":var028", 1000),
                (val_div, ":var029", ":var026"),
                (assign,"$pin_number",":var029"),
                (party_clear,"p_temp_party_2"),
                (call_script, "script_move_members_with_ratio", "p_temp_party", "p_temp_party_2"),
                (try_begin),
                    (gt,":::g_ally_party",0),
                    (distribute_party_among_party_group, "p_temp_party_2", "$g_ally_party"),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (party_get_num_companions,":party_num_companions_030","p_temp_party"),
    (party_get_num_prisoners,":party_num_prisioners_031","p_temp_party"),
    (store_add, ":var032", ":party_num_companions_030", ":party_num_prisioners_031"),
    (try_begin),
        (gt,":var032",0),
        (change_screen_exchange_with_party, "p_temp_party"),
    (else_try),
        (eq,":::loot_screen_shown",0),
        (assign,"$loot_screen_shown",1),
        (troop_clear_inventory,"trp_temp_troop"),
        (call_script, "script_party_calculate_loot", "p_total_enemy_casualties"),
        (try_begin),
            (gt,reg0,0),
            (troop_sort_inventory,"trp_temp_troop"),
            (change_screen_loot, "trp_temp_troop"),
        (else_try),
            (try_begin),
                (le,":::g_ally_party",0),
                (end_current_battle),
            (try_end),
        (try_end),
    (try_end),
    (call_script, "script_party_give_xp_and_gold", "p_total_enemy_casualties"),
    (try_begin),
        (eq,":::g_enemy_party",0),
        (display_message, "str_error_string"),
    (try_end),
    (try_begin),
        (party_is_active,"$g_ally_party"),
        (call_script, "script_battle_political_consequences", "$g_enemy_party", "$g_ally_party"),
    (else_try),
        (call_script, "script_battle_political_consequences", "$g_enemy_party", "p_main_party"),
    (try_end),
    (call_script, "script_event_player_defeated_enemy_party", "$g_enemy_party"),
    (call_script, "script_clear_party_group", "$g_enemy_party"),
    (try_begin),
        (eq,":::g_next_menu",-1),
        (call_script, "script_post_battle_personality_clash_check"),
        (party_stack_get_troop_id,      ":troop_id_033","p_encountered_party_backup",0),
        (try_begin),
            (is_between,":troop_id_033","trp_npc1","trp_knight_1_1_wife"),
            (neg|is_between,"$g_encountered_party","p_town_1","p_salt_mine"),
            (store_troop_faction,":troop_faction_034",":troop_id_033"),
            (try_begin),
                (eq,":::g_ally_party",0),
                (call_script, "script_add_log_entry", 11, "trp_player", -1, ":troop_id_033", ":troop_faction_034"),
                (try_begin),
                    (eq,":::cheat_mode",1),
                    (assign, reg0, ":"),
                    (display_message, "@{reg0}"),
                (try_end),
            (else_try),
                (ge,":::g_strength_contribution_of_player",40),
                (call_script, "script_add_log_entry", 11, "trp_player", -1, ":troop_id_033", ":troop_faction_034"),
                (try_begin),
                    (eq,":::cheat_mode",1),
                    (assign, reg0, ":"),
                    (display_message, "@{reg0}"),
                (try_end),
            (else_try),
                (gt,":::g_starting_strength_enemy_party",1000),
                (call_script, "script_get_closest_center", "p_main_party"),
                (assign,":var035",reg0),
                (call_script, "script_add_log_entry", 19, "trp_player", ":var035", -1, ":troop_faction_034"),
                (try_begin),
                    (eq,":::cheat_mode",1),
                    (assign, reg0, ":"),
                    (display_message, "@{reg0}"),
                (try_end),
            (else_try),
                (eq,":::cheat_mode",1),
                (assign, reg0, ":"),
                (display_message, "@{reg0}"),
            (try_end),
        (try_end),
        (val_add, ":::g_total_victories", 1),
        (leave_encounter),
        (change_screen_return),
    (else_try),
        (try_begin),
            (eq,":::g_next_menu","mnu_castle_taken"),
            (call_script, "script_add_log_entry", 10, "trp_player", "$g_encountered_party", -1, "$g_encountered_x_party_faction"),
            (store_current_hours,":cur_hours_036"),
            (faction_set_slot,"$players_kingdom",98,":cur_hours_036"),
            (try_begin),
                (is_between,"$players_kingdom","fac_kingdom_1","fac_kingdoms_end"),
                (jump_to_menu,"$g_next_menu"),
            (else_try),
                (eq,":::players_kingdom","fac_player_supporters_faction"),
                (assign,"$g_center_taken_by_player_faction","$g_encountered_party"),
                (try_begin),
                    (neg|faction_slot_eq,"fac_player_supporters_faction",11,"trp_player"),
                    (faction_get_slot,":faction_slot_037","fac_player_supporters_faction",11),
                    (change_screen_return),
                    (start_map_conversation,":faction_slot_037"),
                (else_try),
                    (neg|is_between,"$players_kingdom","fac_kingdom_1","fac_kingdoms_end"),
                    (assign,"$g_center_taken_by_player_faction","$g_encountered_party"),
                    (assign,"$talk_context",20),
                    (change_screen_return),
                    (assign,":var038","trp_swadian_sharpshooter"),
                    (assign,":var039",0),
                    (party_get_num_companion_stacks,":party_num_companions_stacks_004","p_main_party"),
                    (try_for_range, ":stack_no_018", 0, ":party_num_companions_stacks_004"),
                        (party_stack_get_troop_id,      ":troop_id_006","p_main_party",":stack_no_018"),
                        (try_begin),
                            (neq,":troop_id_006","trp_player"),
                            (party_stack_get_size,          ":party_stack_size_040","p_main_party",":stack_no_018"),
                            (party_stack_get_num_wounded,   ":party_stack_num_wounded_041","p_main_party",":stack_no_018"),
                            (troop_get_slot,":troop_slot_042","p_main_party",146),
                            (assign,":var043",0),
                            (try_begin),
                                (neg|troop_is_hero,":troop_id_006"),
                                (store_add, ":var044", ":party_stack_num_wounded_041", ":troop_slot_042"),
                                (try_begin),
                                    (gt,":party_stack_size_040",":var044"),
                                    (assign,":var043",1),
                                (else_try),
                                    (troop_is_hero,":troop_id_006"),
                                    (neg|troop_is_wounded,":troop_id_006"),
                                    (assign,":var043",1),
                                (try_end),
                            (try_end),
                        (try_end),
                    (try_end),
                    (try_begin),
                        (eq,":var043",1),
                        (try_begin),
                            (troop_is_hero,":troop_id_006"),
                            (troop_get_slot,":troop_slot_045",":troop_id_006",7),
                            (store_mul, ":var046", ":troop_slot_045", 100),
                            (val_add, ":var046", 1000),
                        (else_try),
                            (store_character_level,":character_lvl_047",":troop_id_006"),
                            (assign,":var046",":character_lvl_047"),
                        (try_end),
                    (try_end),
                    (try_begin),
                        (gt,":var046",":var039"),
                        (assign,":var039",":var046"),
                        (assign,":var038",":troop_id_006"),
                        (party_stack_get_troop_dna,     ":party_stack_troop_dna_048","p_main_party",":stack_no_018"),
                    (try_end),
                (try_end),
                (start_map_conversation,":var038"),
            (try_end),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("enemy_slipped_away", 0, 
  "{s17}", 
  "none", [
],
[
]),
("total_defeat", 0, 
  "{!}You shouldn't be reading this...", 
  "none", [
(play_track,1),
(party_get_num_prisoner_stacks, ":party_num_prisoners_stacks_001","p_main_party"),
(try_for_range, ":stack_no_002", 0, ":party_num_prisoners_stacks_001"),
    (party_prisoner_stack_get_troop_id,":party_prisoner_troop_id_003","p_main_party",":stack_no_002"),
    (try_begin),
        (troop_is_hero,":party_prisoner_troop_id_003"),
        (call_script, "script_remove_troop_from_prison", ":party_prisoner_troop_id_003"),
    (try_end),
(try_end),
(try_begin),
    (party_is_active,"$g_ally_party"),
    (call_script, "script_battle_political_consequences", "$g_ally_party", "$g_enemy_party"),
(else_try),
    (call_script, "script_battle_political_consequences", "p_main_party", "$g_enemy_party"),
(try_end),
(call_script, "script_loot_player_items", "$g_enemy_party"),
(assign,"$g_move_heroes",0),
(party_clear,"p_temp_party"),
(call_script, "script_party_add_party_prisoners", "p_temp_party", "p_main_party"),
(call_script, "script_party_prisoners_add_party_companions", "p_temp_party", "p_main_party"),
(distribute_party_among_party_group, "p_temp_party", "$g_enemy_party"),
(assign,"$g_prison_heroes",1),
(call_script, "script_party_remove_all_companions", "p_main_party"),
(assign,"$g_prison_heroes",0),
(assign,"$g_move_heroes",1),
(call_script, "script_party_remove_all_prisoners", "p_main_party"),
(val_add, ":::g_total_defeats", 1),
(try_begin),
    (neq,":::g_player_surrenders",1),
    (store_random_in_range,":random_x_004",0,100),
    (try_begin),
        (ge,":random_x_004",":::g_player_luck"),
        (jump_to_menu,"mnu_permanent_damage"),
    (else_try),
        (try_begin),
            (eq,":::g_next_menu",-1),
            (leave_encounter),
            (change_screen_return),
        (else_try),
            (jump_to_menu,"$g_next_menu"),
        (try_end),
    (try_end),
(try_end),
(try_begin),
    (gt,":::g_ally_party",0),
    (call_script, "script_party_wound_all_members", "$g_ally_party"),
(try_end),
(party_get_num_companion_stacks,":party_num_companions_stacks_005","p_encountered_party_backup"),
(try_for_range, ":stack_no_002", 0, ":party_num_companions_stacks_005"),
    (party_stack_get_troop_id,      ":party_prisoner_troop_id_003","p_encountered_party_backup",":stack_no_002"),
    (try_begin),
        (is_between,":party_prisoner_troop_id_003","trp_npc1","trp_knight_1_1_wife"),
        (troop_slot_eq,":party_prisoner_troop_id_003",2,2),
        (store_troop_faction,":troop_faction_006",":party_prisoner_troop_id_003"),
        (call_script, "script_add_log_entry", 14, "trp_player", -1, ":party_prisoner_troop_id_003", ":troop_faction_006"),
    (try_end),
(try_end),
],
[
]),
("permanent_damage", 512, 
  "{s0}", 
  "none", [
(assign,":var001",1),
(try_for_range, ":var002", 0, ":var001"),
    (store_random_in_range,":random_x_003",0,4),
    (store_attribute_level,":attribute_lvl_004","trp_player",":random_x_003"),
    (try_begin),
        (gt,":attribute_lvl_004",3),
        (neq,":random_x_003",3),
        (try_begin),
            (eq,":random_x_003",0),
            (str_store_string,s0,":"),
        (else_try),
            (eq,":random_x_003",1),
            (str_store_string,s0,":"),
        (else_try),
            (str_store_string,s0,":"),
        (try_end),
    (else_try),
        (lt,":var001",200),
        (val_add, ":var001", 1),
    (try_end),
(try_end),
(try_begin),
    (eq,":var001",200),
    (try_begin),
        (eq,":::g_next_menu",-1),
        (leave_encounter),
        (change_screen_return),
    (else_try),
        (jump_to_menu,"$g_next_menu"),
    (try_end),
(else_try),
    (troop_raise_attribute,"trp_player",":random_x_003",-1),
(try_end),
],
[
]),
("pre_join", 0, 
  "You come across a battle between {s2} and {s1}. You decide to...", 
  "none", [
(str_store_party_name,s1,"$g_encountered_party"),
(str_store_party_name,s2,"$g_encountered_party_2"),
],
[
]),
("join_battle", 0, 
  "You are helping the {s2} against the {s1}. You have {reg10} troops fit for battle against the enemy's {reg11}.", 
  "none", [
(str_store_party_name,s1,"$g_enemy_party"),
(str_store_party_name,s2,"$g_ally_party"),
(call_script, "script_encounter_calculate_fit"),
(try_begin),
    (eq,":::new_encounter",1),
    (assign,"$new_encounter",0),
    (call_script, "script_encounter_init_variables"),
(else_try),
    (eq,":::g_leave_encounter",1),
    (change_screen_return),
(try_end),
(try_begin),
    (eq,1,1),
    (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
    (assign,":var001",reg0),
    (assign,":var002",0),
    (try_begin),
        (eq,":::g_battle_result",1),
        (this_or_next|gt,":var001",0),
        (le,":var001",":::num_routed_enemies"),
        (assign,":var002",1),
    (else_try),
        (eq,":::g_engaged_enemy",1),
        (le,":::g_enemy_fit_for_battle",0),
        (ge,":::g_friend_fit_for_battle",1),
        (assign,":var002",1),
    (try_end),
    (try_begin),
        (this_or_next|eq,":var002",1),
        (eq,":::g_enemy_surrenders",1),
        (assign,"$g_next_menu",-1),
        (jump_to_menu,"mnu_total_victory"),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "p_collective_friends"),
        (assign,":var003",reg0),
        (assign,":var004",0),
        (try_begin),
            (eq,":::g_battle_result",-1),
            (le,":var003",":::num_routed_allies"),
            (assign,":var004",1),
        (try_end),
    (try_end),
    (try_begin),
        (this_or_next|eq,":var004",1),
        (eq,":::g_player_surrenders",1),
        (leave_encounter),
        (change_screen_return),
    (try_end),
(try_end),
],
[
]),
("join_order_attack", 512, 
  "{s4}^^Your casualties: {s8}^^Allies' casualties: {s9}^^Enemy casualties: {s10}", 
  "none", [
(call_script, "script_party_calculate_strength", "p_main_party", 1),
(assign,":var001",reg0),
(val_div, ":var001", 5),
(call_script, "script_party_calculate_strength", "p_collective_friends", 0),
(assign,":var002",reg0),
(val_div, ":var002", 5),
(call_script, "script_party_calculate_strength", "p_collective_enemy", 0),
(assign,":var003",reg0),
(val_div, ":var003", 5),
(try_begin),
    (eq,":var002",0),
    (store_div, ":var___x1", ":var003", 2),
    (assign,":var004",":var___x1"),
(else_try),
    (assign,":var004",":var003"),
    (val_mul, ":var004", ":var001"),
    (val_div, ":var004", ":var002"),
(try_end),
(val_sub, ":var003", ":var004"),
(inflict_casualties_to_party_group, "p_main_party", ":var004", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s8,0),
(inflict_casualties_to_party_group, "$g_enemy_party", ":var002", "p_temp_casualties"),
(party_get_num_companion_stacks,":party_num_companions_stacks_005","p_temp_casualties"),
(try_for_range, ":stack_no_006", 0, ":party_num_companions_stacks_005"),
    (party_stack_get_troop_id,      ":troop_id_007","p_temp_casualties",":stack_no_006"),
    (try_begin),
        (eq,1,1),
        (party_stack_get_size,          ":party_stack_size_008","p_temp_casualties",":stack_no_006"),
        (try_begin),
            (gt,":party_stack_size_008",0),
            (party_add_members,"p_total_enemy_casualties",":troop_id_007",":party_stack_size_008"),
            (party_stack_get_num_wounded,   ":party_stack_num_wounded_009","p_temp_casualties",":stack_no_006"),
            (try_begin),
                (gt,":party_stack_num_wounded_009",0),
                (party_wound_members,"p_total_enemy_casualties",":troop_id_007",":party_stack_num_wounded_009"),
            (try_end),
        (try_end),
    (try_end),
(try_end),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s10,0),
(call_script, "script_collect_friendly_parties"),
(inflict_casualties_to_party_group, "$g_ally_party", ":var003", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s9,0),
(party_collect_attachments_to_party, "$g_enemy_party", "p_collective_enemy"),
(assign,"$no_soldiers_left",0),
(try_begin),
    (eq,1,1),
    (call_script, "script_party_count_members_with_full_health", "p_main_party"),
    (assign,":var010",reg0),
    (try_begin),
        (le,":var010",":::num_routed_us"),
        (assign,"$no_soldiers_left",1),
        (str_store_string,s4,"str_join_order_attack_failure"),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
        (assign,":var011",reg0),
        (try_begin),
            (this_or_next|gt,":var011",0),
            (le,":var011",":::num_routed_enemies"),
            (assign,"$g_battle_result",1),
            (assign,"$no_soldiers_left",1),
            (str_store_string,s4,"str_join_order_attack_success"),
        (else_try),
            (str_store_string,s4,"str_join_order_attack_continue"),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("zendar", 16, 
  "You enter the town of Zendar.", 
  "none", [
(reset_price_rates),
(set_price_rate_for_item,"itm_tools",70),
(set_price_rate_for_item,"itm_salt",140),
],
[
]),
("salt_mine", 16, 
  "You enter the salt mine.", 
  "none", [
(reset_price_rates),
(set_price_rate_for_item,"itm_salt",55),
],
[
]),
("four_ways_inn", 16, 
  "You arrive at the Four Ways Inn.", 
  "none", [
],
[
]),
("test_scene", 0, 
  "You enter the test scene.", 
  "none", [
],
[
]),
("battlefields", 0, 
  "{!}Select a field...", 
  "none", [
],
[
]),
("dhorak_keep", 0, 
  "You enter the Dhorak Keep", 
  "none", [
],
[
]),
("join_siege_outside", 4096, 
  "{s1} has come under siege by {s2}.", 
  "none", [
(str_store_party_name,s1,"$g_encountered_party"),
(str_store_party_name,s2,"$g_encountered_party_2"),
(troop_get_type,":troop_type_001","trp_player"),
(try_begin),
    (eq,":troop_type_001",1),
    (set_background_mesh, "mesh_pic_siege_sighted_fem"),
(else_try),
    (set_background_mesh, "mesh_pic_siege_sighted"),
(try_end),
],
[
]),
("cut_siege_without_fight", 0, 
  "The besiegers let you approach the gates without challenge.", 
  "none", [
],
[
]),
("besiegers_camp_with_allies", 0, 
  "{s1} remains under siege. The banners of {s2} fly above the camp of the besiegers, where you and your men are welcomed.", 
  "none", [
(str_store_party_name,s1,"$g_encountered_party"),
(str_store_party_name,s2,"$g_encountered_party_2"),
(assign,"$g_enemy_party","$g_encountered_party"),
(assign,"$g_ally_party","$g_encountered_party_2"),
(select_enemy,0),
(call_script, "script_encounter_calculate_fit"),
(try_begin),
    (eq,":::new_encounter",1),
    (assign,"$new_encounter",0),
    (call_script, "script_encounter_init_variables"),
(try_end),
(try_begin),
    (eq,":::g_leave_encounter",1),
    (change_screen_return),
(else_try),
    (assign,":var001",0),
    (try_begin),
        (eq,":::g_battle_result",1),
        (assign,":var001",1),
    (else_try),
        (le,":::g_enemy_fit_for_battle",0),
        (ge,":::g_friend_fit_for_battle",1),
        (assign,":var001",1),
    (try_end),
    (try_begin),
        (this_or_next|eq,":var001",1),
        (eq,":::g_enemy_surrenders",1),
        (call_script, "script_party_wound_all_members", "$g_enemy_party"),
        (leave_encounter),
        (change_screen_return),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "p_collective_friends"),
        (assign,":var002",reg0),
        (try_begin),
            (eq,":::g_battle_result",-1),
            (eq,":var002",0),
            (leave_encounter),
            (change_screen_return),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("castle_outside", 4096, 
  "You are outside {s2}.{s11} {s3} {s4}", 
  "none", [
(assign,"$g_enemy_party","$g_encountered_party"),
(assign,"$g_ally_party",-1),
(str_store_party_name,s2,"$g_encountered_party"),
(call_script, "script_encounter_calculate_fit"),
(assign,"$all_doors_locked",1),
(assign,"$current_town","$g_encountered_party"),
(try_begin),
    (eq,":::new_encounter",1),
    (assign,"$new_encounter",0),
    (call_script, "script_let_nearby_parties_join_current_battle", 1, 0),
    (call_script, "script_encounter_init_variables"),
    (assign,"$entry_to_town_forbidden",0),
    (assign,"$sneaked_into_town",0),
    (assign,"$town_entered",0),
    (assign,"$encountered_party_hostile",0),
    (assign,"$encountered_party_friendly",0),
    (try_begin),
        (gt,":::g_player_besiege_town",0),
        (neq,":::g_player_besiege_town",":::g_encountered_party"),
        (party_slot_eq,"$g_player_besiege_town",54,"p_main_party"),
        (call_script, "script_lift_siege", "$g_player_besiege_town", 0),
        (assign,"$g_player_besiege_town",-1),
    (try_end),
    (try_begin),
        (lt,":::g_encountered_party_relation",0),
        (assign,"$encountered_party_hostile",1),
        (assign,"$entry_to_town_forbidden",1),
    (try_end),
    (assign,"$cant_sneak_into_town",0),
    (try_begin),
        (eq,":::current_town",":::last_sneak_attempt_town"),
        (store_current_hours,reg2),
        (val_sub, reg2, ":::last_sneak_attempt_time"),
        (try_begin),
            (lt,reg2,12),
            (assign,"$cant_sneak_into_town",1),
        (try_end),
    (try_end),
(else_try),
    (eq,":::g_leave_encounter",1),
    (change_screen_return),
(try_end),
(str_clear, 4),
(try_begin),
    (eq,":::entry_to_town_forbidden",1),
    (try_begin),
        (eq,":::cant_sneak_into_town",1),
        (str_store_string,s4,"str_sneaking_to_town_impossible"),
    (else_try),
        (str_store_string,s4,"str_entrance_to_town_forbidden"),
    (try_end),
(try_end),
(party_get_slot,":party_slot_001","$current_town",7),
(store_faction_of_party, ":party_faction_002", "$current_town"),
(str_store_faction_name,s9,":party_faction_002"),
(try_begin),
    (ge,":party_slot_001",0),
    (str_store_troop_name,s8,":party_slot_001"),
    (str_store_string,s7,"@{s8} of {s9}"),
(try_end),
(try_begin),
    (party_slot_eq,"$current_town",0,2),
    (try_begin),
        (eq,":party_slot_001","trp_player"),
        (str_store_string,s11,":"),
    (else_try),
        (ge,":party_slot_001",0),
        (str_store_string,s11,":"),
    (else_try),
        (is_between,":party_faction_002","fac_player_supporters_faction","fac_kingdoms_end"),
        (str_store_string,s11,"str__this_castle_is_temporarily_under_royal_control"),
    (else_try),
        (str_store_string,s11,"str__this_castle_does_not_seem_to_be_under_anyones_control"),
    (try_end),
(else_try),
    (try_begin),
        (eq,":party_slot_001","trp_player"),
        (str_store_string,s11,":"),
    (else_try),
        (ge,":party_slot_001",0),
        (str_store_string,s11,":"),
    (else_try),
        (is_between,":party_faction_002","fac_player_supporters_faction","fac_kingdoms_end"),
        (str_store_string,s11,"str__this_town_is_temporarily_under_royal_control"),
    (else_try),
        (str_store_string,s11,"str__the_townspeople_seem_to_have_declared_their_independence"),
    (try_end),
(try_end),
(party_get_num_companions,reg7,"p_collective_enemy"),
(assign,"$castle_undefended",0),
(str_clear, 3),
(try_begin),
    (eq,reg7,0),
    (assign,"$castle_undefended",1),
    (str_store_string,s3,"str_castle_is_abondened"),
(else_try),
    (eq,":::g_encountered_x_party_faction","fac_player_supporters_faction"),
    (str_store_string,s3,"str_place_is_occupied_by_player"),
(else_try),
    (lt,":::g_encountered_party_relation",0),
    (str_store_string,s3,"str_place_is_occupied_by_enemy"),
(else_try),
(try_end),
(try_begin),
    (eq,":::g_leave_town_outside",1),
    (assign,"$g_leave_town_outside",0),
    (assign,"$g_permitted_to_center",0),
    (change_screen_return),
(else_try),
    (check_quest_active,"qst_escort_lady"),
    (quest_slot_eq,"qst_escort_lady",1,"$g_encountered_party"),
    (quest_get_slot,":quest_slot_003","qst_escort_lady",4),
    (call_script, "script_get_meeting_scene"),
    (assign,":scene_id_004",reg0),
    (modify_visitors_at_site,":scene_id_004"),
    (reset_visitors),
    (set_visitor,0,"trp_player"),
    (set_visitor,17,":quest_slot_003"),
    (set_jump_mission,"mt_conversation_encounter"),
    (jump_to_scene,":scene_id_004"),
    (assign,"$talk_context",10),
    (change_screen_map_conversation, ":quest_slot_003"),
(else_try),
    (check_quest_active,"qst_kidnapped_girl"),
    (quest_slot_eq,"qst_kidnapped_girl",12,"$g_encountered_party"),
    (quest_slot_eq,"qst_kidnapped_girl",11,3),
    (call_script, "script_get_meeting_scene"),
    (assign,":scene_id_004",reg0),
    (modify_visitors_at_site,":scene_id_004"),
    (reset_visitors),
    (set_visitor,0,"trp_player"),
    (set_visitor,17,"trp_kidnapped_girl"),
    (set_jump_mission,"mt_conversation_encounter"),
    (jump_to_scene,":scene_id_004"),
    (assign,"$talk_context",10),
    (change_screen_map_conversation, "trp_kidnapped_girl"),
(else_try),
    (eq,":::g_town_visit_after_rest",1),
    (assign,"$g_town_visit_after_rest",0),
    (jump_to_menu,"mnu_town"),
(else_try),
    (party_slot_eq,"$g_encountered_party",0,2),
    (this_or_next|party_slot_eq,"$g_encountered_party",7,"trp_player"),
    (faction_slot_eq,"$g_encountered_x_party_faction",11,"trp_player"),
    (jump_to_menu,"mnu_enter_your_own_castle"),
(else_try),
    (party_slot_eq,"$g_encountered_party",0,2),
    (ge,":::g_encountered_party_relation",0),
    (this_or_next|eq,":::castle_undefended",1),
    (this_or_next|eq,":::g_permitted_to_center",1),
    (eq,":::g_encountered_x_party_faction",":::players_kingdom"),
    (jump_to_menu,"mnu_town"),
(else_try),
    (party_slot_eq,"$g_encountered_party",0,3),
    (ge,":::g_encountered_party_relation",0),
    (jump_to_menu,"mnu_town"),
(else_try),
    (eq,":::g_player_besiege_town",":::g_encountered_party"),
    (jump_to_menu,"mnu_castle_besiege"),
(try_end),
(call_script, "script_set_town_picture"),
],
[
]),
("castle_guard", 4096, 
  "You approach the gate. The men on the walls watch you closely.", 
  "none", [
(call_script, "script_set_town_picture"),
],
[
]),
("castle_entry_granted", 4096, 
  "After a brief wait, the guards open the gates for you and allow your party inside.", 
  "none", [
(call_script, "script_set_town_picture"),
],
[
]),
("castle_entry_denied", 4096, 
  "The lord of this castle has forbidden you from coming inside these walls, and the guard sergeant informs you that his men will fire if you attempt to come any closer.", 
  "none", [
(call_script, "script_set_town_picture"),
],
[
]),
("castle_meeting", 4096, 
  "With whom do you want to meet?", 
  "none", [
(assign,"$num_castle_meeting_troops",0),
(try_for_range, ":trp_001", ":trp.npc1", ":trp.knight_1_1_wife"),
    (try_begin),
        (troop_slot_eq,":trp_001",2,2),
        (call_script, "script_get_troop_attached_party", ":trp_001"),
        (try_begin),
            (eq,":::g_encountered_party",reg0),
            (troop_set_slot,"trp_temp_array_a","$num_castle_meeting_troops",":trp_001"),
            (val_add, ":::num_castle_meeting_troops", 1),
        (try_end),
    (try_end),
(try_end),
(call_script, "script_set_town_picture"),
],
[
]),
("castle_meeting_selected", 0, 
  "Your request for a meeting is relayed inside, and finally {s6} appears in the courtyard to speak with you.", 
  "none", [
(str_store_troop_name,s6,"$castle_meeting_selected_troop"),
],
[
]),
("castle_besiege", 4096, 
  "You are laying siege to {s1}. {s2} {s3}", 
  "none", [
(troop_get_type,":troop_type_001","trp_player"),
(try_begin),
    (eq,":troop_type_001",1),
    (set_background_mesh, "mesh_pic_siege_sighted_fem"),
(else_try),
    (set_background_mesh, "mesh_pic_siege_sighted"),
(try_end),
(assign,"$g_siege_force_wait",0),
(try_begin),
    (party_slot_eq,"$g_encountered_party",54,-1),
    (party_set_slot,"$g_encountered_party",54,"p_main_party"),
    (store_current_hours,":cur_hours_002"),
    (party_set_slot,"$g_encountered_party",64,":cur_hours_002"),
    (assign,"$g_siege_method",0),
    (assign,"$g_siege_sallied_out_once",0),
(try_end),
(party_get_slot,":party_slot_003","$g_encountered_party",53),
(call_script, "script_center_get_food_consumption", "$g_encountered_party"),
(assign,":var004",reg0),
(assign,reg7,":var004"),
(assign,reg8,":party_slot_003"),
(store_div, ":var___x1", ":party_slot_003", ":var004"),
(assign,reg3,":var___x1"),
(try_begin),
    (party_slot_eq,"$g_encountered_party",0,3),
    (assign,reg6,1),
(else_try),
    (assign,reg6,0),
(try_end),
(try_begin),
    (gt,reg3,0),
    (str_store_string,s2,":"),
(else_try),
    (str_store_string,s2,":"),
(try_end),
(str_store_string,s3,"str_empty_string"),
(try_begin),
    (ge,":::g_siege_method",1),
    (store_current_hours,":cur_hours_002"),
    (try_begin),
        (lt,":cur_hours_002",":::g_siege_method_finish_hours"),
        (store_sub, reg9, "$g_siege_method_finish_hours", ":cur_hours_002"),
        (try_begin),
            (eq,":::g_siege_method",1),
            (str_store_string,s3,":"),
        (else_try),
            (eq,":::g_siege_method",2),
            (str_store_string,s3,":"),
        (try_end),
    (else_try),
        (try_begin),
            (eq,":::g_siege_method",1),
            (str_store_string,s3,":"),
        (else_try),
            (eq,":::g_siege_method",2),
            (str_store_string,s3,":"),
        (try_end),
    (try_end),
(try_end),
(try_begin),
    (eq,":::g_castle_left_to_player",1),
    (assign,"$g_castle_left_to_player",0),
    (store_faction_of_party, ":party_faction_005", "$g_encountered_party"),
    (party_set_faction,"$g_encountered_party","fac_neutral"),
    (party_get_num_attached_parties, ":party_num_attached_parties_006", "$g_encountered_party"),
    (try_for_range, ":var007", 0, ":party_num_attached_parties_006"),
        (party_get_attached_party_with_rank, ":party_attached_party_with_rank_008", "$g_encountered_party", ":var007"),
        (party_detach, ":party_attached_party_with_rank_008"),
        (party_get_slot,":party_slot_009",":party_attached_party_with_rank_008",0),
        (try_begin),
            (eq,":party_slot_009",13),
            (store_faction_of_party, ":party_faction_010", ":party_attached_party_with_rank_008"),
            (call_script, "script_get_closest_walled_center_of_faction", ":party_attached_party_with_rank_008", ":party_faction_010"),
            (try_begin),
                (gt,reg0,0),
                (call_script, "script_party_set_ai_state", ":party_attached_party_with_rank_008", 7, reg0),
            (else_try),
                (call_script, "script_party_set_ai_state", ":party_attached_party_with_rank_008", 4, "$g_encountered_party"),
            (try_end),
        (try_end),
    (try_end),
    (call_script, "script_party_remove_all_companions", "$g_encountered_party"),
    (change_screen_return),
    (party_collect_attachments_to_party, "$g_encountered_party", "p_collective_enemy"),
    (call_script, "script_party_copy", "p_encountered_party_backup", "p_collective_enemy"),
    (party_set_faction,"$g_encountered_party",":party_faction_005"),
(try_end),
(assign,"$g_enemy_party","$g_encountered_party"),
(assign,"$g_ally_party",-1),
(str_store_party_name,s1,"$g_encountered_party"),
(call_script, "script_encounter_calculate_fit"),
(assign,reg11,"$g_enemy_fit_for_battle"),
(assign,reg10,"$g_friend_fit_for_battle"),
(try_begin),
    (eq,":::g_leave_encounter",1),
    (change_screen_return),
(else_try),
    (call_script, "script_party_count_fit_regulars", "p_collective_enemy"),
    (assign,":var011",0),
    (try_begin),
        (eq,":::g_battle_result",1),
        (assign,":var011",1),
    (else_try),
        (le,":::g_enemy_fit_for_battle",0),
        (ge,":::g_friend_fit_for_battle",1),
        (assign,":var011",1),
    (try_end),
    (try_begin),
        (this_or_next|eq,":var011",1),
        (eq,":::g_enemy_surrenders",1),
        (assign,"$g_next_menu","mnu_castle_taken"),
        (jump_to_menu,"mnu_total_victory"),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "p_main_party"),
        (assign,":var012",reg0),
        (try_begin),
            (eq,":::g_battle_result",-1),
            (eq,":var012",0),
            (assign,"$g_next_menu","mnu_captivity_start_castle_defeat"),
            (jump_to_menu,"mnu_total_defeat"),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("siege_attack_meets_sally", 4096, 
  "The defenders sally out to meet your assault.", 
  "none", [
(set_background_mesh, "mesh_pic_sally_out"),
],
[
]),
("castle_besiege_inner_battle", 4096, 
  "{s1}", 
  "none", [
(troop_get_type,":troop_type_001","trp_player"),
(try_begin),
    (eq,":troop_type_001",1),
    (set_background_mesh, "mesh_pic_siege_sighted_fem"),
(else_try),
    (set_background_mesh, "mesh_pic_siege_sighted"),
(try_end),
(assign,":var002","$g_battle_result"),
(call_script, "script_encounter_calculate_fit"),
(str_store_string,s1,":"),
(str_store_string,s1,":"),
(try_begin),
    (this_or_next|eq,":var002",1),
    (this_or_next|gt,":::g_friend_fit_for_battle",0),
    (le,":::g_enemy_fit_for_battle",0),
    (jump_to_menu,"$g_siege_final_menu"),
(else_try),
    (call_script, "script_encounter_calculate_fit"),
    (try_begin),
        (party_slot_eq,"$g_encountered_party",0,3),
        (try_begin),
            (eq,":::g_siege_battle_state",0),
            (eq,":var002",1),
            (assign,"$g_battle_result",0),
            (jump_to_menu,"$g_siege_final_menu"),
        (else_try),
            (eq,":::g_siege_battle_state",1),
            (eq,":var002",1),
            (str_store_string,s1,":"),
        (else_try),
            (eq,":::g_siege_battle_state",2),
            (eq,":var002",1),
            (str_store_string,s1,":"),
        (else_try),
            (jump_to_menu,"$g_siege_final_menu"),
        (try_end),
    (else_try),
        (try_begin),
            (eq,":::g_siege_battle_state",0),
            (eq,":var002",1),
            (assign,"$g_battle_result",0),
            (jump_to_menu,"$g_siege_final_menu"),
        (else_try),
            (eq,":::g_siege_battle_state",1),
            (eq,":var002",1),
            (str_store_string,s1,":"),
        (else_try),
            (jump_to_menu,"$g_siege_final_menu"),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("construct_ladders", 0, 
  "As the party member with the highest Engineer skill ({reg2}), {reg3?you estimate:{s3} estimates} that it will take {reg4} hours to build enough scaling ladders for the assault.", 
  "none", [
(call_script, "script_get_max_skill_of_player_party", "skl_engineer"),
(assign,":var001",reg0),
(assign,":var002",reg1),
(assign,reg2,":var001"),
(store_sub, reg4, 14, ":var001"),
(val_mul, reg4, 2),
(val_div, reg4, 3),
(try_begin),
    (eq,":var002","trp_player"),
    (assign,reg3,1),
(else_try),
    (assign,reg3,0),
    (str_store_troop_name,s3,":var002"),
(try_end),
],
[
]),
("construct_siege_tower", 0, 
  "As the party member with the highest Engineer skill ({reg2}), {reg3?you estimate:{s3} estimates} that building a siege tower will take {reg4} hours.", 
  "none", [
(call_script, "script_get_max_skill_of_player_party", "skl_engineer"),
(assign,":var001",reg0),
(assign,":var002",reg1),
(assign,reg2,":var001"),
(store_sub, reg4, 15, ":var001"),
(val_mul, reg4, 6),
(try_begin),
    (eq,":var002","trp_player"),
    (assign,reg3,1),
(else_try),
    (assign,reg3,0),
    (str_store_troop_name,s3,":var002"),
(try_end),
],
[
]),
("castle_attack_walls_simulate", 4608, 
  "{s4}^^Your casualties:{s8}^^Enemy casualties were: {s9}", 
  "none", [
(try_begin),
    (eq,1,1),
    (set_background_mesh, "mesh_pic_siege_attack"),
(try_end),
(call_script, "script_party_calculate_strength", "p_main_party", 1),
(assign,":var001",reg0),
(val_div, ":var001", 10),
(call_script, "script_party_calculate_strength", "$g_encountered_party", 0),
(assign,":var002",reg0),
(val_div, ":var002", 4),
(inflict_casualties_to_party_group, "p_main_party", ":var002", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s8,0),
(inflict_casualties_to_party_group, "$g_encountered_party", ":var001", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s9,0),
(assign,"$no_soldiers_left",0),
(try_begin),
    (eq,1,1),
    (call_script, "script_party_count_members_with_full_health", "p_main_party"),
    (try_begin),
        (le,reg0,0),
        (assign,"$no_soldiers_left",1),
        (str_store_string,s4,"str_attack_walls_failure"),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "$g_encountered_party"),
        (try_begin),
            (le,reg0,0),
            (assign,"$no_soldiers_left",1),
            (assign,"$g_battle_result",1),
            (str_store_string,s4,"str_attack_walls_success"),
        (else_try),
            (str_store_string,s4,"str_attack_walls_continue"),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("castle_attack_walls_with_allies_simulate", 4608, 
  "{s4}^^Your casualties: {s8}^^Allies' casualties: {s9}^^Enemy casualties: {s10}", 
  "none", [
(try_begin),
    (eq,1,1),
    (set_background_mesh, "mesh_pic_siege_attack"),
(try_end),
(call_script, "script_party_calculate_strength", "p_main_party", 1),
(assign,":var001",reg0),
(val_div, ":var001", 10),
(call_script, "script_party_calculate_strength", "p_collective_friends", 0),
(assign,":var002",reg0),
(val_div, ":var002", 10),
(val_max,":var002",1),
(call_script, "script_party_calculate_strength", "p_collective_enemy", 0),
(assign,":var003",reg0),
(val_div, ":var003", 4),
(try_begin),
    (eq,":var002",0),
    (store_div, ":var___x1", ":var003", 2),
    (assign,":var004",":var___x1"),
(else_try),
    (assign,":var004",":var003"),
    (val_mul, ":var004", ":var001"),
    (val_div, ":var004", ":var002"),
(try_end),
(val_sub, ":var003", ":var004"),
(inflict_casualties_to_party_group, "p_main_party", ":var004", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s8,0),
(inflict_casualties_to_party_group, "$g_enemy_party", ":var002", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s10,0),
(call_script, "script_collect_friendly_parties"),
(inflict_casualties_to_party_group, "$g_ally_party", ":var003", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s9,0),
(party_collect_attachments_to_party, "$g_enemy_party", "p_collective_enemy"),
(assign,"$no_soldiers_left",0),
(try_begin),
    (eq,1,1),
    (call_script, "script_party_count_members_with_full_health", "p_main_party"),
    (try_begin),
        (le,reg0,0),
        (assign,"$no_soldiers_left",1),
        (str_store_string,s4,"str_attack_walls_failure"),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
        (try_begin),
            (le,reg0,0),
            (assign,"$no_soldiers_left",1),
            (assign,"$g_battle_result",1),
            (str_store_string,s4,"str_attack_walls_success"),
        (else_try),
            (str_store_string,s4,"str_attack_walls_continue"),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("castle_taken_by_friends", 0, 
  "Nothing to see here.", 
  "none", [
(party_clear,"$g_encountered_party"),
(party_stack_get_troop_id,      ":troop_id_001","$g_encountered_party_2",0),
(party_set_slot,"$g_encountered_party",28,":troop_id_001"),
(store_troop_faction,":troop_faction_002",":troop_id_001"),
(call_script, "script_change_center_prosperity", "$g_encountered_party", -5),
(try_begin),
    (eq,1,1),
    (assign,":var003",20),
    (try_begin),
        (is_between,"$g_encountered_party","p_town_1","p_castle_1"),
        (assign,":var003",40),
    (try_end),
(try_end),
(try_begin),
    (neq,":troop_faction_002",":::g_encountered_x_party_faction"),
    (call_script, "script_faction_inflict_war_damage_on_faction", ":troop_faction_002", "$g_encountered_x_party_faction", ":var003"),
(try_end),
(call_script, "script_give_center_to_faction", "$g_encountered_party", ":troop_faction_002"),
(call_script, "script_add_log_entry", 18, "trp_player", "$g_encountered_party", 0, "$g_encountered_x_party_faction"),
(change_screen_return),
],
[
]),
("castle_taken", 512, 
  "{s3} has fallen to your troops, and you now have full control of the {reg2?town:castle}.{reg1? You may station troops here to defend it against enemies who may try to recapture it. Also, you should select now whether you will hold the {reg2?town:castle} yourself or give it to a faithful vassal...:}", 
  "none", [
(party_clear,"$g_encountered_party"),
(try_begin),
    (eq,":::players_kingdom","fac_player_supporters_faction"),
    (party_get_slot,":party_slot_001","$g_encountered_party",7),
    (try_begin),
        (neq,":party_slot_001","trp_player"),
        (try_for_range, ":var002", 0, 4),
            (try_begin),
                (call_script,"script_cf_reinforce_party"),
            (try_end),
        (try_end),
    (try_end),
(try_end),
(call_script, "script_lift_siege", "$g_encountered_party", 0),
(assign,"$g_player_besiege_town",-1),
(party_set_slot,"$g_encountered_party",28,"trp_player"),
(call_script, "script_change_center_prosperity", "$g_encountered_party", -5),
(call_script, "script_change_troop_renown", "trp_player", 5),
(assign,":var003",20),
(try_begin),
    (is_between,"$g_encountered_party","p_town_1","p_castle_1"),
    (assign,":var003",40),
(try_end),
(call_script, "script_faction_inflict_war_damage_on_faction", "$players_kingdom", "$g_encountered_x_party_faction", ":var003"),
(try_begin),
    (is_between,"$players_kingdom","fac_player_supporters_faction","fac_kingdoms_end"),
    (neq,":::players_kingdom","fac_player_supporters_faction"),
    (call_script, "script_give_center_to_faction", "$g_encountered_party", "$players_kingdom"),
    (call_script, "script_order_best_besieger_party_to_guard_center", "$g_encountered_party", "$players_kingdom"),
    (jump_to_menu,"mnu_castle_taken_2"),
(else_try),
    (call_script, "script_give_center_to_faction", "$g_encountered_party", "fac_player_supporters_faction"),
    (call_script, "script_order_best_besieger_party_to_guard_center", "$g_encountered_party", "fac_player_supporters_faction"),
    (str_store_party_name,s3,"$g_encountered_party"),
    (assign,reg1,0),
    (try_begin),
        (faction_slot_eq,"fac_player_supporters_faction",11,"trp_player"),
        (assign,reg1,1),
    (try_end),
(try_end),
(assign,reg2,0),
(try_begin),
    (is_between,"$g_encountered_party","p_town_1","p_castle_1"),
    (assign,reg2,1),
(try_end),
],
[
]),
("castle_taken_2", 512, 
  "{s3} has fallen to your troops, and you now have full control of the castle. It is time to send word to {s9} about your victory. {s5}", 
  "none", [
(str_store_party_name,s3,"$g_encountered_party"),
(str_clear, 5),
(faction_get_slot,":faction_slot_001","$players_kingdom",11),
(str_store_troop_name,s9,":faction_slot_001"),
(try_begin),
    (eq,":::player_has_homage",0),
    (assign,reg8,0),
    (try_begin),
        (party_slot_eq,"$g_encountered_party",3,0),
        (assign,reg8,1),
    (try_end),
    (str_store_string,s5,":"),
(try_end),
],
[
]),
("requested_castle_granted_to_player", 4096, 
  "You receive a message from your liege, {s3}.^^ {reg4?She:He} has decided to grant {s2}{reg3? and the nearby village of {s4}:} to you, with all due incomes and titles, to hold in {reg4?her:his} name for as long as you maintain your oath of homage..", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,":faction_slot_001","$players_kingdom",11),
(str_store_troop_name,s3,":faction_slot_001"),
(str_store_party_name,s2,"$g_center_to_give_to_player"),
(try_begin),
    (party_slot_eq,"$g_center_to_give_to_player",0,2),
    (assign,reg3,1),
    (try_for_range, ":p_002", ":p.village_1", ":p.salt_mine"),
        (try_begin),
            (party_slot_eq,":p_002",120,"$g_center_to_give_to_player"),
            (str_store_party_name,s4,":p_002"),
        (try_end),
    (try_end),
(else_try),
    (assign,reg3,0),
(try_end),
(troop_get_type,reg4,":faction_slot_001"),
],
[
]),
("requested_castle_granted_to_player_husband", 4096, 
  "You receive a message from your liege, {s3}.^^ {reg4?She:He} has decided to grant {s2}{reg3? and the nearby village of {s4}:} to your husband, {s7}.", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,":faction_slot_001","$players_kingdom",11),
(str_store_troop_name,s3,":faction_slot_001"),
(str_store_party_name,s2,"$g_center_to_give_to_player"),
(try_begin),
    (party_slot_eq,"$g_center_to_give_to_player",0,2),
    (assign,reg3,1),
    (try_for_range, ":p_002", ":p.village_1", ":p.salt_mine"),
        (try_begin),
            (party_slot_eq,":p_002",120,"$g_center_to_give_to_player"),
            (str_store_party_name,s4,":p_002"),
        (try_end),
    (try_end),
(else_try),
    (assign,reg3,0),
(try_end),
(troop_get_type,reg4,":faction_slot_001"),
(troop_get_slot,":troop_slot_003","trp_player",30),
(str_store_troop_name,s11,":troop_slot_003"),
(str_store_string,s7,"str_to_your_husband_s11"),
],
[
]),
("requested_castle_granted_to_another", 4096, 
  "You receive a message from your monarch, {s3}.^^ 'I was most pleased to hear of your valiant efforts in the capture of {s2}. Your victory has gladdened all our hearts. You also requested me to give you ownership of the castle, but that is a favour which I fear I cannot grant, as you already hold significant estates in my realm. Instead I have sent you {reg6} denars to cover the expenses of your campaign, but {s2} I give to {s5}.' ", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,":faction_slot_001","$players_kingdom",11),
(str_store_troop_name,s3,":faction_slot_001"),
(str_store_party_name,s2,"$g_center_to_give_to_player"),
(party_get_slot,":party_slot_002","$g_center_to_give_to_player",7),
(str_store_troop_name,s5,":party_slot_002"),
(assign,reg6,900),
(assign,"$g_castle_requested_by_player",-1),
(assign,"$g_castle_requested_for_troop",-1),
],
[
]),
("requested_castle_granted_to_another_female", 4096, 
  "You receive a message from your monarch, {s3}.^^ 'I was most pleased to hear of your valiant efforts in the capture of {s2}. Your victory has gladdened all our hearts. You also requested me to give ownership of the castle to your husband, but that is a favour which I fear I cannot grant, as he already holds significant estates in my realm. Instead I have sent you {reg6} denars to cover the expenses of your campaign, but {s2} I give to {s5}.' ", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,":faction_slot_001","$players_kingdom",11),
(str_store_troop_name,s3,":faction_slot_001"),
(str_store_party_name,s2,"$g_center_to_give_to_player"),
(party_get_slot,":party_slot_002","$g_center_to_give_to_player",7),
(str_store_troop_name,s5,":party_slot_002"),
(assign,reg6,900),
(assign,"$g_castle_requested_by_player",-1),
(assign,"$g_castle_requested_for_troop",-1),
],
[
]),
("leave_faction", 0, 
  "Renouncing your oath is a grave act. Your lord may condemn you and confiscate your lands and holdings. However, if you return them of your own free will, he may let the betrayal go without a fight.", 
  "none", [
],
[
]),
("give_center_to_player", 4096, 
  "Your lord offers to extend your fiefs! {s1} sends word that he is willing to grant {s2} to you in payment for your loyal service, adding it to your holdings. What is your answer?", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(store_faction_of_party, ":party_faction_001", "$g_center_to_give_to_player"),
(faction_get_slot,":faction_slot_002",":party_faction_001",11),
(str_store_troop_name,s1,":faction_slot_002"),
(str_store_party_name,s2,"$g_center_to_give_to_player"),
],
[
]),
("give_center_to_player_2", 0, 
  "With a brief ceremony, you are officially confirmed as the new lord of {s2}{reg3? and its bound village {s4}:}. {reg3?They:It} will make a fine part of your fiefdom. You can now claim the rents and revenues from your personal estates there, draft soldiers from the populace, and manage the lands as you see fit. However, you are also expected to defend your fief and your people from harm, as well as maintaining the rule of law and order.", 
  "none", [
(str_store_party_name,s2,"$g_center_to_give_to_player"),
(assign,reg3,0),
(try_begin),
    (party_slot_eq,"$g_center_to_give_to_player",0,2),
    (try_for_range, ":p_001", ":p.village_1", ":p.salt_mine"),
        (try_begin),
            (party_slot_eq,":p_001",120,"$g_center_to_give_to_player"),
            (str_store_party_name,s4,":p_001"),
            (assign,reg3,1),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("oath_fulfilled", 0, 
  "You had a contract with {s1} to serve him for a certain duration. Your contract has now expired. What will you do?", 
  "none", [
(faction_get_slot,":faction_slot_001","$players_kingdom",11),
(str_store_troop_name,s1,":faction_slot_001"),
],
[
]),
("siege_started_defender", 0, 
  "{s1} is launching an assault against the walls of {s2}. You have {reg10} troops fit for battle against the enemy's {reg11}. You decide to...", 
  "none", [
(select_enemy,1),
(assign,"$g_enemy_party","$g_encountered_party_2"),
(assign,"$g_ally_party","$g_encountered_party"),
(str_store_party_name,s1,"$g_enemy_party"),
(str_store_party_name,s2,"$g_ally_party"),
(call_script, "script_encounter_calculate_fit"),
(try_begin),
    (eq,":::g_siege_first_encounter",1),
    (call_script, "script_let_nearby_parties_join_current_battle", 0, 1),
    (call_script, "script_encounter_init_variables"),
(try_end),
(try_begin),
    (eq,":::g_siege_first_encounter",0),
    (try_begin),
        (eq,1,1),
        (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
        (assign,":var001",reg0),
        (call_script, "script_party_count_members_with_full_health", "p_collective_friends"),
        (assign,":var002",reg0),
        (assign,":var003",0),
        (try_begin),
            (eq,":::g_battle_result",1),
            (eq,":var001",0),
            (assign,":var003",1),
        (else_try),
            (eq,":::g_engaged_enemy",1),
            (le,":::g_enemy_fit_for_battle",0),
            (ge,":::g_friend_fit_for_battle",1),
            (assign,":var003",1),
        (try_end),
        (try_begin),
            (this_or_next|eq,":var003",1),
            (eq,":::g_enemy_surrenders",1),
            (assign,"$g_next_menu",-1),
            (jump_to_menu,"mnu_total_victory"),
        (else_try),
            (assign,":var004",0),
            (try_begin),
                (this_or_next|eq,":::g_battle_result",-1),
                (troop_is_wounded,"trp_player"),
                (eq,":var002",0),
                (assign,":var004",1),
            (try_end),
        (try_end),
        (try_begin),
            (this_or_next|eq,":var004",1),
            (eq,":::g_player_surrenders",1),
            (assign,"$g_next_menu","mnu_captivity_start_under_siege_defeat"),
            (jump_to_menu,"mnu_total_defeat"),
        (else_try),
            (assign,":var005",0),
            (try_begin),
                (eq,":::g_battle_result",1),
                (assign,":var005",1),
            (else_try),
                (eq,":::g_battle_result",0),
                (store_div, ":var___x1", "$g_enemy_fit_for_battle", 3),
                (assign,":var006",":var___x1"),
                (try_begin),
                    (lt,":var006",":::g_friend_fit_for_battle"),
                    (assign,":var005",1),
                (else_try),
                    (store_random_in_range,":random_x_007",0,100),
                    (store_mul, ":var008", ":var002", 13),
                    (val_div, ":var008", 10),
                    (try_begin),
                        (ge,":var008",":var001"),
                        (lt,":random_x_007",10),
                        (neq,":::new_encounter",1),
                        (assign,":var005",1),
                    (try_end),
                (try_end),
            (try_end),
        (try_end),
        (try_begin),
            (eq,":var005",1),
            (party_get_slot,":party_slot_009","$g_encountered_party",65),
            (val_add, ":party_slot_009", 100),
            (party_set_slot,"$g_encountered_party",65,":party_slot_009"),
            (party_set_slot,"$g_enemy_party",2,1),
            (try_for_range, ":trp_010", ":trp.npc1", ":trp.knight_1_1_wife"),
                (try_begin),
                    (troop_slot_eq,":trp_010",2,2),
                    (neg|troop_slot_ge,":trp_010",8,0),
                    (troop_get_slot,":troop_slot_011",":trp_010",10),
                    (try_begin),
                        (gt,":troop_slot_011",0),
                        (party_slot_eq,":troop_slot_011",4,1),
                        (party_slot_eq,":troop_slot_011",5,"$g_encountered_party"),
                        (party_slot_eq,":troop_slot_011",8,1),
                        (call_script, "script_party_set_ai_state", ":troop_slot_011", -1, -1),
                        (call_script, "script_party_set_ai_state", ":troop_slot_011", 1, "$g_encountered_party"),
                    (try_end),
                (try_end),
            (try_end),
            (assign, reg0, ":"),
            (display_message, "@{reg0}"),
            (assign,"$g_battle_simulation_cancel_for_party","$g_encountered_party"),
            (leave_encounter),
            (change_screen_return),
            (assign,"$g_battle_simulation_auto_enter_town_after_battle","$g_encountered_party"),
        (try_end),
    (try_end),
(try_end),
(assign,"$g_siege_first_encounter",0),
(assign,"$new_encounter",0),
],
[
]),
("siege_join_defense", 512, 
  "{s4}^^Your casualties: {s8}^^Allies' casualties: {s9}^^Enemy casualties: {s10}", 
  "none", [
(try_begin),
    (eq,":::g_siege_join",1),
    (call_script, "script_party_calculate_strength", "p_main_party", 1),
    (assign,":var001",reg0),
    (val_div, ":var001", 5),
(else_try),
    (assign,":var001",0),
(try_end),
(call_script, "script_party_calculate_strength", "p_collective_ally", 0),
(assign,":var002",reg0),
(val_div, ":var002", 5),
(call_script, "script_party_calculate_strength", "p_collective_enemy", 0),
(assign,":var003",reg0),
(val_div, ":var003", 10),
(store_add, ":var004", ":var001", ":var002"),
(try_begin),
    (eq,":var004",0),
    (store_div, ":var___x1", ":var003", 2),
    (assign,":var005",":var___x1"),
(else_try),
    (assign,":var005",":var003"),
    (val_mul, ":var005", ":var001"),
    (val_div, ":var005", ":var004"),
(try_end),
(val_sub, ":var003", ":var005"),
(inflict_casualties_to_party_group, "p_main_party", ":var005", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s8,0),
(inflict_casualties_to_party_group, "$g_ally_party", ":var003", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s9,0),
(party_collect_attachments_to_party, "$g_ally_party", "p_collective_ally"),
(inflict_casualties_to_party_group, "$g_enemy_party", ":var004", "p_temp_casualties"),
(call_script, "script_print_casualties_to_s0", "p_temp_casualties", 0),
(str_store_string_reg,s10,0),
(party_collect_attachments_to_party, "$g_enemy_party", "p_collective_enemy"),
(try_begin),
    (eq,1,1),
    (call_script, "script_party_count_members_with_full_health", "p_main_party"),
    (try_begin),
        (le,reg0,0),
        (str_store_string,s4,"str_siege_defender_order_attack_failure"),
    (else_try),
        (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
        (try_begin),
            (le,reg0,0),
            (assign,"$g_battle_result",1),
            (str_store_string,s4,"str_siege_defender_order_attack_success"),
        (else_try),
            (str_store_string,s4,"str_siege_defender_order_attack_continue"),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("enter_your_own_castle", 0, 
  "{s10}", 
  "none", [
(try_begin),
    (neg|is_between,"$players_kingdom","fac_kingdom_1","fac_kingdoms_end"),
    (faction_get_slot,":faction_slot_001","fac_player_supporters_faction",11),
    (try_begin),
        (eq,":faction_slot_001","trp_player"),
        (str_store_string,s10,":"),
    (else_try),
        (str_store_string,s10,":"),
    (try_end),
(try_end),
(str_store_party_name,s2,"$current_town"),
],
[
]),
("village", 256, 
  "{s10} {s12}^{s11}^{s6}{s7}", 
  "none", [
(assign,"$current_town","$g_encountered_party"),
(call_script, "script_update_center_recon_notes", "$current_town"),
(assign,"$g_defending_against_siege",0),
(assign,"$g_battle_result",0),
(assign,"$qst_collect_taxes_currently_collecting",0),
(assign,"$qst_train_peasants_against_bandits_currently_training",0),
(try_begin),
    (gt,":::auto_enter_in_center",0),
    (jump_to_menu,"$auto_enter_in_center"),
    (assign,"$auto_enter_in_center",0),
(try_end),
(try_begin),
    (neq,":::g_player_raiding_village",":::current_town"),
    (assign,"$g_player_raiding_village",0),
(else_try),
    (jump_to_menu,"mnu_village_loot_continue"),
(try_end),
(try_begin),
    (eq,":::g_town_visit_after_rest",1),
    (assign,"$g_town_visit_after_rest",0),
(try_end),
(str_store_party_name,s2,"$current_town"),
(party_get_slot,":party_slot_001","$current_town",7),
(store_faction_of_party, ":party_faction_002", "$current_town"),
(str_store_faction_name,s9,":party_faction_002"),
(try_begin),
    (ge,":party_slot_001",0),
    (str_store_troop_name,s8,":party_slot_001"),
    (str_store_string,s7,"@{s8} of {s9}"),
(try_end),
(str_clear, 10),
(str_clear, 12),
(try_begin),
    (neg|party_slot_eq,"$current_town",35,2),
    (str_store_string,s60,2),
    (party_get_slot,":party_slot_003","$current_town",50),
    (try_begin),
        (eq,":::cheat_mode",1),
        (assign,reg4,":party_slot_003"),
        (display_message, "@@{!}Prosperity: {reg4}"),
    (try_end),
    (store_div, ":var___x1", ":party_slot_003", 10),
    (assign,":var004",":var___x1"),
    (val_min,":var004",9),
    (assign,":var004 +","str_village_prosperity_0"),
    (str_store_string,s10,":var004"),
    (store_div, ":var___x1", ":party_slot_003", 20),
    (assign,":var004",":var___x1"),
    (val_min,":var004",4),
    (try_begin),
        (is_between,"$current_town","p_village_91","p_salt_mine"),
        (assign,":var004 +","str_oasis_village_alt_prosperity_0"),
    (else_try),
        (assign,":var004 +","str_village_alt_prosperity_0"),
    (try_end),
    (str_store_string,s12,":var004"),
(try_end),
(str_clear, 11),
(try_begin),
    (party_slot_eq,"$current_town",35,2),
(else_try),
    (eq,":party_slot_001","trp_player"),
    (str_store_string,s11,":"),
(else_try),
    (ge,":party_slot_001",0),
    (str_store_string,s11,":"),
(else_try),
    (str_store_string,s11,":"),
(try_end),
(str_clear, 7),
(try_begin),
    (neg|party_slot_eq,"$current_town",35,2),
    (party_get_slot,":party_slot_005","$current_town",26),
    (call_script, "script_describe_center_relation_to_s3", ":party_slot_005"),
    (assign,reg9,":party_slot_005"),
    (str_store_string,s7,":"),
(try_end),
(str_clear, 6),
(try_begin),
    (party_slot_ge,"$current_town",39,1),
    (party_get_slot,":party_slot_006","$current_town",39),
    (store_character_level,":character_lvl_007","trp_player"),
    (store_add, "$qst_eliminate_bandits_infesting_village_num_bandits", ":character_lvl_007", 10),
    (val_mul, ":::qst_eliminate_bandits_infesting_village_num_bandits", 12),
    (val_div, ":::qst_eliminate_bandits_infesting_village_num_bandits", 10),
    (store_random_in_range,"$qst_eliminate_bandits_infesting_village_num_villagers",25,30),
    (assign,reg8,"$qst_eliminate_bandits_infesting_village_num_bandits"),
    (str_store_troop_name_by_count,s35,":party_slot_006","$qst_eliminate_bandits_infesting_village_num_bandits"),
    (str_store_string,s6,":"),
    (assign,"$g_enemy_party",-1),
    (assign,"$g_ally_party",-1),
    (try_begin),
        (eq,":party_slot_006","trp_forest_bandit"),
        (set_background_mesh, "mesh_pic_forest_bandits"),
    (else_try),
        (eq,":party_slot_006","trp_steppe_bandit"),
        (set_background_mesh, "mesh_pic_steppe_bandits"),
    (else_try),
        (eq,":party_slot_006","trp_taiga_bandit"),
        (set_background_mesh, "mesh_pic_steppe_bandits"),
    (else_try),
        (eq,":party_slot_006","trp_mountain_bandit"),
        (set_background_mesh, "mesh_pic_mountain_bandits"),
    (else_try),
        (eq,":party_slot_006","trp_sea_raider"),
        (set_background_mesh, "mesh_pic_sea_raiders"),
    (else_try),
        (set_background_mesh, "mesh_pic_bandits"),
    (try_end),
(else_try),
    (party_slot_eq,"$current_town",35,2),
    (str_store_string,s6,":"),
    (try_begin),
        (neq,":::g_player_raid_complete",1),
        (play_track,1),
    (try_end),
    (set_background_mesh, "mesh_pic_looted_village"),
(else_try),
    (party_slot_eq,"$current_town",35,1),
    (str_store_string,s6,":"),
(else_try),
    (party_get_current_terrain,":party_cur_terrain_008","$current_town"),
    (try_begin),
        (this_or_next|eq,":party_cur_terrain_008",13),
        (this_or_next|eq,":party_cur_terrain_008",5),
        (this_or_next|eq,":party_cur_terrain_008",10),
        (eq,":party_cur_terrain_008",2),
        (set_background_mesh, "mesh_pic_village_s"),
    (else_try),
        (this_or_next|eq,":party_cur_terrain_008",12),
        (eq,":party_cur_terrain_008",4),
        (set_background_mesh, "mesh_pic_village_w"),
    (else_try),
        (set_background_mesh, "mesh_pic_village_p"),
    (try_end),
(try_end),
(try_begin),
    (eq,":::g_player_raid_complete",1),
    (assign,"$g_player_raid_complete",0),
    (jump_to_menu,"mnu_village_loot_complete"),
(else_try),
    (party_get_slot,":party_slot_009","$current_town",34),
    (try_begin),
        (gt,":party_slot_009",0),
    (try_end),
(try_end),
(try_begin),
    (eq,":::g_leave_town",1),
    (assign,"$g_leave_town",0),
    (change_screen_return),
(try_end),
(try_begin),
    (eq,1,1),
    (store_time_of_day,":cur_time_of_day_010"),
    (try_begin),
        (ge,":cur_time_of_day_010",5),
        (lt,":cur_time_of_day_010",21),
        (assign,"$town_nighttime",0),
    (else_try),
        (assign,"$town_nighttime",1),
    (try_end),
(try_end),
],
[
]),
("village_hostile_action", 0, 
  "What action do you have in mind?", 
  "none", [
],
[
]),
("recruit_volunteers", 0, 
  "{s18}", 
  "none", [
(party_get_slot,":party_slot_001","$current_town",92),
(party_get_slot,":party_slot_002","$current_town",93),
(party_get_free_companions_capacity,":party_free_companions_capacity_003","p_main_party"),
(store_troop_gold,":troop_gold_004","trp_player"),
(store_div, ":var___x1", ":troop_gold_004", 10),
(assign,":var005",":var___x1"),
(assign,":var006",":party_free_companions_capacity_003"),
(val_min,":var006",":var005"),
(try_begin),
    (gt,":var006",0),
    (val_min,":party_slot_002",":var006"),
(try_end),
(assign,reg5,":party_slot_002"),
(assign,reg7,0),
(try_begin),
    (gt,":party_slot_002",":var005"),
    (assign,reg7,1),
(try_end),
(try_begin),
    (eq,":party_slot_002",0),
    (str_store_string,s18,":"),
(else_try),
    (store_mul, ":reg6", ":party_slot_002", 10),
    (str_store_troop_name_by_count,s3,":party_slot_001",":party_slot_002"),
    (try_begin),
        (eq,reg5,1),
        (str_store_string,s18,":"),
    (else_try),
        (str_store_string,s18,":"),
    (try_end),
    (set_background_mesh, "mesh_pic_recruits"),
(try_end),
],
[
]),
("village_hunt_down_fugitive_defeated", 0, 
  "A heavy blow from the fugitive sends you to the ground, and your vision spins and goes dark. Time passes. When you open your eyes again you find yourself battered and bloody, but luckily none of the wounds appear to be lethal.", 
  "none", [
],
[
]),
("village_infest_bandits_result", 4096, 
  "{s9}", 
  "none", [
(try_begin),
    (eq,":::g_battle_result",1),
    (jump_to_menu,"mnu_village_infestation_removed"),
(else_try),
    (str_store_string,s9,":"),
    (set_background_mesh, "mesh_pic_looted_village"),
(try_end),
],
[
]),
("village_infestation_removed", 512, 
  "In a battle worthy of song, you and your men drive the bandits out of the village, making it safe once more. The villagers have little left in the way of wealth after their ordeal, but they offer you all they can find.", 
  "none", [
(party_get_slot,":party_slot_001","$g_encountered_party",39),
(party_set_slot,"$g_encountered_party",39,0),
(party_clear,"p_temp_party"),
(party_add_members,"p_temp_party",":party_slot_001","$qst_eliminate_bandits_infesting_village_num_bandits"),
(assign,"$g_strength_contribution_of_player",50),
(call_script, "script_party_give_xp_and_gold", "p_temp_party"),
(try_begin),
    (check_quest_active,"qst_eliminate_bandits_infesting_village"),
    (quest_slot_eq,"qst_eliminate_bandits_infesting_village",1,"$g_encountered_party"),
    (call_script, "script_end_quest", "qst_eliminate_bandits_infesting_village"),
    (call_script, "script_change_player_relation_with_center", "$g_encountered_party", 5),
(else_try),
    (check_quest_active,"qst_deal_with_bandits_at_lords_village"),
    (quest_slot_eq,"qst_deal_with_bandits_at_lords_village",1,"$g_encountered_party"),
    (call_script, "script_succeed_quest", "qst_deal_with_bandits_at_lords_village"),
    (call_script, "script_change_player_relation_with_center", "$g_encountered_party", 3),
(else_try),
    (call_script, "script_change_player_relation_with_center", "$g_encountered_party", 4),
(try_end),
(party_get_slot,":party_slot_002","$current_town",25),
(try_for_range, ":inventory_slot_no_003", 10, 106),
    (store_random_in_range,":random_x_004",0,100),
    (try_begin),
        (lt,":random_x_004",70),
        (troop_set_inventory_slot,":party_slot_002",":inventory_slot_no_003",-1),
    (try_end),
(try_end),
],
[
]),
("center_manage", 0, 
  "{s19}^{reg6?^^You are currently building {s7}. The building will be completed after {reg8} day{reg9?s:}.:}", 
  "none", [
(assign,":var001",0),
(str_clear, 18),
(try_begin),
    (party_slot_eq,"$g_encountered_party",0,4),
    (assign,":var002",130),
    (assign,":var003",135),
    (str_store_string,s17,"@village"),
(else_try),
    (assign,":var002",134),
    (assign,":var003",136),
    (try_begin),
        (party_slot_eq,"$g_encountered_party",0,3),
        (str_store_string,s17,"@town"),
    (else_try),
        (str_store_string,s17,"@castle"),
    (try_end),
(try_end),
(try_for_range, ":var004", ":var002", ":var003"),
    (try_begin),
        (party_slot_ge,"$g_encountered_party",":var004",1),
        (val_add, ":var001", 1),
        (call_script, "script_get_improvement_details", ":var004"),
        (try_begin),
            (eq,":var001",1),
            (str_store_string,s18,"@{!}{s0}"),
        (else_try),
            (str_store_string,s18,"@{!}{s18}, {s0}"),
        (try_end),
    (try_end),
(try_end),
(try_begin),
    (eq,":var001",0),
    (str_store_string,s19,":"),
(else_try),
    (str_store_string,s19,":"),
(try_end),
(assign,reg6,0),
(try_begin),
    (eq,1,1),
    (party_get_slot,":party_slot_005","$g_encountered_party",124),
    (try_begin),
        (gt,":party_slot_005",0),
        (call_script, "script_get_improvement_details", ":party_slot_005"),
        (str_store_string,s7,0),
        (assign,reg6,1),
        (store_current_hours,":cur_hours_006"),
        (party_get_slot,":party_slot_007","$g_encountered_party",125),
        (val_sub, ":party_slot_007", ":cur_hours_006"),
        (store_div, ":var___x1", ":party_slot_007", 24),
        (assign,reg8,":var___x1"),
        (val_max,reg8,1),
        (store_sub, reg9, reg8, 1),
    (try_end),
(try_end),
],
[
]),
("center_improve", 0, 
  "{s19} As the party member with the highest engineer skill ({reg2}), {reg3?you reckon:{s3} reckons} that building the {s4} will cost you {reg5} denars and will take {reg6} days.", 
  "none", [
(call_script, "script_get_improvement_details", "$g_improvement_type"),
(assign,":var001",reg0),
(str_store_string,s4,0),
(str_store_string,s19,1),
(call_script, "script_get_max_skill_of_player_party", "skl_engineer"),
(assign,":var002",reg0),
(assign,":var003",reg1),
(assign,reg2,":var002"),
(store_sub, ":var004", 20, ":var002"),
(val_mul, ":var001", ":var004"),
(val_div, ":var001", 20),
(store_div, ":var___x1", ":var001", 100),
(assign,":var005",":var___x1"),
(val_add, ":var005", 3),
(assign,reg5,":var001"),
(assign,reg6,":var005"),
(try_begin),
    (eq,":var003","trp_player"),
    (assign,reg3,1),
(else_try),
    (assign,reg3,0),
    (str_store_troop_name,s3,":var003"),
(try_end),
],
[
]),
("town_bandits_failed", 512, 
  "{s4} {s5}", 
  "none", [
(store_troop_gold,":troop_gold_001","trp_player"),
(store_div, ":var___x1", ":troop_gold_001", 30),
(assign,":gold_002",":var___x1"),
(store_random_in_range,":random_x_003",40,100),
(val_add, ":gold_002", ":random_x_003"),
(val_min,":gold_002",":troop_gold_001"),
(troop_remove_gold,"trp_player",":gold_002"),
(party_set_slot,"$current_town",155,0),
(party_get_num_companions,":party_num_companions_004","p_main_party"),
(str_store_string,s4,":"),
(str_store_string,s4,":"),
(try_begin),
    (gt,":party_num_companions_004",2),
    (str_store_string,s5,":"),
(else_try),
    (str_store_string,s5,":"),
(try_end),
],
[
]),
("town_bandits_succeeded", 512, 
  "The bandits fall before you as wheat to a scythe! Soon you stand alone in the streets while most of your attackers lie unconscious, dead or dying. Searching the bodies, you find a purse which must have belonged to a previous victim of these brutes. Or perhaps, it was given to them by someone who wanted to arrange a suitable ending to your life.", 
  "none", [
(party_set_slot,"$current_town",155,0),
(assign,"$g_last_defeated_bandits_town","$g_encountered_party"),
(try_begin),
    (check_quest_active,"qst_deal_with_night_bandits"),
    (neg|check_quest_succeeded,"qst_deal_with_night_bandits"),
    (quest_slot_eq,"qst_deal_with_night_bandits",1,"$g_encountered_party"),
    (call_script, "script_succeed_quest", "qst_deal_with_night_bandits"),
(try_end),
(store_mul, ":var001", "$num_center_bandits", 117),
(add_xp_to_troop,":var001","trp_player"),
(store_mul, ":var002", "$num_center_bandits", 50),
(call_script, "script_troop_add_gold", "trp_player", ":var002"),
],
[
]),
("village_steal_cattle_confirm", 0, 
  "As the party member with the highest looting skill ({reg2}), {reg3?you reckon:{s1} reckons} that you can steal as many as {reg4} heads of village's cattle.", 
  "none", [
(call_script, "script_get_max_skill_of_player_party", "skl_looting"),
(assign,reg2,reg0),
(assign,":var001",reg1),
(try_begin),
    (eq,":var001","trp_player"),
    (assign,reg3,1),
(else_try),
    (assign,reg3,0),
    (str_store_troop_name,s1,":var001"),
(try_end),
(call_script, "script_calculate_amount_of_cattle_can_be_stolen", "$current_town"),
(assign,reg4,reg0),
],
[
]),
("village_steal_cattle", 512, 
  "{s1}", 
  "none", [
(call_script, "script_calculate_amount_of_cattle_can_be_stolen", "$current_town"),
(assign,":var001",reg0),
(val_add, ":var001", 1),
(store_random_in_range,":random_x_002",0,":var001"),
(party_set_slot,"$current_town",46,1),
(party_get_slot,":party_slot_003","$current_town",7),
(try_begin),
    (le,":random_x_002",0),
    (call_script, "script_change_player_relation_with_center", "$current_town", -3),
    (str_store_string,s1,":"),
(else_try),
    (assign,reg17,":random_x_002"),
    (store_sub, reg12, ":random_x_002", 1),
    (try_begin),
        (gt,":party_slot_003",0),
        (call_script, "script_change_player_relation_with_troop", ":party_slot_003", -3),
        (call_script, "script_add_log_entry", 66, "trp_player", "$current_town", ":party_slot_003", "$g_encountered_x_party_faction"),
    (try_end),
    (call_script, "script_change_player_relation_with_center", "$current_town", -5),
    (str_store_string,s1,":"),
    (try_begin),
        (eq,":random_x_002",3),
        (unlock_achievement, 31),
    (try_end),
    (call_script, "script_create_cattle_herd", "$current_town", ":random_x_002"),
    (party_get_slot,":party_slot_004","$current_town",205),
    (val_sub, ":party_slot_004", ":random_x_002"),
    (party_set_slot,"$current_town",205,":party_slot_004"),
(try_end),
],
[
]),
("village_take_food_confirm", 0, 
  "It will be difficult to force and threaten the peasants into giving their precious supplies. You think you will need at least one hour.", 
  "none", [
],
[
]),
("village_take_food", 0, 
  "The villagers grudgingly bring out what they have for you.", 
  "none", [
(call_script, "script_party_count_members_with_full_health", "p_main_party"),
(assign,":var001",reg0),
(call_script, "script_party_count_members_with_full_health", "$current_town"),
(assign,":var002",reg0),
(try_begin),
    (lt,":var001",6),
    (ge,":var002",40),
    (neg|party_slot_eq,"$current_town",7,"trp_player"),
    (jump_to_menu,"mnu_village_start_attack"),
(try_end),
],
[
]),
("village_start_attack", 4608, 
  "Some of the angry villagers grab their tools and prepare to resist you. It looks like you'll have a fight on your hands if you continue.", 
  "none", [
(set_background_mesh, "mesh_pic_villageriot"),
(call_script, "script_party_count_members_with_full_health", "p_main_party"),
(assign,":var001",reg0),
(call_script, "script_party_count_members_with_full_health", "$current_town"),
(assign,":var002",reg0),
(try_begin),
    (gt,":var001",25),
    (jump_to_menu,"mnu_village_loot_no_resist"),
(else_try),
    (this_or_next|eq,":var002",0),
    (eq,":::g_battle_result",1),
    (try_begin),
        (eq,":::g_battle_result",1),
        (store_random_in_range,":random_x_003",-30,-15),
        (call_script, "script_change_player_relation_with_center", "$current_town", ":random_x_003"),
        (party_get_slot,":party_slot_004","$current_town",7),
        (try_begin),
            (gt,":party_slot_004",0),
            (call_script, "script_change_player_relation_with_troop", ":party_slot_004", -3),
        (try_end),
    (try_end),
    (jump_to_menu,"mnu_village_loot_no_resist"),
(else_try),
    (eq,":::g_battle_result",-1),
    (jump_to_menu,"mnu_village_loot_defeat"),
(try_end),
],
[
]),
("village_loot_no_resist", 0, 
  "The villagers here are few and frightened, and they quickly scatter and run before you. The village is at your mercy.", 
  "none", [
],
[
]),
("village_loot_complete", 512, 
  "On your orders your troops sack the village, pillaging everything of any value, and then put the buildings to the torch. From the coins and valuables that are found, you get your share of {reg1} denars.", 
  "none", [
(get_achievement_stat, ":var001", 30, 0),
(get_achievement_stat, ":var002", 30, 1),
(val_add, ":var001", 1),
(set_achievement_stat, 30, 0, ":var001"),
(try_begin),
    (ge,":var001",3),
    (ge,":var002",3),
    (unlock_achievement, 30),
(try_end),
(party_get_slot,":party_slot_003","$current_town",7),
(try_begin),
    (gt,":party_slot_003",0),
    (call_script, "script_change_player_relation_with_troop", ":party_slot_003", -5),
(try_end),
(store_random_in_range,":random_x_004",-35,-25),
(call_script, "script_change_player_relation_with_center", "$current_town", ":random_x_004"),
(store_faction_of_party, ":party_faction_005", "$current_town"),
(store_relation,":faction_relation_006",":party_faction_005","fac_player_supporters_faction"),
(try_begin),
    (lt,":faction_relation_006",0),
    (call_script, "script_change_player_relation_with_faction", ":party_faction_005", -3),
(try_end),
(assign,":var007",50),
(party_get_slot,":party_slot_008","$current_town",50),
(store_mul, ":var009", ":party_slot_008", 5),
(val_add, ":var007", ":var009"),
(call_script, "script_troop_add_gold", "trp_player", ":var007"),
(assign,":var010",3),
(store_div, ":var___x1", ":var007", 100),
(assign,":var011",":var___x1"),
(val_add, ":var010", ":var011"),
(call_script, "script_change_player_party_morale", ":var010"),
(faction_get_slot,":faction_slot_012",":party_faction_005",99),
(store_mul, ":var013", ":var010", 200),
(val_sub, ":faction_slot_012", ":var013"),
(faction_set_slot,":party_faction_005",99,":faction_slot_012"),
(call_script, "script_objectionable_action", 3, "str_loot_village"),
(assign,reg1,":var007"),
],
[
]),
("village_loot_defeat", 4096, 
  "Fighting with courage and determination, the villagers manage to hold together and drive off your forces.", 
  "none", [
(set_background_mesh, "mesh_pic_villageriot"),
],
[
]),
("village_loot_continue", 0, 
  "Do you wish to continue looting this village?", 
  "none", [
],
[
]),
("close", 0, 
  "Nothing.", 
  "none", [
(change_screen_return),
],
[
]),
("town", 4352, 
  "{s10} {s14}^{s11}{s12}{s13}", 
  "none", [
(try_begin),
    (eq,":::sneaked_into_town",1),
    (call_script, "script_music_set_situation_with_culture", 16384),
(else_try),
    (call_script, "script_music_set_situation_with_culture", 65536),
(try_end),
(store_encountered_party,"$current_town"),
(call_script, "script_update_center_recon_notes", "$current_town"),
(assign,"$g_defending_against_siege",0),
(str_clear, 3),
(party_get_battle_opponent, ":party_battle_opponent_001", "$current_town"),
(store_faction_of_party, ":party_faction_002", "$g_encountered_party"),
(store_relation,":faction_relation_003",":party_faction_002","fac_player_supporters_faction"),
(try_begin),
    (gt,":party_battle_opponent_001",0),
    (ge,":faction_relation_003",0),
    (store_faction_of_party, ":party_faction_004", ":party_battle_opponent_001"),
    (store_relation,":faction_relation_005",":party_faction_004","fac_player_supporters_faction"),
    (try_begin),
        (lt,":faction_relation_005",0),
        (assign,"$g_defending_against_siege",1),
        (assign,"$g_siege_first_encounter",1),
        (jump_to_menu,"mnu_siege_started_defender"),
    (try_end),
(try_end),
(try_begin),
    (is_between,"$g_encountered_party","p_town_1","p_castle_1"),
    (store_sub, ":var006", "$g_encountered_party", ":p.town_1"),
    (set_achievement_stat, 26, ":var006", 1),
    (assign,":var007",0),
    (try_for_range, ":p_008", ":p.town_1", ":p.castle_1"),
        (store_sub, ":var006", ":p_008", ":p.town_1"),
        (get_achievement_stat, ":var009", 26, ":var006"),
        (try_begin),
            (eq,":var009",0),
            (assign,":var007",1),
        (try_end),
    (try_end),
    (try_begin),
        (eq,":var007",0),
        (unlock_achievement, 26),
    (try_end),
(try_end),
(assign,"$qst_collect_taxes_currently_collecting",0),
(try_begin),
    (gt,":::quest_auto_menu",0),
    (jump_to_menu,"$quest_auto_menu"),
    (assign,"$quest_auto_menu",0),
(try_end),
(try_begin),
    (eq,":::g_town_assess_trade_goods_after_rest",1),
    (assign,"$g_town_assess_trade_goods_after_rest",0),
    (jump_to_menu,"mnu_town_trade_assessment"),
(try_end),
(assign,"$talk_context",0),
(assign,"$all_doors_locked",0),
(try_begin),
    (eq,":::g_town_visit_after_rest",1),
    (assign,"$g_town_visit_after_rest",0),
    (assign,"$town_entered",1),
(try_end),
(try_begin),
    (eq,":::g_leave_town",1),
    (assign,"$g_leave_town",0),
    (assign,"$g_permitted_to_center",0),
    (leave_encounter),
    (change_screen_return),
(try_end),
(str_store_party_name,s2,"$current_town"),
(party_get_slot,":party_slot_010","$current_town",7),
(store_faction_of_party, ":party_faction_011", "$current_town"),
(str_store_faction_name,s9,":party_faction_011"),
(try_begin),
    (ge,":party_slot_010",0),
    (str_store_troop_name,s8,":party_slot_010"),
    (str_store_string,s7,"@{s8} of {s9}"),
(try_end),
(try_begin),
    (party_slot_eq,"$current_town",0,3),
    (str_store_string,s60,2),
    (party_get_slot,":party_slot_012","$current_town",50),
    (try_begin),
        (ge,":::cheat_mode",1),
        (assign,reg4,":party_slot_012"),
        (display_message, "@@{!}DEBUG -- Prosperity: {reg4}"),
    (try_end),
    (store_div, ":var___x1", ":party_slot_012", 10),
    (assign,":var013",":var___x1"),
    (val_min,":var013",9),
    (assign,":var013 +","str_town_prosperity_0"),
    (str_store_string,s10,":var013"),
    (store_div, ":var___x1", ":party_slot_012", 20),
    (assign,":var013",":var___x1"),
    (val_min,":var013",4),
    (assign,":var013 +","str_town_alt_prosperity_0"),
    (str_store_string,s14,":var013"),
(else_try),
    (str_clear, 14),
    (str_store_string,s10,":"),
(try_end),
(try_begin),
    (party_slot_eq,"$current_town",0,2),
    (try_begin),
        (eq,":party_slot_010","trp_player"),
        (str_store_string,s11,":"),
    (else_try),
        (gt,":party_slot_010",-1),
        (troop_slot_eq,":party_slot_010",30,"trp_player"),
        (str_store_string,s11,"str__you_see_the_banner_of_your_wifehusband_s7_over_the_castle_gate"),
    (else_try),
        (ge,":party_slot_010",0),
        (str_store_string,s11,":"),
    (else_try),
        (str_store_string,s11,":"),
    (try_end),
(else_try),
    (try_begin),
        (eq,":party_slot_010","trp_player"),
        (str_store_string,s11,":"),
    (else_try),
        (gt,":party_slot_010",-1),
        (troop_slot_eq,":party_slot_010",30,"trp_player"),
        (str_store_string,s11,"str__the_banner_of_your_wifehusband_s7_flies_over_the_town_gates"),
    (else_try),
        (ge,":party_slot_010",0),
        (str_store_string,s11,":"),
    (else_try),
        (str_store_string,s11,":"),
    (try_end),
(try_end),
(str_clear, 12),
(try_begin),
    (party_slot_eq,"$current_town",0,3),
    (party_get_slot,":party_slot_014","$current_town",26),
    (call_script, "script_describe_center_relation_to_s3", ":party_slot_014"),
    (assign,reg9,":party_slot_014"),
    (str_store_string,s12,":"),
(try_end),
(str_clear, 13),
(try_begin),
    (gt,":::entry_to_town_forbidden",0),
    (str_store_string,s13,":"),
(else_try),
    (faction_slot_eq,":party_faction_011",4,6),
    (faction_slot_eq,":party_faction_011",5,"$current_town"),
    (str_store_string,s13,"str__the_lord_is_currently_holding_a_feast_in_his_hall"),
(try_end),
(try_begin),
    (eq,1,1),
    (store_time_of_day,reg12),
    (try_begin),
        (ge,reg12,5),
        (lt,reg12,21),
        (assign,"$town_nighttime",0),
    (else_try),
        (assign,"$town_nighttime",1),
        (try_begin),
            (party_slot_eq,"$current_town",0,3),
            (str_store_string,s13,"str_town_nighttime"),
        (try_end),
    (try_end),
(try_end),
(try_begin),
    (party_slot_ge,"$current_town",156,1),
    (neg|is_currently_night),
    (party_set_slot,"$current_town",156,1),
    (str_store_string,s13,":"),
(try_end),
(assign,"$castle_undefended",0),
(party_get_num_companions,":party_num_companions_015","p_collective_enemy"),
(try_begin),
    (eq,":party_num_companions_015",0),
    (assign,"$castle_undefended",1),
(try_end),
(call_script, "script_set_town_picture"),
],
[
]),
("cannot_enter_court", 0, 
  "There is a feast in progress in the lord's hall, but you are not of sufficient status to be invited inside. Perhaps increasing your renown would win you admittance -- or you might also try distinguishing yourself at a tournament while the feast is in progress...", 
  "none", [
],
[
]),
("lady_visit", 0, 
  "Whom do you wish to visit?", 
  "none", [
],
[
]),
("town_tournament_lost", 0, 
  "You have been eliminated from the tournament.{s8}", 
  "none", [
(str_clear, 8),
(try_begin),
    (this_or_next|eq,":::players_kingdom",":::g_encountered_x_party_faction"),
    (neg|troop_slot_ge,"trp_player",7,50),
    (neg|troop_slot_ge,"trp_player",7,125),
    (gt,":::g_player_tournament_placement",4),
    (faction_slot_eq,"$g_encountered_x_party_faction",4,6),
    (faction_slot_eq,"$g_encountered_x_party_faction",5,"$g_encountered_party"),
    (str_store_string,s8,"str__however_you_have_sufficiently_distinguished_yourself_to_be_invited_to_attend_the_ongoing_feast_in_the_lords_castle"),
(try_end),
],
[
]),
("town_tournament_won", 512, 
  "You have won the tournament of {s3}! You are filled with pride as the crowd cheers your name. In addition to honour, fame and glory, you earn a prize of {reg9} denars. {s8}", 
  "none", [
(str_store_party_name,s3,"$current_town"),
(call_script, "script_change_troop_renown", "trp_player", 20),
(call_script, "script_change_player_relation_with_center", "$current_town", 1),
(assign,reg9,200),
(add_xp_to_troop,250,"trp_player"),
(call_script, "script_troop_add_gold", "trp_player", reg9),
(str_clear, 8),
(store_add, ":gold_001", "$g_tournament_bet_placed", "$g_tournament_bet_win_amount"),
(try_begin),
    (gt,":::g_tournament_bet_win_amount",0),
    (assign,reg8,":gold_001"),
    (str_store_string,s8,":"),
(try_end),
(try_begin),
    (this_or_next|eq,":::players_kingdom",":::g_encountered_x_party_faction"),
    (neg|troop_slot_ge,"trp_player",7,70),
    (neg|troop_slot_ge,"trp_player",7,145),
    (faction_slot_eq,"$g_encountered_x_party_faction",4,6),
    (faction_slot_eq,"$g_encountered_x_party_faction",5,"$g_encountered_party"),
    (str_store_string,s8,"str_s8_you_are_also_invited_to_attend_the_ongoing_feast_in_the_castle"),
(try_end),
(call_script, "script_troop_add_gold", "trp_player", ":gold_001"),
(assign,":var002",0),
(store_div, ":var___x1", "$g_tournament_bet_win_amount", 5),
(assign,":var002",":var___x1"),
(party_get_slot,":party_slot_003","$current_town",51),
(val_sub, ":party_slot_003", ":var002"),
(val_max,":party_slot_003",250),
(party_set_slot,"$current_town",51,":party_slot_003"),
(call_script, "script_play_victorious_sound"),
(unlock_achievement, 33),
],
[
]),
("town_tournament_won_by_another", 512, 
  "As the only {reg3?fighter:man} to remain undefeated this day, {s1} wins the lists and the glory of this tournament.", 
  "none", [
(call_script, "script_get_num_tournament_participants"),
(store_sub, ":var001", reg0, 1),
(try_begin),
    (troop_slot_eq,"trp_tournament_participants",0,0),
    (troop_set_slot,"trp_tournament_participants",0,-1),
    (val_sub, ":var001", 1),
(try_end),
(call_script, "script_remove_tournament_participants_randomly", ":var001"),
(call_script, "script_sort_tournament_participant_troops"),
(troop_get_slot,":troop_slot_002","trp_tournament_participants",0),
(str_store_troop_name,s1,":troop_slot_002"),
(try_begin),
    (troop_is_hero,":troop_slot_002"),
    (call_script, "script_change_troop_renown", ":troop_slot_002", 20),
(try_end),
(troop_get_type,reg3,":troop_slot_002"),
],
[
]),
("town_tournament", 512, 
  "{s1}You are at tier {reg0} of the tournament, with {reg1} participants remaining. In the next round, there will be {reg2} teams with {reg3} {reg4?fighters:fighter} each.", 
  "none", [
(party_set_slot,"$current_town",156,0),
(call_script, "script_sort_tournament_participant_troops"),
(call_script, "script_get_num_tournament_participants"),
(assign,":var001",reg0),
(try_begin),
    (neg|troop_slot_eq,"trp_tournament_participants",0,0),
    (assign,":var002",0),
    (store_div, ":var___x1", "$g_tournament_bet_placed", 5),
    (assign,":var002",":var___x1"),
    (party_get_slot,":party_slot_003","$current_town",51),
    (val_add, ":party_slot_003", ":var002"),
    (val_min,":party_slot_003",4000),
    (party_set_slot,"$current_town",51,":party_slot_003"),
    (jump_to_menu,"mnu_town_tournament_lost"),
(else_try),
    (eq,":var001",1),
    (jump_to_menu,"mnu_town_tournament_won"),
(else_try),
    (try_begin),
        (le,":::g_tournament_next_num_teams",0),
        (call_script, "script_get_random_tournament_team_amount_and_size"),
        (assign,"$g_tournament_next_num_teams",reg0),
        (assign,"$g_tournament_next_team_size",reg1),
    (try_end),
    (assign,reg2,"$g_tournament_next_num_teams"),
    (assign,reg3,"$g_tournament_next_team_size"),
    (store_sub, reg4, reg3, 1),
    (str_clear, 1),
    (try_begin),
        (eq,":::g_tournament_player_team_won",1),
        (str_store_string,s1,":"),
    (else_try),
        (eq,":::g_tournament_player_team_won",0),
        (str_store_string,s1,":"),
    (try_end),
    (assign,reg1,":var001"),
    (store_add, reg0, "$g_tournament_cur_tier", 1),
(try_end),
],
[
]),
("tournament_withdraw_verify", 0, 
  "Are you sure you want to withdraw from the tournament?", 
  "none", [
],
[
]),
("tournament_bet", 0, 
  "The odds against you are {reg5} to {reg6}.{reg1? You have already bet {reg1} denars on yourself, and if you win, you will earn {reg2} denars.:} How much do you want to bet?", 
  "none", [
(assign,reg1,"$g_tournament_bet_placed"),
(store_add, reg2, "$g_tournament_bet_win_amount", "$g_tournament_bet_placed"),
(call_script, "script_get_win_amount_for_tournament_bet"),
(assign,":var001",reg0),
(assign,":var002",100000),
(assign,":var003",1),
(assign,":var004",1),
(try_for_range, ":var005", 1, 50),
    (try_for_range, ":var006", 1, 50),
        (store_mul, ":var007", 100, ":var005"),
        (val_div, ":var007", ":var006"),
        (store_sub, ":var008", ":var001", ":var007"),
        (val_abs,":var008"),
        (try_begin),
            (lt,":var008",":var002"),
            (assign,":var002",":var008"),
            (assign,":var003",":var006"),
            (assign,":var004",":var005"),
        (try_end),
    (try_end),
(try_end),
(assign,reg5,":var004"),
(assign,reg6,":var003"),
],
[
]),
("tournament_bet_confirm", 0, 
  "If you bet {reg1} denars, you will earn {reg2} denars if you win the tournament. Is that all right?", 
  "none", [
(call_script, "script_get_win_amount_for_tournament_bet"),
(assign,":var001",reg0),
(val_mul, ":var001", ":::temp"),
(val_div, ":var001", 100),
(assign,reg1,"$temp"),
(assign,reg2,":var001"),
],
[
]),
("tournament_participants", 0, 
  "You ask one of the criers for the names of the tournament participants. They are:^{s11}", 
  "none", [
(str_clear, 11),
(call_script, "script_sort_tournament_participant_troops"),
(call_script, "script_get_num_tournament_participants"),
(assign,":var001",reg0),
(try_for_range, ":slot_no_002", 0, ":var001"),
    (troop_get_slot,":troop_slot_003","trp_tournament_participants",":slot_no_002"),
    (str_store_troop_name,s12,":troop_slot_003"),
    (str_store_string,s11,"@{!}{s11}^{s12}"),
(try_end),
],
[
]),
("collect_taxes", 512, 
  "As the party member with the highest trade skill ({reg2}), {reg3?you expect:{s1} expects} that collecting taxes from here will take {reg4} days...", 
  "none", [
(call_script, "script_get_max_skill_of_player_party", "skl_trade"),
(assign,":var001",reg0),
(assign,reg2,reg0),
(assign,":var002",reg1),
(try_begin),
    (eq,":var002","trp_player"),
    (assign,reg3,1),
(else_try),
    (assign,reg3,0),
    (str_store_troop_name,s1,":var002"),
(try_end),
(assign,":var003",3000),
(try_begin),
    (party_slot_eq,"$current_town",0,3),
    (assign,":var003",6000),
(try_end),
(try_begin),
    (quest_slot_eq,"qst_collect_taxes",11,0),
    (store_add, ":var004", ":var001", 30),
    (try_begin),
        (party_slot_eq,"$current_town",0,3),
        (store_div, ":var___x1", 5040, ":var004"),
        (assign,"$qst_collect_taxes_total_hours",":var___x1"),
    (else_try),
        (store_div, ":var___x1", 2160, ":var004"),
        (assign,"$qst_collect_taxes_total_hours",":var___x1"),
    (try_end),
    (call_script, "script_party_count_fit_for_battle", "p_main_party"),
    (val_add, reg0, 20),
    (val_mul, ":::qst_collect_taxes_total_hours", 20),
    (val_div, ":::qst_collect_taxes_total_hours", reg0),
    (quest_set_slot,"qst_collect_taxes",10,"$qst_collect_taxes_total_hours"),
    (store_div, ":var___x1", "$qst_collect_taxes_total_hours", 20),
    (assign,":var005",":var___x1"),
    (store_div, ":var___x1", "$qst_collect_taxes_total_hours", 4),
    (assign,":var006",":var___x1"),
    (assign,":var007",":var006"),
    (store_mul, ":var008", "$qst_collect_taxes_total_hours", 3),
    (val_div, ":var008", 4),
    (val_mul, ":var003", 2),
    (store_div, ":var___x1", ":var003", "$qst_collect_taxes_total_hours"),
    (assign,"$qst_collect_taxes_hourly_income",":var___x1"),
    (store_random_in_range,"$qst_collect_taxes_counter",":var005",":var006"),
    (store_random_in_range,"$qst_collect_taxes_unrest_counter",":var007",":var008"),
    (assign,"$qst_collect_taxes_halve_taxes",0),
(try_end),
(quest_get_slot,":quest_slot_009","qst_collect_taxes",10),
(store_div, ":var___x1", ":quest_slot_009", 24),
(assign,":var010",":var___x1"),
(val_mul, ":var010", 24),
(try_begin),
    (lt,":var010",":quest_slot_009"),
    (val_add, ":var010", 24),
(try_end),
(val_div, ":var010", 24),
(assign,reg4,":var010"),
],
[
]),
("collect_taxes_complete", 512, 
  "You've collected {reg3} denars in taxes from {s3}. {s19} will be expecting you to take the money to him.", 
  "none", [
(str_store_party_name,s3,"$current_town"),
(quest_get_slot,":quest_slot_001","qst_collect_taxes",6),
(str_store_troop_name,s19,":quest_slot_001"),
(quest_get_slot,reg3,"qst_collect_taxes",22),
(try_begin),
    (eq,":::qst_collect_taxes_halve_taxes",0),
    (call_script, "script_change_player_relation_with_center", "$current_town", -2),
(try_end),
(call_script, "script_succeed_quest", "qst_collect_taxes"),
],
[
]),
("collect_taxes_rebels_killed", 0, 
  "Your quick action and strong arm have successfully put down the revolt. Surely, anyone with a mind to rebel against you will think better of it after this.", 
  "none", [
],
[
]),
("collect_taxes_failed", 512, 
  "You could collect only {reg3} denars as tax from {s3} before the revolt broke out. {s1} won't be happy, but some silver will placate him better than nothing at all...", 
  "none", [
(str_store_party_name,s3,"$current_town"),
(quest_get_slot,":quest_slot_001","qst_collect_taxes",6),
(str_store_troop_name,s1,":quest_slot_001"),
(quest_get_slot,reg3,"qst_collect_taxes",22),
(call_script, "script_fail_quest", "qst_collect_taxes"),
(quest_set_slot,"qst_collect_taxes",11,4),
(rest_for_hours,0,0,0),
],
[
]),
("collect_taxes_revolt_warning", 0, 
  "The people of {s3} are outraged at your demands and decry it as nothing more than extortion. They're getting very restless, and they may react badly if you keep pressing them.", 
  "none", [
(str_store_party_name,s3,"$current_town"),
],
[
]),
("collect_taxes_revolt", 0, 
  "You are interrupted while collecting the taxes at {s3}. A large band of angry {reg9?peasants:townsmen} is marching nearer, shouting about the exorbitant taxes and waving torches and weapons. It looks like they aim to fight you!", 
  "none", [
(str_store_party_name,s3,"$current_town"),
(assign,reg9,0),
(try_begin),
    (party_slot_eq,"$current_town",0,4),
    (assign,reg9,1),
(try_end),
],
[
]),
("train_peasants_against_bandits", 0, 
  "As the party member with the highest training skill ({reg2}), {reg3?you expect:{s1} expects} that getting some peasants ready for practice will take {reg4} hours.", 
  "none", [
(call_script, "script_get_max_skill_of_player_party", "skl_trainer"),
(assign,":var001",reg0),
(assign,reg2,reg0),
(assign,":var002",reg1),
(try_begin),
    (eq,":var002","trp_player"),
    (assign,reg3,1),
(else_try),
    (assign,reg3,0),
    (str_store_troop_name,s1,":var002"),
(try_end),
(store_sub, ":var003", 20, ":var001"),
(val_mul, ":var003", 3),
(val_div, ":var003", 5),
(store_sub, reg4, ":var003", "$qst_train_peasants_against_bandits_num_hours_trained"),
],
[
]),
("train_peasants_against_bandits_ready", 0, 
  "You put the peasants through the basics of soldiering, discipline and obedience. You think {reg0} of them {reg1?have:has} fully grasped the training and {reg1?are:is} ready for some practice.", 
  "none", [
(store_character_level,":character_lvl_001","trp_player"),
(val_div, ":character_lvl_001", 10),
(val_add, ":character_lvl_001", 1),
(quest_get_slot,":quest_slot_002","qst_train_peasants_against_bandits",10),
(quest_get_slot,":quest_slot_003","qst_train_peasants_against_bandits",11),
(val_sub, ":quest_slot_002", ":quest_slot_003"),
(assign,":var004",":character_lvl_001"),
(val_min,":var004",":quest_slot_002"),
(val_add, ":var004", 1),
(store_random_in_range,":random_x_005",1,":var004"),
(assign,"$g_train_peasants_against_bandits_num_peasants",":random_x_005"),
(assign,reg0,":random_x_005"),
(store_sub, reg1, ":random_x_005", 1),
(str_store_troop_name_by_count,s0,"trp_trainee_peasant",":random_x_005"),
],
[
]),
("train_peasants_against_bandits_training_result", 512, 
  "{s0}", 
  "none", [
(assign,reg5,"$g_train_peasants_against_bandits_num_peasants"),
(str_store_troop_name_by_count,s0,"trp_trainee_peasant","$g_train_peasants_against_bandits_num_peasants"),
(try_begin),
    (eq,":::g_train_peasants_against_bandits_training_succeeded",0),
    (str_store_string,s0,":"),
(else_try),
    (str_store_string,s0,":"),
    (quest_get_slot,":quest_slot_001","qst_train_peasants_against_bandits",11),
    (val_add, ":quest_slot_001", ":::g_train_peasants_against_bandits_num_peasants"),
    (quest_set_slot,"qst_train_peasants_against_bandits",11,":quest_slot_001"),
(try_end),
],
[
]),
("train_peasants_against_bandits_attack", 0, 
  "As you get ready to continue the training, a sentry from the village runs up to you, shouting alarums. The bandits have been spotted on the horizon, riding hard for {s3}. The elder begs that you organize your newly-trained militia and face them.", 
  "none", [
(str_store_party_name,s3,"$current_town"),
],
[
]),
("train_peasants_against_bandits_attack_result", 4608, 
  "{s9}", 
  "none", [
(try_begin),
    (eq,":::g_battle_result",1),
    (str_store_string,s9,":"),
    (call_script, "script_succeed_quest", "qst_train_peasants_against_bandits"),
    (jump_to_menu,"mnu_train_peasants_against_bandits_success"),
(else_try),
    (call_script, "script_fail_quest", "qst_train_peasants_against_bandits"),
    (str_store_string,s9,":"),
    (set_background_mesh, "mesh_pic_looted_village"),
(try_end),
],
[
]),
("train_peasants_against_bandits_success", 512, 
  "The bandits are broken! Those few who remain run off with their tails between their legs, terrified of the peasants and their new champion. The villagers have little left in the way of wealth after their ordeal, but they offer you all they can find to show their gratitude.", 
  "none", [
(party_clear,"p_temp_party"),
(call_script, "script_end_quest", "qst_train_peasants_against_bandits"),
(call_script, "script_change_player_relation_with_center", "$g_encountered_party", 4),
(party_get_slot,":party_slot_001","$current_town",25),
(try_for_range, ":inventory_slot_no_002", 10, 106),
    (store_random_in_range,":random_x_003",0,100),
    (try_begin),
        (lt,":random_x_003",50),
        (troop_set_inventory_slot,":party_slot_001",":inventory_slot_no_002",-1),
    (try_end),
(try_end),
(call_script, "script_add_log_entry", 4, "trp_player", "$current_town", -1, -1),
],
[
]),
("disembark", 0, 
  "Do you wish to disembark?", 
  "none", [
],
[
]),
("ship_reembark", 0, 
  "Do you wish to embark?", 
  "none", [
],
[
]),
("center_reports", 0, 
  "Town Name: {s1}^Rent Income: {reg1} denars^Tariff Income: {reg2} denars^Food Stock: for {reg3} days", 
  "none", [
(party_get_slot,":party_slot_001","$g_encountered_party",53),
(call_script, "script_center_get_food_consumption", "$g_encountered_party"),
(assign,":var002",reg0),
(try_begin),
    (gt,":var002",0),
    (store_div, ":var___x1", ":party_slot_001", ":var002"),
    (assign,reg3,":var___x1"),
(else_try),
    (assign,reg3,9999),
(try_end),
(str_store_party_name,s1,"$g_encountered_party"),
(party_get_slot,reg1,"$g_encountered_party",47),
(party_get_slot,reg2,"$g_encountered_party",48),
],
[
]),
("price_and_production", 0, 
  "Productions are:^(Note: base/modified by raw materials/modified by materials plus prosperity)^{s1}^^Price factors are:^{s2}", 
  "none", [
(assign,":var001",0),
(assign,":var002",0),
(try_for_range, ":p_003", ":p.town_1", ":p.castle_1"),
    (call_script, "script_center_get_goods_availability", ":p_003"),
    (val_add, ":var001", reg0),
(try_end),
(try_for_range, ":p_003", ":p.village_1", ":p.salt_mine"),
    (call_script, "script_center_get_goods_availability", ":p_003"),
    (val_add, ":var002", reg0),
(try_end),
(val_div, ":var002", 110),
(val_div, ":var001", 22),
(call_script, "script_center_get_goods_availability", "$g_encountered_party"),
(assign,reg1,":var001"),
(assign,reg2,":var002"),
(try_begin),
    (ge,":::cheat_mode",1),
    (str_store_string,s1,"str___hardship_index_reg0_avg_towns_reg1_avg_villages_reg2__"),
    (display_message, "@@{!}DEBUG - {s1}"),
(try_end),
(try_for_range, ":itm_004", ":itm.spice", ":itm.siege_supply"),
    (try_begin),
        (neq,":itm_004","itm_pork"),
        (neq,":itm_004","itm_chicken"),
        (neq,":itm_004","itm_butter"),
        (neq,":itm_004","itm_cattle_meat"),
        (neq,":itm_004","itm_cabbages"),
        (call_script, "script_center_get_production", "$g_encountered_party", ":itm_004"),
        (assign,":var005",reg0),
        (assign,":var006",reg2),
        (assign,":var007",reg1),
        (call_script, "script_center_get_consumption", "$g_encountered_party", ":itm_004"),
        (assign,":var008",reg2),
        (assign,":var009",reg1),
        (assign,":var010",reg0),
        (store_sub, ":slot_no_011", ":itm_004", ":itm.spice"),
        (val_add, ":slot_no_011", 250),
        (party_get_slot,":party_slot_012","$g_encountered_party",":slot_no_011"),
        (assign,":var013",0),
        (assign,":var014",0),
        (assign,":var015",0),
        (assign,":var016",0),
        (try_for_range, ":p_003", ":p.town_1", ":p.salt_mine"),
            (try_begin),
                (neg|is_between,":p_003","p_castle_1","p_village_1"),
                (val_add, ":var013", 1),
                (call_script, "script_center_get_production", ":p_003", ":itm_004"),
                (assign,":var017",reg2),
                (call_script, "script_center_get_consumption", ":p_003", ":itm_004"),
                (store_add, ":var018", reg1, reg2),
                (party_get_slot,":party_slot_019",":p_003",":slot_no_011"),
                (val_add, ":var014", ":party_slot_019"),
                (val_add, ":var015", ":var017"),
                (val_add, ":var016", ":var018"),
            (try_end),
        (try_end),
    (try_end),
    (assign,":var020",":var015"),
    (assign,":var021",":var016"),
    (val_div, ":var014", ":var013"),
    (val_div, ":var015", ":var013"),
    (val_div, ":var016", ":var013"),
    (str_store_item_name,s3,":itm_004"),
    (assign,reg1,":var006"),
    (assign,reg2,":var007"),
    (assign,reg3,":var005"),
    (assign,reg4,":party_slot_012"),
    (assign,reg5,":var015"),
    (assign,reg6,":var014"),
    (assign,reg7,":var008"),
    (assign,reg8,":var009"),
    (assign,reg9,":var010"),
    (assign,reg10,":var016"),
    (item_get_slot,":item_slot_022",":itm_004",14),
    (party_get_slot,":party_slot_023","$g_encountered_party",":item_slot_022"),
    (assign,reg11,":party_slot_023"),
    (assign,reg12,":var020"),
    (assign,reg13,":var021"),
    (item_get_slot,":item_slot_024",":itm_004",15),
    (str_store_string,s4,":item_slot_024"),
    (str_store_string,s1,"str___s3_price__reg4_calradian_average_reg6_capital_reg11_s4_base_reg1modified_by_raw_material_reg2modified_by_prosperity_reg3_calradian_average_production_base_reg5_total_reg12_consumed_reg7used_as_raw_material_reg8modified_total_reg9_calradian_consumption_base_reg10_total_reg13s1_"),
(try_end),
],
[
]),
("town_trade", 0, 
  "You head towards the marketplace.", 
  "none", [
],
[
]),
("town_trade_assessment_begin", 0, 
  "You overhear several discussions about the price of trade goods across the local area.^You listen closely, trying to work out the best deals around.", 
  "none", [
(str_clear, 42),
],
[
]),
("town_trade_assessment", 512, 
  "As the party member with the highest trade skill ({reg2}), {reg3?you try to figure out:{s1} tries to figure out} the best goods to trade in. {s2}", 
  "none", [
(call_script, "script_get_max_skill_of_player_party", "skl_trade"),
(assign,":var001",reg0),
(assign,":var002",reg1),
(assign,":var003",0),
(assign,":var004",-1),
(assign,":var005",-1),
(assign,":var006",0),
(assign,":var007",-1),
(assign,":var008",-1),
(assign,":var009",0),
(assign,":var010",-1),
(assign,":var011",-1),
(assign,":var012",0),
(assign,":var013",-1),
(assign,":var014",-1),
(assign,":var015",0),
(assign,":var016",-1),
(assign,":var017",-1),
(assign,":var018",0),
(assign,":var019","p_village_1"),
(assign,":var019 -","p_town_1"),
(assign,":var020","itm_siege_supply"),
(assign,":var20 -","itm_spice"),
(store_mul, ":var021", ":var019", ":var020"),
(val_mul, ":var021", ":var001"),
(val_div, ":var021", 20),
(assign,":party_id_022","$g_encountered_party"),
(try_for_range, ":var023", 0, ":var021"),
    (store_random_in_range,":random_x_024","itm_spice","itm_siege_supply"),
    (store_random_in_range,":random_x_025","p_town_1","p_castle_1"),
    (party_get_slot,":party_slot_026",":party_id_022",23),
    (assign,":var027",0),
    (try_for_range, ":inventory_slot_no_028", 10, 106),
        (troop_get_inventory_slot,":troop_inv_slot_029",":party_slot_026",":inventory_slot_no_028"),
        (try_begin),
            (eq,":troop_inv_slot_029",":random_x_024"),
            (val_add, ":var027", 1),
        (try_end),
    (try_end),
    (try_begin),
        (ge,":var027",1),
        (assign,":var030",0),
        (try_begin),
            (eq,":random_x_024",":var004"),
            (eq,":random_x_025",":var005"),
            (val_add, ":var030", 1),
        (try_end),
    (try_end),
    (try_begin),
        (eq,":random_x_024",":var007"),
        (eq,":random_x_025",":var008"),
        (val_add, ":var030", 1),
    (try_end),
    (try_begin),
        (eq,":random_x_024",":var010"),
        (eq,":random_x_025",":var011"),
        (val_add, ":var030", 1),
    (try_end),
    (try_begin),
        (eq,":random_x_024",":var013"),
        (eq,":random_x_025",":var014"),
        (val_add, ":var030", 1),
    (try_end),
    (try_begin),
        (eq,":random_x_024",":var016"),
        (eq,":random_x_025",":var017"),
        (val_add, ":var030", 1),
    (try_end),
    (try_begin),
        (le,":var030",1),
        (store_item_value,":item_value_031",":random_x_024"),
        (assign,"$g_encountered_party",":party_id_022"),
        (call_script, "script_game_get_item_buy_price_factor", ":random_x_024"),
        (store_mul, ":var032", ":item_value_031", reg0),
        (val_div, ":var032", 100),
        (val_max,":var032",1),
        (assign,"$g_encountered_party",":random_x_025"),
        (call_script, "script_game_get_item_sell_price_factor", ":random_x_024"),
        (store_mul, ":var033", ":item_value_031", reg0),
        (val_div, ":var033", 100),
        (val_max,":var033",1),
        (store_sub, ":var034", ":var033", ":var032"),
        (try_begin),
            (this_or_next|eq,":var004",":random_x_024"),
            (this_or_next|eq,":var007",":random_x_024"),
            (this_or_next|eq,":var010",":random_x_024"),
            (this_or_next|eq,":var013",":random_x_024"),
            (eq,":var016",":random_x_024"),
            (try_begin),
                (eq,":var004",":random_x_024"),
                (gt,":var034",":var006"),
                (assign,":var004",":random_x_024"),
                (assign,":var005",":random_x_025"),
                (assign,":var006",":var034"),
            (else_try),
                (eq,":var007",":random_x_024"),
                (gt,":var034",":var009"),
                (assign,":var007",":random_x_024"),
                (assign,":var008",":random_x_025"),
                (assign,":var009",":var034"),
            (else_try),
                (eq,":var010",":random_x_024"),
                (gt,":var034",":var012"),
                (assign,":var010",":random_x_024"),
                (assign,":var011",":random_x_025"),
                (assign,":var012",":var034"),
            (else_try),
                (eq,":var013",":random_x_024"),
                (gt,":var034",":var015"),
                (assign,":var013",":random_x_024"),
                (assign,":var014",":random_x_025"),
                (assign,":var015",":var034"),
            (else_try),
                (eq,":var016",":random_x_024"),
                (gt,":var034",":var018"),
                (assign,":var016",":random_x_024"),
                (assign,":var017",":random_x_025"),
                (assign,":var018",":var034"),
            (try_end),
        (try_end),
    (else_try),
        (try_begin),
            (gt,":var034",":var006"),
            (val_add, ":var003", 1),
            (val_min,":var003",5),
            (assign,":var016",":var013"),
            (assign,":var017",":var014"),
            (assign,":var018",":var015"),
            (assign,":var013",":var010"),
            (assign,":var014",":var011"),
            (assign,":var015",":var012"),
            (assign,":var010",":var007"),
            (assign,":var011",":var008"),
            (assign,":var012",":var009"),
            (assign,":var007",":var004"),
            (assign,":var008",":var005"),
            (assign,":var009",":var006"),
            (assign,":var004",":random_x_024"),
            (assign,":var005",":random_x_025"),
            (assign,":var006",":var034"),
        (else_try),
            (gt,":var034",":var009"),
            (val_add, ":var003", 1),
            (val_min,":var003",5),
            (assign,":var016",":var013"),
            (assign,":var017",":var014"),
            (assign,":var018",":var015"),
            (assign,":var013",":var010"),
            (assign,":var014",":var011"),
            (assign,":var015",":var012"),
            (assign,":var010",":var007"),
            (assign,":var011",":var008"),
            (assign,":var012",":var009"),
            (assign,":var007",":random_x_024"),
            (assign,":var008",":random_x_025"),
            (assign,":var009",":var034"),
        (else_try),
            (gt,":var034",":var012"),
            (val_add, ":var003", 1),
            (val_min,":var003",5),
            (assign,":var016",":var013"),
            (assign,":var017",":var014"),
            (assign,":var018",":var015"),
            (assign,":var013",":var010"),
            (assign,":var014",":var011"),
            (assign,":var015",":var012"),
            (assign,":var010",":random_x_024"),
            (assign,":var011",":random_x_025"),
            (assign,":var012",":var034"),
        (else_try),
            (gt,":var034",":var015"),
            (val_add, ":var003", 1),
            (val_min,":var003",5),
            (assign,":var016",":var013"),
            (assign,":var017",":var014"),
            (assign,":var018",":var015"),
            (assign,":var013",":random_x_024"),
            (assign,":var014",":random_x_025"),
            (assign,":var015",":var034"),
        (else_try),
            (gt,":var034",":var018"),
            (val_add, ":var003", 1),
            (val_min,":var003",5),
            (assign,":var016",":var013"),
            (assign,":var017",":var014"),
            (assign,":var018",":var015"),
        (try_end),
    (try_end),
(try_end),
(assign,"$g_encountered_party",":party_id_022"),
(str_clear, 3),
(assign,reg2,":var001"),
(try_begin),
    (eq,":var002","trp_player"),
    (assign,reg3,1),
(else_try),
    (assign,reg3,0),
    (str_store_troop_name,s1,":var002"),
(try_end),
(try_begin),
    (le,":var003",0),
    (str_store_string,s2,":"),
(else_try),
    (try_begin),
        (ge,":var016",0),
        (assign,reg6,":var018"),
        (str_store_item_name,s4,":var016"),
        (str_store_party_name,s5,":var017"),
        (str_store_string,s3,":"),
    (try_end),
    (try_begin),
        (ge,":var013",0),
        (assign,reg6,":var015"),
        (str_store_item_name,s4,":var013"),
        (str_store_party_name,s5,":var014"),
        (str_store_string,s3,":"),
    (try_end),
    (try_begin),
        (ge,":var010",0),
        (assign,reg6,":var012"),
        (str_store_item_name,s4,":var010"),
        (str_store_party_name,s5,":var011"),
        (str_store_string,s3,":"),
    (try_end),
    (try_begin),
        (ge,":var007",0),
        (assign,reg6,":var009"),
        (str_store_item_name,s4,":var007"),
        (str_store_party_name,s5,":var008"),
        (str_store_string,s3,":"),
    (try_end),
    (try_begin),
        (ge,":var004",0),
        (assign,reg6,":var006"),
        (str_store_item_name,s4,":var004"),
        (str_store_party_name,s5,":var005"),
        (str_store_string,s3,":"),
    (try_end),
    (str_store_string,s2,"@{reg3?You find:{s1} finds} out the following:^{s3}"),
(try_end),
],
[
]),
("sneak_into_town_suceeded", 0, 
  "Disguised in the garments of a poor pilgrim, you fool the guards and make your way into the town.", 
  "none", [
],
[
]),
("sneak_into_town_caught", 0, 
  "As you try to sneak in, one of the guards recognizes you and raises the alarm! You must flee back through the gates before all the guards in the town come down on you!", 
  "none", [
(assign,"$auto_menu","mnu_captivity_start_castle_surrender"),
],
[
]),
("sneak_into_town_caught_dispersed_guards", 0, 
  "You drive off the guards and cover your trail before running off, easily losing your pursuers in the maze of streets.", 
  "none", [
],
[
]),
("sneak_into_town_caught_ran_away", 0, 
  "You make your way back through the gates and quickly retreat to the safety of the countryside.{s11}", 
  "none", [
(str_clear, 11),
(assign,":var001",0),
(assign,":var002","trp_heroes_end"),
(try_for_range, ":troop_id_003", ":trp.npc1", ":var002"),
    (try_begin),
        (troop_slot_eq,":troop_id_003",149,4),
        (assign,"$talk_context",8),
        (assign,reg14,":troop_id_003"),
        (call_script, "script_setup_troop_meeting", ":troop_id_003", -1),
        (troop_set_slot,":troop_id_003",149,-1),
        (troop_get_slot,":troop_slot_004",":troop_id_003",8),
        (party_remove_members,":troop_slot_004",":troop_id_003",1),
        (troop_set_slot,":troop_id_003",8,-1),
        (assign,":var002",-1),
    (else_try),
        (troop_slot_eq,":troop_id_003",149,5),
        (str_store_troop_name,s12,":troop_id_003"),
        (try_begin),
            (eq,":var001",0),
            (str_store_string,s11,"str_s11_unfortunately_s12_was_wounded_and_had_to_be_left_behind"),
        (else_try),
            (str_store_string,s11,"str_s11_also_s12_was_wounded_and_had_to_be_left_behind"),
        (try_end),
        (assign,":var001",1),
    (try_end),
    (troop_set_slot,":troop_id_003",149,0),
(try_end),
],
[
]),
("enemy_offer_ransom_for_prisoner", 0, 
  "{s2} offers you a sum of {reg12} denars in silver if you are willing to sell him {s1}.", 
  "none", [
(call_script, "script_calculate_ransom_amount_for_troop", "$g_ransom_offer_troop"),
(assign,reg12,reg0),
(str_store_troop_name,s1,"$g_ransom_offer_troop"),
(store_troop_faction,":troop_faction_001","$g_ransom_offer_troop"),
(str_store_faction_name,s2,":troop_faction_001"),
],
[
]),
("training_ground", 0, 
  "You approach a training field where you can practice your martial skills. What kind of training do you want to do?", 
  "none", [
(assign,"$g_training_ground_melee_training_scene","scn_training_ground_ranged_melee_1"),
(val_add, ":::g_training_ground_melee_training_scene", ":::g_encountered_party"),
(assign,"$g_training_ground_melee_training_scene -","p_training_ground_1"),
(try_begin),
    (ge,":::g_training_ground_training_count",3),
    (assign,"$g_training_ground_training_count",0),
    (rest_for_hours,1,5,1),
    (assign,"$auto_enter_town","$g_encountered_party"),
    (change_screen_return),
(try_end),
],
[
]),
("training_ground_selection_details_melee_1", 0, 
  "How many opponents will you go against?", 
  "none", [
(call_script, "script_write_fit_party_members_to_stack_selection", "p_main_party", 1),
(troop_get_slot,"$temp","trp_stack_selection_amounts",1),
(assign,"$temp_2",1),
],
[
]),
("training_ground_selection_details_melee_2", 0, 
  "Choose your opponent #{reg1}:", 
  "none", [
(assign,reg1,"$temp_2"),
(troop_get_slot,"$temp_3","trp_stack_selection_amounts",0),
],
[
]),
("training_ground_selection_details_mounted", 0, 
  "What kind of weapon do you want to train with?", 
  "none", [
],
[
]),
("training_ground_selection_details_ranged_1", 0, 
  "What kind of ranged weapon do you want to train with?", 
  "none", [
],
[
]),
("training_ground_selection_details_ranged_2", 0, 
  "What range do you want to practice at?", 
  "none", [
],
[
]),
("training_ground_description", 0, 
  "{s0}", 
  "none", [
],
[
]),
("training_ground_training_result", 512, 
  "{s7}{s2}", 
  "none", [
(store_skill_level,":skill_lvl_001","skl_trainer","trp_player"),
(store_add, ":var002", 5, ":skill_lvl_001"),
(call_script, "script_write_fit_party_members_to_stack_selection", "p_main_party", 1),
(str_clear, 2),
(troop_get_slot,":troop_slot_003","trp_stack_selection_amounts",1),
(troop_get_slot,":troop_slot_004","trp_stack_selection_amounts",0),
(try_begin),
    (gt,":::g_training_ground_training_success_ratio",0),
    (store_mul, ":var005", "$g_training_ground_training_success_ratio", "$g_training_ground_training_success_ratio"),
    (try_begin),
        (eq,":::g_training_ground_training_success_ratio",100),
        (val_mul, ":var005", 2),
    (try_end),
    (try_begin),
        (eq,":::g_mt_mode",1),
        (val_div, ":var005", 2),
    (try_end),
    (val_div, ":var005", 10),
    (try_begin),
        (gt,":troop_slot_003",8),
        (val_mul, ":var005", 3),
        (assign,":var006",":troop_slot_003"),
        (convert_to_fixed_point, ":var006"),
        (store_sqrt, ":var006", ":var006"),
        (convert_to_fixed_point, ":var005"),
        (val_div, ":var005", ":var006"),
    (try_end),
    (store_mul, ":var007", ":var005", ":var002"),
    (val_div, ":var007", 10),
    (party_get_num_companion_stacks,":party_num_companions_stacks_008","p_main_party"),
    (store_add, ":var009", ":troop_slot_004", 2),
    (try_for_range, ":slot_no_010", 2, ":var009"),
        (troop_get_slot,":troop_slot_011","trp_stack_selection_amounts",":slot_no_010"),
        (troop_get_slot,":troop_slot_012","trp_stack_selection_ids",":slot_no_010"),
        (assign,":var013",":party_num_companions_stacks_008"),
        (try_for_range, ":stack_no_014", 0, ":var013"),
            (party_stack_get_troop_id,      ":troop_id_015","p_main_party",":stack_no_014"),
            (try_begin),
                (eq,":troop_id_015",":troop_slot_012"),
                (assign,":var013",0),
                (try_begin),
                    (call_script, "script_cf_training_ground_sub_routine_for_training_result", ":troop_slot_012", ":stack_no_014", ":troop_slot_011", ":var007"),
                    (str_store_troop_name_by_count,s1,":troop_slot_012",":troop_slot_011"),
                    (assign,reg1,":troop_slot_011"),
                    (str_store_string,s2,":"),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (eq,":::g_mt_mode",1),
        (store_mul, ":var016", ":var005", 3),
        (val_div, ":var016", 2),
        (try_for_range, ":slot_no_017", 0, ":::g_training_ground_training_num_enemies"),
            (troop_get_slot,":troop_slot_012","trp_temp_array_a",":slot_no_017"),
            (assign,":var013",":party_num_companions_stacks_008"),
            (try_for_range, ":stack_no_014", 0, ":var013"),
                (party_stack_get_troop_id,      ":troop_id_015","p_main_party",":stack_no_014"),
                (try_begin),
                    (eq,":troop_id_015",":troop_slot_012"),
                    (assign,":var013",0),
                    (try_begin),
                        (call_script, "script_cf_training_ground_sub_routine_for_training_result", ":troop_slot_012", ":stack_no_014", 1, ":var016"),
                        (str_store_troop_name,s1,":troop_slot_012"),
                        (str_store_string,s2,":"),
                    (try_end),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (try_begin),
        (call_script, "script_cf_training_ground_sub_routine_for_training_result", "trp_player", -1, 1, ":var005"),
        (str_store_string,s2,":"),
    (try_end),
(try_end),
(try_begin),
    (eq,":::g_training_ground_training_success_ratio",0),
    (str_store_string,s7,":"),
(else_try),
    (lt,":::g_training_ground_training_success_ratio",25),
    (str_store_string,s7,":"),
(else_try),
    (lt,":::g_training_ground_training_success_ratio",50),
    (str_store_string,s7,":"),
(else_try),
    (lt,":::g_training_ground_training_success_ratio",75),
    (str_store_string,s7,":"),
(else_try),
    (lt,":::g_training_ground_training_success_ratio",99),
    (str_store_string,s7,":"),
(else_try),
    (str_store_string,s7,":"),
(try_end),
],
[
]),
("marshall_selection_candidate_ask", 0, 
  "{s15} will soon select a new marshall for {s23}. Some of the lords have suggested your name as a likely candidate.", 
  "none", [
(try_begin),
    (eq,":::g_presentation_marshall_selection_ended",1),
    (change_screen_return),
(try_end),
(faction_get_slot,":faction_slot_001","$players_kingdom",11),
(str_store_troop_name,s15,":faction_slot_001"),
(str_store_faction_name,s23,"$players_kingdom"),
],
[
]),
("captivity_avoid_wilderness", 0, 
  "Suddenly all the world goes black around you. Many hours later you regain your conciousness and find yourself at the spot you fell. Your enemies must have taken you up for dead and left you there. However, it seems that none of your wound were lethal, and altough you feel awful, you find out that can still walk. You get up and try to look for any other survivors from your party.", 
  "none", [
],
[
]),
("captivity_start_wilderness", 0, 
  "Stub", 
  "none", [
(assign,"$g_player_is_captive",1),
(try_begin),
    (eq,":::g_player_surrenders",1),
    (jump_to_menu,"mnu_captivity_start_wilderness_surrender"),
(else_try),
    (jump_to_menu,"mnu_captivity_start_wilderness_defeat"),
(try_end),
],
[
]),
("captivity_start_wilderness_surrender", 0, 
  "Stub", 
  "none", [
(assign,"$g_player_is_captive",1),
(assign,"$auto_menu",-1),
(assign,"$capturer_party","$g_encountered_party"),
(jump_to_menu,"mnu_captivity_wilderness_taken_prisoner"),
],
[
]),
("captivity_start_wilderness_defeat", 0, 
  "Your enemies take you prisoner.", 
  "none", [
(assign,"$g_player_is_captive",1),
(assign,"$auto_menu",-1),
(assign,"$capturer_party","$g_encountered_party"),
(try_begin),
    (eq,1,1),
    (party_stack_get_troop_id,      ":troop_id_001","$g_encountered_party",0),
    (try_begin),
        (is_between,":troop_id_001","trp_npc1","trp_knight_1_1_wife"),
        (troop_slot_eq,":troop_id_001",2,2),
        (store_sub, ":var002", ":troop_id_001", ":trp.npc1"),
        (set_achievement_stat, 7, ":var002", 1),
    (try_end),
(try_end),
(jump_to_menu,"mnu_captivity_wilderness_taken_prisoner"),
],
[
]),
("captivity_start_castle_surrender", 0, 
  "Stub", 
  "none", [
(assign,"$g_player_is_captive",1),
(assign,"$auto_menu",-1),
(assign,"$capturer_party","$g_encountered_party"),
(jump_to_menu,"mnu_captivity_castle_taken_prisoner"),
],
[
]),
("captivity_start_castle_defeat", 0, 
  "Stub", 
  "none", [
(assign,"$g_player_is_captive",1),
(assign,"$auto_menu",-1),
(assign,"$capturer_party","$g_encountered_party"),
(jump_to_menu,"mnu_captivity_castle_taken_prisoner"),
],
[
]),
("captivity_start_under_siege_defeat", 0, 
  "Your enemies take you prisoner.", 
  "none", [
(assign,"$g_player_is_captive",1),
(assign,"$auto_menu",-1),
(assign,"$capturer_party","$g_encountered_party"),
(jump_to_menu,"mnu_captivity_castle_taken_prisoner"),
],
[
]),
("captivity_wilderness_taken_prisoner", 4096, 
  "Your enemies take you prisoner.", 
  "none", [
(set_background_mesh, "mesh_pic_prisoner_wilderness"),
],
[
]),
("captivity_wilderness_check", 0, 
  "stub", 
  "none", [
(jump_to_menu,"mnu_captivity_end_wilderness_escape"),
],
[
]),
("captivity_end_wilderness_escape", 4096, 
  "After painful days of being dragged about as a prisoner, you find a chance and escape from your captors!", 
  "none", [
(play_cue_track,":"),
(troop_get_type,":troop_type_001","trp_player"),
(try_begin),
    (eq,":troop_type_001",1),
    (set_background_mesh, "mesh_pic_escape_1_fem"),
(else_try),
    (set_background_mesh, "mesh_pic_escape_1"),
(try_end),
],
[
]),
("captivity_castle_taken_prisoner", 0, 
  "You are quickly surrounded by guards who take away your weapons. With curses and insults, they throw you into the dungeon where you must while away the miserable days of your captivity.", 
  "none", [
(troop_get_type,":troop_type_001","trp_player"),
(try_begin),
    (eq,":troop_type_001",1),
    (set_background_mesh, "mesh_pic_prisoner_fem"),
(else_try),
    (set_background_mesh, "mesh_pic_prisoner_man"),
(try_end),
],
[
]),
("captivity_rescue_lord_taken_prisoner", 0, 
  "You remain in disguise for as long as possible before revealing yourself. The guards are outraged and beat you savagely before throwing you back into the cell for God knows how long...", 
  "none", [
(troop_get_type,":troop_type_001","trp_player"),
(try_begin),
    (eq,":troop_type_001",1),
    (set_background_mesh, "mesh_pic_prisoner_fem"),
(else_try),
    (set_background_mesh, "mesh_pic_prisoner_man"),
(try_end),
],
[
]),
("captivity_castle_check", 0, 
  "stub", 
  "none", [
(store_random_in_range,reg7,0,10),
(try_begin),
    (party_is_active,"$capturer_party"),
    (store_faction_of_party, ":party_faction_001", "$capturer_party"),
    (try_begin),
        (is_between,":party_faction_001","fac_player_supporters_faction","fac_kingdoms_end"),
        (store_relation,":faction_relation_002",":party_faction_001","fac_player_faction"),
        (try_begin),
            (ge,":faction_relation_002",0),
            (jump_to_menu,"mnu_captivity_end_exchanged_with_prisoner"),
        (else_try),
            (lt,reg7,4),
            (store_character_level,":character_lvl_003","trp_player"),
            (store_mul, ":_player_ransom_amount", ":character_lvl_003", 50),
            (val_add, ":::player_ransom_amount", 100),
            (store_troop_gold,reg3,"trp_player"),
            (store_div, ":var___x1", reg3, 20),
            (assign,":var004",":var___x1"),
            (val_add, ":::player_ransom_amount", ":var004"),
            (try_begin),
                (gt,reg3,":::player_ransom_amount"),
                (jump_to_menu,"mnu_captivity_end_propose_ransom"),
            (else_try),
                (lt,reg7,7),
                (jump_to_menu,"mnu_captivity_end_exchanged_with_prisoner"),
            (else_try),
                (jump_to_menu,"mnu_captivity_castle_remain"),
            (try_end),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("captivity_end_exchanged_with_prisoner", 0, 
  "After days of imprisonment, you are finally set free when your captors exchange you with another prisoner.", 
  "none", [
(play_cue_track,":"),
],
[
]),
("captivity_end_propose_ransom", 0, 
  "You spend long hours in the sunless dank of the dungeon, more than you can count. Suddenly one of your captors enters your cell with an offer; he proposes to free you in return for {reg5} denars of your hidden wealth. You decide to...", 
  "none", [
(assign,reg5,"$player_ransom_amount"),
],
[
]),
("captivity_castle_remain", 4608, 
  "More days pass in the darkness of your cell. You get through them as best you can, enduring the kicks and curses of the guards, watching your underfed body waste away more and more...", 
  "none", [
(troop_get_type,":troop_type_001","trp_player"),
(try_begin),
    (eq,":troop_type_001",1),
    (set_background_mesh, "mesh_pic_prisoner_fem"),
(else_try),
    (set_background_mesh, "mesh_pic_prisoner_man"),
(try_end),
(store_random_in_range,":random_x_002",16,22),
(call_script, "script_stay_captive_for_hours", ":random_x_002"),
(assign,"$auto_menu","mnu_captivity_castle_check"),
],
[
]),
("kingdom_army_quest_report_to_army", 4096, 
  "{s8} sends word that he wishes you to join {reg4?her:his} new military campaign. You need to bring at least {reg13} troops to the army, and are instructed to raise more men with all due haste if you do not have enough.", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(quest_get_slot,":quest_slot_001","qst_report_to_army",2),
(quest_get_slot,":quest_slot_002","qst_report_to_army",10),
(call_script, "script_get_information_about_troops_position", ":quest_slot_001", 0),
(str_clear, 9),
(try_begin),
    (eq,reg0,1),
    (str_store_string,s9,1),
(try_end),
(str_store_troop_name,s8,":quest_slot_001"),
(assign,reg13,":quest_slot_002"),
(troop_get_type,reg4,":quest_slot_001"),
],
[
]),
("kingdom_army_quest_messenger", 4096, 
  "{s8} sends word that he wishes to speak with you about a task he needs performed. He requests you to come and see him as soon as possible.", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,":faction_slot_001","$players_kingdom",8),
(str_store_troop_name,s8,":faction_slot_001"),
],
[
]),
("kingdom_army_quest_join_siege_order", 4096, 
  "{s8} sends word that you are to join the siege of {s9} in preparation for a full assault. Your troops are to take {s9} at all costs.", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,":faction_slot_001","$players_kingdom",8),
(quest_get_slot,":quest_slot_002","qst_join_siege_with_army",1),
(str_store_troop_name,s8,":faction_slot_001"),
(str_store_party_name,s9,":quest_slot_002"),
],
[
]),
("kingdom_army_follow_failed", 4096, 
  "You have failed to follow {s8}. The marshal assumes that you were otherwise engaged, but would have appreciated your support.", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,":faction_slot_001","$players_kingdom",8),
(str_store_troop_name,s8,":faction_slot_001"),
(call_script, "script_abort_quest", "qst_follow_army", 1),
],
[
]),
("invite_player_to_faction_without_center", 4096, 
  "You receive an offer of vassalage!^^ {s8} of {s9} has sent a royal herald to bring you an invititation in his own hand. You would be granted the honour of becoming a vassal {lord/lady} of {s9}, and in return {s8} asks you to swear an oath of homage to him and fight in his military campaigns, although he offers you no lands or titles. He will surely be offended if you do not take the offer...", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,"$g_invite_faction_lord","$g_invite_faction",11),
(str_store_troop_name,s8,"$g_invite_faction_lord"),
(str_store_faction_name,s9,"$g_invite_faction"),
],
[
]),
("invite_player_to_faction", 4096, 
  "You receive an offer of vassalage!^^ {s8} of {s9} has sent a royal herald to bring you an invititation in his own hand. You would be granted the honour of becoming a vassal {lord/lady} of {s9}, and in return {s8} asks you to swear an oath of homage to him and fight in his military campaigns, offering you the fief of {s2} for your loyal service. He will surely be offended if you do not take the offer...", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(faction_get_slot,"$g_invite_faction_lord","$g_invite_faction",11),
(str_store_troop_name,s8,"$g_invite_faction_lord"),
(str_store_faction_name,s9,"$g_invite_faction"),
(str_store_party_name,s2,"$g_invite_offered_center"),
],
[
]),
("invite_player_to_faction_accepted", 0, 
  "In order to become a vassal, you must swear an oath of homage to {s3}. You shall have to find him and give him your oath in person. {s5}", 
  "none", [
(call_script, "script_get_information_about_troops_position", "$g_invite_faction_lord", 0),
(str_store_troop_name,s3,"$g_invite_faction_lord"),
(str_store_string,s5,"@{!}{s1}"),
],
[
]),
("question_peace_offer", 0, 
  "You Receive a Peace Offer^^The {s1} offers you a peace agreement. What is your answer?", 
  "none", [
(str_store_faction_name,s1,"$g_notification_var1"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_truce_expired", 0, 
  "Truce Has Expired^^The truce between {s1} and {s2} has expired.", 
  "none", [
(str_store_faction_name,s1,"$g_notification_var1"),
(str_store_faction_name,s2,"$g_notification_var2"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_feast_quest_expired", 0, 
  "{s10}", 
  "none", [
(str_store_string,s10,"str_feast_quest_expired"),
],
[
]),
("notification_sortie_possible", 0, 
  "Enemy Sighted: Enemies have been sighted outside the walls of {s4}, and {s5} and others are preparing for a sortie. You may join them if you wish.", 
  "none", [
(str_store_party_name,s4,"$g_notification_var1"),
(party_stack_get_troop_id,      ":troop_id_001","$g_notification_var2",0),
(str_store_troop_name,s5,":troop_id_001"),
],
[
]),
("notification_casus_belli_expired", 0, 
  "Kingdom Fails to Respond^^The {s1} has not responded to the {s2}'s provocations, and {s3} suffers a loss of face among {reg4?her:his} more bellicose subjects...^", 
  "none", [
(str_store_faction_name,s1,"$g_notification_var1"),
(str_store_faction_name,s2,"$g_notification_var2"),
(faction_get_slot,":faction_slot_001","$g_notification_var1",11),
(str_store_troop_name,s3,":faction_slot_001"),
(troop_get_type,reg4,":faction_slot_001"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_lord_defects", 0, 
  "Defection: {s4} has abandoned the {s5} and joined the {s7}, taking {reg4?her:his} his fiefs with him", 
  "none", [
(assign,":troop_id_001","$g_notification_var1"),
(assign,":var002","$g_notification_var2"),
(str_store_troop_name,s4,":troop_id_001"),
(str_store_faction_name,s5,":var002"),
(store_troop_faction,":troop_faction_003",":troop_id_001"),
(str_store_faction_name,s7,":troop_faction_003"),
(troop_get_type,reg4,":troop_id_001"),
],
[
]),
("notification_treason_indictment", 0, 
  "Treason Indictment^^{s9}", 
  "none", [
(assign,":troop_id_001","$g_notification_var1"),
(assign,":faction_id_002","$g_notification_var2"),
(faction_get_slot,":faction_slot_003",":faction_id_002",11),
(try_begin),
    (eq,":troop_id_001","trp_player"),
    (str_store_troop_name,s7,":faction_slot_003"),
    (str_store_string,s9,"str_you_have_been_indicted_for_treason_to_s7_your_properties_have_been_confiscated_and_you_would_be_well_advised_to_flee_for_your_life"),
(else_try),
    (str_store_troop_name,s4,":troop_id_001"),
    (str_store_faction_name,s5,":faction_id_002"),
    (str_store_troop_name,s6,":faction_slot_003"),
    (troop_get_type,reg4,":troop_id_001"),
    (store_troop_faction,":troop_faction_004",":troop_id_001"),
    (try_begin),
        (is_between,":troop_faction_004","fac_player_supporters_faction","fac_kingdoms_end"),
        (str_store_faction_name,s10,":troop_faction_004"),
        (str_store_string,s11,"str_with_the_s10"),
    (else_try),
        (str_store_string,s11,"str_outside_calradia"),
    (try_end),
    (str_store_string,s9,"str_by_order_of_s6_s4_of_the_s5_has_been_indicted_for_treason_the_lord_has_been_stripped_of_all_reg4herhis_properties_and_has_fled_for_reg4herhis_life_he_is_rumored_to_have_gone_into_exile_s11"),
(try_end),
],
[
]),
("notification_border_incident", 0, 
  "Border incident^^Word reaches you that {s9}. Though you don't know whether or not the rumors are true, you do know one thing -- this seemingly minor incident has raised passions among the {s4}, making it easier for them to go to war against the {s3}, if they want it...", 
  "none", [
(assign,":party_id_001","$g_notification_var1"),
(assign,":var002","$g_notification_var2"),
(store_faction_of_party, ":party_faction_003", ":party_id_001"),
(try_begin),
    (eq,":var002",-1),
    (party_get_slot,":party_slot_004",":party_id_001",61),
    (try_begin),
        (this_or_next|eq,":party_slot_004",":party_faction_003"),
        (neg|faction_slot_eq,":party_slot_004",21,0),
        (party_get_slot,":party_slot_004",":party_id_001",62),
    (try_end),
    (str_store_party_name,s1,":party_id_001"),
    (str_store_faction_name,s3,":party_faction_003"),
    (str_store_faction_name,s4,":party_slot_004"),
    (faction_get_slot,":faction_slot_005",":party_slot_004",11),
    (str_store_troop_name,s5,":faction_slot_005"),
    (str_store_string,s9,"str_local_notables_from_s1_a_village_claimed_by_the_s4_have_been_mistreated_by_their_overlords_from_the_s3_and_petition_s5_for_protection"),
    (display_log_message,"@There has been an alleged border incident: {s9}"),
    (call_script, "script_add_log_entry", 75, ":party_id_001", -1, -1, ":party_faction_003"),
(else_try),
    (store_faction_of_party, ":party_slot_004", ":var002"),
    (str_store_party_name,s1,":party_id_001"),
    (str_store_party_name,s2,":var002"),
    (store_random_in_range,":random_x_006",0,3),
    (try_begin),
        (eq,":random_x_006",0),
        (str_store_string,s9,"str_villagers_from_s1_stole_some_cattle_from_s2"),
        (display_log_message,"@There has been an alleged border incident: {s9}"),
        (call_script, "script_add_log_entry", 72, ":party_id_001", ":var002", -1, ":party_faction_003"),
    (else_try),
        (eq,":random_x_006",1),
        (str_store_string,s9,"str_villagers_from_s1_abducted_a_woman_from_a_prominent_family_in_s2_to_marry_one_of_their_boys"),
        (display_log_message,"@There has been an alleged border incident: {s9}"),
        (call_script, "script_add_log_entry", 73, ":party_id_001", ":var002", -1, ":party_faction_003"),
    (else_try),
        (eq,":random_x_006",2),
        (str_store_string,s9,"str_villagers_from_s1_killed_some_farmers_from_s2_in_a_fight_over_the_diversion_of_a_stream"),
        (display_log_message,"@There has been an alleged border incident: {s9}"),
        (call_script, "script_add_log_entry", 74, ":party_id_001", ":var002", -1, ":party_faction_003"),
    (try_end),
(try_end),
(str_store_faction_name,s3,":party_faction_003"),
(str_store_faction_name,s4,":party_slot_004"),
(store_add, ":slot_no_007", ":party_faction_003", 130),
(assign,":slot_no_007 -","fac_player_supporters_faction"),
(faction_set_slot,":party_slot_004",":slot_no_007",30),
],
[
]),
("notification_player_faction_active", 0, 
  "You now possess land in your name, without being tied to any kingdom. This makes you a monarch in your own right, with your court temporarily located at {s12}. However, the other kings in Calradia will at first consider you a threat, for if any upstart warlord can grab a throne, then their own legitimacy is called into question.^^You may find it desirable at this time to pledge yourself to an existing kingdom. If you want to continue as a sovereign monarch, then your first priority should be to establish an independent right to rule. You can establish your right to rule through several means -- marrying into a high-born family, recruiting new lords, governing your lands, treating with other kings, or dispatching your companions on missions.^^At any rate, your first step should be to appoint a chief minister from among your companions, to handle affairs of state. Different companions have different capabilities.^You may appoint new ministers from time to time. You may also change the location of your court, by speaking to the minister.", 
  "none", [
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
(unlock_achievement, 52),
(play_track,":"),
(try_for_range, ":p_001", ":p.town_1", ":p.village_1"),
    (try_begin),
        (lt,":::g_player_court","p_town_1"),
        (store_faction_of_party, ":party_faction_002", ":p_001"),
        (try_begin),
            (eq,":party_faction_002","fac_player_supporters_faction"),
            (assign,"$g_player_court",":p_001"),
            (try_begin),
                (eq,1,1),
                (troop_get_slot,":troop_slot_003","trp_player",30),
                (try_begin),
                    (is_between,":troop_slot_003","trp_knight_1_1_wife","trp_heroes_end"),
                    (troop_set_slot,":troop_slot_003",12,"$g_player_court"),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (str_store_party_name,s12,"$g_player_court"),
(try_end),
],
[
]),
("minister_confirm", 0, 
  "{s9}can be found at your court in {s12}. You should consult periodically, to avoid the accumulation of unresolved issues that may sap your authority...", 
  "none", [
(try_begin),
    (eq,":::players_kingdom_name_set",1),
    (change_screen_return),
(try_end),
(try_begin),
    (eq,":::g_player_minister","trp_temporary_minister"),
    (str_store_string,s9,"str_your_new_minister_"),
(else_try),
    (str_store_troop_name,s10,"$g_player_minister"),
    (str_store_string,s9,"str_s10_is_your_new_minister_and_"),
(try_end),
(try_begin),
    (main_party_has_troop,"$g_player_minister"),
    (remove_member_from_party,"$g_player_minister","p_main_party"),
(try_end),
],
[
]),
("notification_court_lost", 0, 
  "{s12}", 
  "none", [
(try_begin),
    (is_between,"$g_player_court","p_town_1","p_salt_mine"),
    (str_store_party_name,s10,"$g_player_court"),
    (str_store_party_name,s11,"$g_player_court"),
(else_try),
    (str_store_string,s10,"str_your_previous_court_some_time_ago"),
    (str_store_string,s11,"str_your_previous_court_some_time_ago"),
(try_end),
(assign,"$g_player_court",-1),
(str_store_string,s14,"str_after_to_the_fall_of_s11_your_court_has_nowhere_to_go"),
(try_begin),
    (faction_slot_eq,"fac_player_supporters_faction",21,2),
    (str_store_string,s14,"str_as_you_no_longer_maintain_an_independent_kingdom_you_no_longer_maintain_a_court"),
(try_end),
(try_for_range, ":p_001", ":p.town_1", ":p.village_1"),
    (try_begin),
        (eq,":::g_player_court",-1),
        (store_faction_of_party, ":party_faction_002", ":p_001"),
        (try_begin),
            (eq,":party_faction_002","fac_player_supporters_faction"),
            (neg|party_slot_ge,":p_001",7,"trp_npc1"),
            (assign,"$g_player_court",":p_001"),
            (try_begin),
                (eq,1,1),
                (troop_get_slot,":troop_slot_003","trp_player",30),
                (try_begin),
                    (is_between,":troop_slot_003","trp_knight_1_1_wife","trp_heroes_end"),
                    (troop_set_slot,":troop_slot_003",12,"$g_player_court"),
                    (str_store_party_name,s11,"$g_player_court"),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (str_store_string,s14,"str_due_to_the_fall_of_s10_your_court_has_been_relocated_to_s12"),
(try_end),
(try_for_range, ":p_001", ":p.town_1", ":p.village_1"),
    (try_begin),
        (eq,":::g_player_court",-1),
        (store_faction_of_party, ":party_faction_002", ":p_001"),
        (try_begin),
            (eq,":party_faction_002","fac_player_supporters_faction"),
            (assign,"$g_player_court",":p_001"),
            (try_begin),
                (eq,1,1),
                (troop_get_slot,":troop_slot_003","trp_player",30),
                (try_begin),
                    (is_between,":troop_slot_003","trp_knight_1_1_wife","trp_heroes_end"),
                    (troop_set_slot,":troop_slot_003",12,"$g_player_court"),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
    (party_get_slot,":party_slot_004",":p_001",7),
    (str_store_party_name,s11,"$g_player_court"),
    (str_store_troop_name,s9,":party_slot_004"),
    (str_store_string,s14,"str_after_to_the_fall_of_s10_your_faithful_vassal_s9_has_invited_your_court_to_s11_"),
(try_end),
(try_begin),
    (faction_slot_eq,"fac_player_supporters_faction",21,2),
    (str_store_string,s14,"str_as_you_no_longer_maintain_an_independent_kingdom_you_no_longer_maintain_a_court"),
(try_end),
(str_store_string,s12,14),
],
[
]),
("notification_player_faction_deactive", 0, 
  "Your kingdom no longer holds any land.", 
  "none", [
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_player_wedding_day", 4096, 
  "{s8} wishes to inform you that preparations for your wedding at {s10} have been complete, and that your presence is expected imminently .", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(str_store_troop_name,s8,"$g_notification_var1"),
(str_store_party_name,s10,"$g_notification_var2"),
],
[
]),
("notification_player_kingdom_holds_feast", 4096, 
  "{s11}", 
  "none", [
(set_background_mesh, "mesh_pic_messenger"),
(str_store_troop_name,s8,"$g_notification_var1"),
(store_troop_faction,":troop_faction_001","$g_notification_var1"),
(str_store_faction_name,s9,":troop_faction_001"),
(str_store_party_name,s10,"$g_notification_var2"),
(str_clear, 12),
(try_begin),
    (check_quest_active,"qst_wed_betrothed"),
    (quest_get_slot,":quest_slot_002","qst_wed_betrothed",6),
    (store_troop_faction,":troop_faction_003",":quest_slot_002"),
    (try_begin),
        (eq,":troop_faction_003",":::players_kingdom"),
        (str_store_string,s12,"str_feast_wedding_opportunity"),
    (try_end),
(try_end),
(str_store_string,s11,"str_s8_wishes_to_inform_you_that_the_lords_of_s9_will_be_gathering_for_a_feast_at_his_great_hall_in_s10_and_invites_you_to_be_part_of_this_august_assembly"),
(try_begin),
    (neg|eq,":::g_notification_var1",0),
    (str_store_string,s11,"str_the_great_lords_of_your_kingdom_plan_to_gather_at_your_hall_in_s10_for_a_feast"),
(try_end),
(str_store_string,s11,"@{!}{s11}{s12}"),
(try_begin),
    (ge,":::cheat_mode",1),
    (store_current_hours,":cur_hours_004"),
    (faction_get_slot,":faction_slot_005","$players_kingdom",94),
    (val_sub, ":cur_hours_004", ":faction_slot_005"),
    (assign,reg4,":cur_hours_004"),
    (display_message, "@@{!}DEBUG -- Hours since last feast started: {reg4}"),
(try_end),
],
[
]),
("notification_center_under_siege", 0, 
  "{s1} has been besieged by {s2} of {s3}!", 
  "none", [
(str_store_party_name,s1,"$g_notification_var1"),
(str_store_troop_name,s2,"$g_notification_var2"),
(store_troop_faction,":troop_faction_001","$g_notification_var2"),
(str_store_faction_name,s3,":troop_faction_001"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,62),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_village_raided", 0, 
  "Enemies have Laid Waste to a Fief^^{s1} has been raided by {s2} of {s3}!", 
  "none", [
(str_store_party_name,s1,"$g_notification_var1"),
(str_store_troop_name,s2,"$g_notification_var2"),
(store_troop_faction,":troop_faction_001","$g_notification_var2"),
(str_store_faction_name,s3,":troop_faction_001"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,62),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_village_raid_started", 0, 
  "Your Village is under Attack!^^{s2} of {s3} is laying waste to {s1}.", 
  "none", [
(str_store_party_name,s1,"$g_notification_var1"),
(str_store_troop_name,s2,"$g_notification_var2"),
(store_troop_faction,":troop_faction_001","$g_notification_var2"),
(str_store_faction_name,s3,":troop_faction_001"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,62),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_one_faction_left", 0, 
  "Calradia Conquered by One Kingdom^^{s1} has defeated all rivals and stands as the sole kingdom.", 
  "none", [
(str_store_faction_name,s1,"$g_notification_var1"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
(try_begin),
    (neg|faction_slot_eq,"$g_notification_var1",11,"trp_player"),
    (unlock_achievement, 44),
(else_try),
    (unlock_achievement, 53),
(try_end),
(try_begin),
    (eq,1,1),
    (troop_get_type,":troop_type_001","trp_player"),
    (try_begin),
        (eq,":troop_type_001",1),
        (unlock_achievement, 78),
    (try_end),
(try_end),
],
[
]),
("notification_oath_renounced_faction_defeated", 0, 
  "Your Old Faction was Defeated^^You won the battle against {s1}! This ends your struggle which started after you renounced your oath to them.", 
  "none", [
(str_store_faction_name,s1,"$g_notification_var1"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_center_lost", 0, 
  "An Estate was Lost^^You have lost {s1} to {s2}.", 
  "none", [
(str_store_party_name,s1,"$g_notification_var1"),
(str_store_faction_name,s2,"$g_notification_var2"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,62),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_troop_left_players_faction", 0, 
  "Betrayal!^^{s1} has left {s2} and joined {s3}.", 
  "none", [
(str_store_troop_name,s1,"$g_notification_var1"),
(str_store_faction_name,s2,"$players_kingdom"),
(str_store_faction_name,s3,"$g_notification_var2"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,55),
(position_set_y,0,20),
(position_set_z,0,100),
],
[
]),
("notification_troop_joined_players_faction", 0, 
  "Good news!^^ {s1} has left {s2} and joined {s3}.", 
  "none", [
(str_store_troop_name,s1,"$g_notification_var1"),
(str_store_faction_name,s2,"$g_notification_var2"),
(str_store_faction_name,s3,"$players_kingdom"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,55),
(position_set_y,0,20),
(position_set_z,0,100),
],
[
]),
("notification_war_declared", 0, 
  "Declaration of War^^{s1} has declared war against {s2}!", 
  "none", [
(try_begin),
    (eq,1,1),
    (str_store_faction_name,s1,"$g_notification_var1"),
    (str_store_faction_name,s2,"$g_notification_var2"),
(try_end),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
(store_sub, ":var001", "$g_notification_var1", ":fac.player_supporters_faction"),
(store_sub, ":var002", "$g_notification_var2", ":fac.player_supporters_faction"),
(val_mul, ":var001", 128),
(val_add, ":var001", ":var002"),
],
[
]),
("notification_peace_declared", 0, 
  "Peace Agreement^^{s1} and {s2} have made peace!^{s57}", 
  "none", [
(try_begin),
    (eq,1,0),
    (neg|eq,":::g_include_diplo_explanation",":::g_notification_var1"),
    (assign,"$g_include_diplo_explanation",0),
(else_try),
    (str_clear, 57),
(try_end),
(str_store_faction_name,s1,"$g_notification_var1"),
(str_store_faction_name,s2,"$g_notification_var2"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
(store_sub, ":var001", "$g_notification_var1", ":fac.player_supporters_faction"),
(store_sub, ":var002", "$g_notification_var2", ":fac.player_supporters_faction"),
(val_mul, ":var001", 128),
(val_add, ":var001", ":var002"),
],
[
]),
("notification_faction_defeated", 0, 
  "Faction Eliminated^^{s1} is no more!", 
  "none", [
(str_store_faction_name,s1,"$g_notification_var1"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_rebels_switched_to_faction", 0, 
  "Rebellion Success^^ Your rebellion is victorious! Your faction now has the sole claim to the title of {s11}, with {s12} as the single ruler.", 
  "none", [
(str_store_faction_name,s11,"$g_notification_var1"),
(str_store_troop_name,s12,"$g_notification_var2"),
(set_fixed_point_multiplier, 100),
(position_set_x,0,65),
(position_set_y,0,30),
(position_set_z,0,170),
],
[
]),
("notification_player_should_consult", 0, 
  "Your minister send words that there are problems brewing in the realm which, if left untreated, could sap your authority. You should consult with him at your earliest convenience", 
  "none", [
],
[
]),
("notification_player_feast_in_progress", 0, 
  "Feast in Preparation^^Your wife has started preparations for a feast in your hall in {s11}", 
  "none", [
(str_store_party_name,s11,"$g_notification_var1"),
],
[
]),
("notification_lady_requests_visit", 0, 
  "An elderly woman approaches your party and passes one of your men a letter, sealed in plain wax. It is addressed to you. When you break the seal, you see it is from {s15}. It reads, 'I so enjoyed your last visit. {s14} I am currently in {s10}.{s12}'", 
  "none", [
(assign,":troop_id_001","$g_notification_var1"),
(assign,":var002","$g_notification_var2"),
(str_store_troop_name,s15,":troop_id_001"),
(str_store_party_name,s10,":var002"),
(store_current_hours,":cur_hours_003"),
(troop_get_slot,":troop_slot_004",":troop_id_001",4),
(val_sub, ":cur_hours_003", ":troop_slot_004"),
(call_script, "script_get_kingdom_lady_social_determinants", ":troop_id_001"),
(assign,":var005",reg0),
(str_store_troop_name,s16,":var005"),
(call_script, "script_troop_get_family_relation_to_troop", ":var005", ":troop_id_001"),
(str_clear, 14),
(try_begin),
    (lt,":cur_hours_003",336),
    (try_begin),
        (troop_slot_eq,":troop_id_001",52,23),
        (str_store_string,s14,"str_as_brief_as_our_separation_has_been_the_longing_in_my_heart_to_see_you_has_made_it_seem_as_many_years"),
    (else_try),
        (str_store_string,s14,"str_although_it_has_only_been_a_short_time_since_your_departure_but_i_would_be_most_pleased_to_see_you_again"),
    (try_end),
(else_try),
    (ge,":cur_hours_003",336),
    (try_begin),
        (troop_slot_eq,":troop_id_001",52,24),
        (str_store_string,s14,"str_although_i_have_received_no_word_from_you_for_quite_some_time_i_am_sure_that_you_must_have_been_very_busy_and_that_your_failure_to_come_see_me_in_no_way_indicates_that_your_attentions_to_me_were_insincere_"),
    (else_try),
        (troop_slot_eq,":troop_id_001",52,25),
        (str_store_string,s14,"str_i_trust_that_you_have_comported_yourself_in_a_manner_becoming_a_gentleman_during_our_long_separation_"),
    (else_try),
        (str_store_string,s14,"str_it_has_been_many_days_since_you_came_and_i_would_very_much_like_to_see_you_again"),
    (try_end),
(try_end),
(str_clear, 12),
(str_clear, 18),
(try_begin),
    (troop_slot_eq,":var005",38,0),
    (str_store_string,s12,"str__you_should_ask_my_s11_s16s_permission_but_i_have_no_reason_to_believe_that_he_will_prevent_you_from_coming_to_see_me"),
    (str_store_string,s18,"str__you_should_first_ask_her_s11_s16s_permission"),
(else_try),
    (troop_slot_eq,":var005",38,-1),
    (str_store_string,s12,"str__alas_as_we_know_my_s11_s16_will_not_permit_me_to_see_you_however_i_believe_that_i_can_arrange_away_for_you_to_enter_undetected"),
(else_try),
    (troop_slot_eq,":var005",38,1),
    (str_store_string,s12,"str__as_my_s11_s16_has_already_granted_permission_for_you_to_see_me_i_shall_expect_your_imminent_arrival"),
(try_end),
],
[
]),
("garden", 0, 
  "{s12}", 
  "none", [
(call_script, "script_get_kingdom_lady_social_determinants", "$love_interest_in_town"),
(assign,":troop_id_001",reg0),
(str_store_troop_name,s11,"$love_interest_in_town"),
(try_begin),
    (eq,1,1),
    (call_script, "script_npc_decision_checklist_male_guardian_assess_suitor", ":troop_id_001", "trp_player"),
    (try_begin),
        (lt,reg0,0),
        (troop_set_slot,":troop_id_001",38,-1),
    (try_end),
(try_end),
(assign,"$nurse_assists_entry",0),
(try_begin),
    (troop_slot_eq,":troop_id_001",38,1),
    (str_store_string,s12,"str_the_guards_at_the_gate_have_been_ordered_to_allow_you_through_you_might_be_imagining_things_but_you_think_one_of_them_may_have_given_you_a_wink"),
(else_try),
    (call_script, "script_troop_get_relation_with_troop", "trp_player", "$love_interest_in_town"),
    (try_begin),
        (gt,reg0,0),
        (assign,":var002",0),
        (try_begin),
            (check_quest_active,"qst_visit_lady"),
            (quest_slot_eq,"qst_visit_lady",6,"$love_interest_in_town"),
            (assign,":var002",1),
        (else_try),
            (check_quest_active,"qst_formal_marriage_proposal"),
            (quest_slot_eq,"qst_formal_marriage_proposal",6,"$love_interest_in_town"),
            (this_or_next|check_quest_succeeded,"qst_formal_marriage_proposal"),
            (check_quest_failed,"qst_formal_marriage_proposal"),
            (assign,":var002",1),
        (else_try),
            (check_quest_active,"qst_duel_courtship_rival"),
            (quest_slot_eq,"qst_duel_courtship_rival",6,"$love_interest_in_town"),
            (this_or_next|check_quest_succeeded,"qst_duel_courtship_rival"),
            (check_quest_failed,"qst_duel_courtship_rival"),
            (assign,":var002",1),
        (try_end),
    (try_end),
    (try_begin),
        (eq,1,1),
        (store_current_hours,":cur_hours_003"),
        (troop_get_slot,":troop_slot_004","$love_interest_in_town",4),
        (val_sub, ":cur_hours_003", ":troop_slot_004"),
        (try_begin),
            (this_or_next|ge,":cur_hours_003",96),
            (eq,":var002",1),
            (try_begin),
                (is_between,"$g_encountered_party","p_town_1","p_castle_1"),
                (str_store_string,s12,"str_the_guards_glare_at_you_and_you_know_better_than_to_ask_permission_to_enter_however_as_you_walk_back_towards_your_lodgings_an_elderly_lady_dressed_in_black_approaches_you_i_am_s11s_nurse_she_whispers_urgently_don_this_dress_and_throw_the_hood_over_your_face_i_will_smuggle_you_inside_the_castle_to_meet_her_in_the_guise_of_a_skullery_maid__the_guards_will_not_look_too_carefully_but_i_beg_you_for_all_of_our_sakes_be_discrete"),
                (assign,"$nurse_assists_entry",1),
            (else_try),
                (str_store_string,s12,"str_the_guards_glare_at_you_and_you_know_better_than_to_ask_permission_to_enter_however_as_you_walk_back_towards_your_lodgings_an_elderly_lady_dressed_in_black_approaches_you_i_am_s11s_nurse_she_whispers_urgently_wait_for_a_while_by_the_spring_outside_the_walls_i_will_smuggle_her_ladyship_out_to_meet_you_dressed_in_the_guise_of_a_shepherdess_but_i_beg_you_for_all_of_our_sakes_be_discrete"),
                (assign,"$nurse_assists_entry",2),
            (try_end),
        (try_end),
    (else_try),
        (str_store_string,s12,"str_the_guards_glare_at_you_and_you_know_better_than_to_ask_permission_to_enter_however_as_you_walk_back_towards_your_lodgings_an_elderly_lady_dressed_in_black_approaches_you_i_am_s11s_nurse_she_whispers_urgently_her_ladyship_asks_me_to_say_that_yearns_to_see_you_but_that_you_should_bide_your_time_a_bit_her_ladyship_says_that_to_arrange_a_clandestine_meeting_so_soon_after_your_last_encounter_would_be_too_dangerous"),
    (try_end),
(try_end),
],
[
]),
("kill_local_merchant_begin", 0, 
  "You spot your victim and follow him, observing as he turns a corner into a dark alley. This will surely be your best opportunity to attack him.", 
  "none", [
],
[
]),
("debug_alert_from_s65", 0, 
  "DEBUG ALERT: {s65}", 
  "none", [
],
[
]),
("auto_return_to_map", 0, 
  "stub", 
  "none", [
(change_screen_map),
],
[
]),
("bandit_lair", 0, 
  "{s3}", 
  "none", [
(try_begin),
    (eq,":::loot_screen_shown",1),
    (try_for_range, ":pt_001", ":pt.steppe_bandits", ":pt.deserters"),
        (try_begin),
            (party_template_slot_eq,":pt_001",4,"$g_encountered_party"),
            (party_template_set_slot,":pt_001",4,0),
        (try_end),
    (try_end),
    (try_begin),
        (ge,":::g_encountered_party",0),
        (party_is_active,"$g_encountered_party"),
        (party_get_template_id,":party_template_id_002","$g_encountered_party"),
        (try_begin),
            (neq,":party_template_id_002","pt_looter_lair"),
            (remove_party,"$g_encountered_party"),
        (try_end),
    (try_end),
    (assign,"$g_leave_encounter",0),
    (change_screen_return),
(else_try),
    (party_stack_get_troop_id,      ":troop_id_003","$g_encountered_party",0),
    (str_store_troop_name_plural,s4,":troop_id_003"),
    (str_store_string,s5,"str_bandit_approach_defile"),
    (try_begin),
        (eq,":troop_id_003","trp_desert_bandit"),
        (str_store_string,s5,"str_bandit_approach_defile"),
    (else_try),
        (eq,":troop_id_003","trp_mountain_bandit"),
        (str_store_string,s5,"str_bandit_approach_cliffs"),
    (else_try),
        (eq,":troop_id_003","trp_forest_bandit"),
        (str_store_string,s5,"str_bandit_approach_swamp"),
    (else_try),
        (eq,":troop_id_003","trp_taiga_bandit"),
        (str_store_string,s5,"str_bandit_approach_swamp"),
    (else_try),
        (eq,":troop_id_003","trp_steppe_bandit"),
        (str_store_string,s5,"str_bandit_approach_thickets"),
    (else_try),
        (eq,":troop_id_003","trp_sea_raider"),
        (str_store_string,s5,"str_bandit_approach_cove"),
    (try_end),
    (try_begin),
        (party_slot_eq,"$g_encountered_party",8,0),
        (str_store_string,s3,"str_bandit_hideout_preattack"),
    (else_try),
        (party_get_template_id,":party_template_id_002","$g_encountered_party"),
        (try_begin),
            (eq,":party_template_id_002","pt_looter_lair"),
            (party_slot_eq,"$g_encountered_party",8,1),
            (str_store_string,s3,"str_lost_startup_hideout_attack"),
        (else_try),
            (party_slot_eq,"$g_encountered_party",8,1),
            (str_store_string,s3,"str_bandit_hideout_failure"),
        (else_try),
            (party_slot_eq,"$g_encountered_party",8,2),
            (str_store_string,s3,"str_bandit_hideout_success"),
        (try_end),
    (try_end),
(try_end),
],
[
]),
("notification_player_faction_political_issue_resolved", 0, 
  "After consulting with the peers of the realm, {s10} has decided to confer {s11} on {s12}.", 
  "none", [
(assign,":var001","$g_notification_var1"),
(assign,":var002","$g_notification_var2"),
(faction_get_slot,":faction_slot_003","$players_kingdom",11),
(str_store_troop_name,s10,":faction_slot_003"),
(try_begin),
    (eq,":var001",1),
    (str_store_string,s11,"str_the_marshalship"),
(else_try),
    (str_store_party_name,s11,":var001"),
(try_end),
(str_store_troop_name,s12,":var002"),
],
[
]),
("notification_player_faction_political_issue_resolved_for_player", 0, 
  "After consulting with the peers of the realm, {s10} has decided to confer {s11} on you. You may decline the honor, but it will probably mean that you will not receive other awards for a little while.{s12}", 
  "none", [
(faction_get_slot,":faction_slot_001","$players_kingdom",11),
(str_store_troop_name,s10,":faction_slot_001"),
(faction_get_slot,":faction_slot_002","$players_kingdom",64),
(try_begin),
    (eq,":faction_slot_002",1),
    (str_store_string,s11,"str_the_marshalship"),
    (str_store_string,s12,":"),
(else_try),
    (str_clear, 12),
    (str_store_party_name,s11,":faction_slot_002"),
(try_end),
],
[
]),
("start_phase_2_5", 512, 
  "{!}{s16}", 
  "none", [
(str_store_party_name,s1,"$g_starting_town"),
(str_store_string,s16,"$g_journey_string"),
],
[
]),
("start_phase_3", 512, 
  "{s16}^^You are exhausted by the time you find the inn in {s1}, and fall asleep quickly. However, you awake before dawn and are eager to explore your surroundings. You venture out onto the streets, which are still deserted. All of a sudden, you hear a sound that stands the hairs of your neck on end -- the rasp of a blade sliding from its scabbard...", 
  "none", [
(assign,":var001",1),
(try_begin),
    (eq,":::current_startup_quest_phase",1),
    (try_begin),
        (eq,":::g_killed_first_bandit",1),
        (str_store_string,s11,"str_killed_bandit_at_alley_fight"),
    (else_try),
        (str_store_string,s11,"str_wounded_by_bandit_at_alley_fight"),
    (try_end),
    (jump_to_menu,"mnu_start_phase_4"),
    (assign,":var001",0),
(else_try),
    (eq,":::current_startup_quest_phase",3),
    (try_begin),
        (eq,":::g_killed_first_bandit",1),
        (str_store_string,s11,"str_killed_bandit_at_alley_fight"),
    (else_try),
        (str_store_string,s11,"str_wounded_by_bandit_at_alley_fight"),
    (try_end),
    (jump_to_menu,"mnu_start_phase_4"),
    (assign,":var001",0),
(try_end),
(str_store_party_name,s1,"$g_starting_town"),
(str_clear, 16),
],
[
]),
("start_phase_4", 512, 
  "{s11}", 
  "none", [
(assign,":var001",1),
(try_begin),
    (eq,":::current_startup_quest_phase",2),
    (change_screen_return),
    (assign,":var001",0),
(else_try),
    (eq,":::current_startup_quest_phase",3),
    (str_store_string,s11,"str_merchant_and_you_call_some_townsmen_and_guards_to_get_ready_and_you_get_out_from_tavern"),
(else_try),
    (eq,":::current_startup_quest_phase",4),
    (try_begin),
        (eq,":::g_killed_first_bandit",1),
        (str_store_string,s11,"str_town_fight_ended_you_and_citizens_cleaned_town_from_bandits"),
    (else_try),
        (str_store_string,s11,"str_town_fight_ended_you_and_citizens_cleaned_town_from_bandits_you_wounded"),
    (try_end),
(try_end),
],
[
]),
("lost_tavern_duel", 512, 
  "{s11}", 
  "none", [
(try_begin),
    (eq,1,1),
    (agent_get_troop_id,":troop_id_001", "$g_main_attacker_agent"),
    (try_begin),
        (eq,":troop_id_001","trp_belligerent_drunk"),
        (str_store_string,s11,"str_lost_tavern_duel_ordinary"),
    (else_try),
        (agent_get_troop_id,":troop_id_001", "$g_main_attacker_agent"),
        (try_begin),
            (eq,":troop_id_001","trp_hired_assassin"),
            (str_store_string,s11,"str_lost_tavern_duel_assassin"),
        (try_end),
    (try_end),
(try_end),
(troop_set_slot,"trp_hired_assassin",12,-1),
],
[
]),
("establish_court", 512, 
  "To establish {s4} as your court will require a small refurbishment. In particular, you will need a set of tools and a bolt of velvet. it may also take a short while for some of your followers to relocate here. Do you wish to proceed?", 
  "none", [
(str_store_party_name,s4,"$g_encountered_party"),
],
[
]),
("notification_relieved_as_marshal", 512, 
  "{s4} wishes to inform you that your services as marshal are no longer required. In honor of valiant efforts on behalf of the realm over the last {reg4} days, however, {reg8?she:he} offers you a purse of {reg5} denars.", 
  "none", [
(assign,reg4,"$g_player_days_as_marshal"),
(store_div, ":var___x1", "$g_player_days_as_marshal", 4),
(assign,":var001",":var___x1"),
(val_min,":var001",20),
(store_mul, ":gold_002", "$g_player_days_as_marshal", 50),
(val_max,":gold_002",200),
(val_min,":gold_002",4000),
(call_script, "script_troop_add_gold", "trp_player", ":gold_002"),
(call_script, "script_change_troop_renown", "trp_player", ":var001"),
(assign,"$g_player_days_as_marshal",0),
(assign,"$g_dont_give_marshalship_to_player_days",15),
(assign,reg5,":gold_002"),
(faction_get_slot,":faction_slot_003","$players_kingdom",11),
(str_store_troop_name,s4,":faction_slot_003"),
(troop_get_type,reg8,":faction_slot_003"),
],
[
]),
]
